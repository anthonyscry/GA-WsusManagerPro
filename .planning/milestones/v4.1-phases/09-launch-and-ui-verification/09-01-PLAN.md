---
phase: 09-launch-and-ui-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CSharp/src/WsusManager.App/ViewModels/MainViewModel.cs
  - CSharp/src/WsusManager.App/Views/MainWindow.xaml
  - CSharp/src/WsusManager.Tests/ViewModels/MainViewModelTests.cs
autonomous: true
requirements: [UI-01, UI-02, UI-03, UI-04, UI-05]

must_haves:
  truths:
    - "App startup log shows the WSUS-not-installed message at most once, and only after the first dashboard refresh"
    - "The currently-selected sidebar nav button is visually distinct from the others"
    - "All 245 tests continue to pass with no regressions"
  artifacts:
    - path: "CSharp/src/WsusManager.App/ViewModels/MainViewModel.cs"
      provides: "Fixed InitializeAsync — pre-refresh WSUS-not-installed block removed"
    - path: "CSharp/src/WsusManager.App/Views/MainWindow.xaml"
      provides: "Sidebar buttons apply NavBtnActive style when their panel is current"
    - path: "CSharp/src/WsusManager.Tests/ViewModels/MainViewModelTests.cs"
      provides: "Test confirming no duplicate startup log message"
  key_links:
    - from: "CSharp/src/WsusManager.App/Views/MainWindow.xaml"
      to: "CSharp/src/WsusManager.App/Themes/DarkTheme.xaml"
      via: "NavBtnActive StaticResource key"
      pattern: "NavBtnActive"
    - from: "CSharp/src/WsusManager.App/Views/MainWindow.xaml"
      to: "CSharp/src/WsusManager.App/ViewModels/MainViewModel.cs"
      via: "CurrentPanel binding"
      pattern: "CurrentPanel"
---

<objective>
Fix the two known UI defects discovered during Phase 9 analysis: a spurious duplicate
"WSUS not installed" log message emitted at startup before the first dashboard refresh,
and the missing active-state visual indicator on sidebar navigation buttons.

Purpose: Deliver a startup experience that looks correct and professional — no confusing
double-message, and a clear visual cue for the currently-selected panel.
Output: Patched MainViewModel.cs, updated MainWindow.xaml with active-nav styling, and
a regression test covering the startup message fix.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-launch-and-ui-verification/09-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove duplicate startup log message in InitializeAsync</name>
  <files>CSharp/src/WsusManager.App/ViewModels/MainViewModel.cs</files>
  <action>
    Open MainViewModel.cs and find `InitializeAsync()`. The method currently has TWO
    blocks that check `if (!IsWsusInstalled)` and print "WSUS is not installed on this
    server." — one BEFORE and one AFTER the call to `await RefreshDashboard()`.

    The FIRST block (before the refresh) always fires on startup because `IsWsusInstalled`
    defaults to `false`. This causes users with WSUS installed to still see the spurious
    message before the real state is known.

    Fix: Delete the FIRST `if (!IsWsusInstalled)` block entirely (the one that appears
    before `await RefreshDashboard()`). Leave the SECOND block (after the refresh) exactly
    as-is — it is the correct one, only fires when WSUS is genuinely absent.

    The resulting InitializeAsync order must be:
    1. Load settings
    2. Call `await RefreshDashboard()` (this sets IsWsusInstalled correctly)
    3. Check `if (!IsWsusInstalled)` and show the guidance message
    4. Start the refresh timer

    Do not change anything else in the method or file.

    Then open MainViewModelTests.cs and add a test:
    - Name: `InitializeAsync_DoesNotLogWsusNotInstalledMessage_WhenWsusIsInstalled`
    - Setup: mock `IDashboardService.CollectAsync` to return a `DashboardData` where
      `IsWsusInstalled = true`
    - Call `await viewModel.InitializeAsync()`
    - Assert: `viewModel.LogOutput` does NOT contain "WSUS is not installed"

    Also add a companion test:
    - Name: `InitializeAsync_LogsWsusNotInstalledMessage_ExactlyOnce_WhenWsusIsAbsent`
    - Setup: mock `CollectAsync` to return `DashboardData` where `IsWsusInstalled = false`
    - Call `await viewModel.InitializeAsync()`
    - Assert: `viewModel.LogOutput.Split(new[]{"WSUS is not installed"}, StringSplitOptions.None).Length - 1 == 1`
      (i.e., the phrase appears exactly once)

    Look at existing MainViewModelTests.cs setup patterns to wire the mocks correctly —
    do not introduce new patterns.
  </action>
  <verify>
    cd /mnt/c/projects/GA-WsusManager/CSharp && dotnet test src/WsusManager.Tests --filter "FullyQualifiedName~MainViewModel" --verbosity normal 2>&1 | tail -20
  </verify>
  <done>
    The two new ViewModel tests pass. No existing tests regress. LogOutput on a
    WSUS-installed machine no longer contains a premature "WSUS is not installed" line.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply NavBtnActive style to the selected sidebar button</name>
  <files>CSharp/src/WsusManager.App/Views/MainWindow.xaml</files>
  <action>
    Open MainWindow.xaml. All sidebar nav buttons currently use
    `Style="{StaticResource NavBtn}"` unconditionally. The DarkTheme.xaml already
    defines `NavBtnActive` (brighter background, blue left border) — it just needs
    to be applied when the button's panel is current.

    The cleanest WPF-only approach without a value converter is to use a `Style.Triggers`
    data trigger on each button bound to `CurrentPanel`.

    For EACH sidebar nav button, replace the static `Style="{StaticResource NavBtn}"` with
    an inline style that:
    1. Sets `BasedOn="{StaticResource NavBtn}"` so the default appearance is unchanged
    2. Adds a `DataTrigger` bound to `CurrentPanel` (on the DataContext, i.e. the ViewModel)
       that sets `Style` (or more precisely, sets background and border properties) when
       the panel matches

    Because WPF does not allow `Style.Triggers` to set the `Style` property itself, use
    property setters directly in the trigger instead of switching styles. The `NavBtnActive`
    key exists for reference — read it from DarkTheme.xaml to replicate its exact property
    values in the trigger Setters.

    From DarkTheme.xaml, `NavBtnActive` sets (verify by reading the file):
    - `Background` to a brighter sidebar color (likely `#1C2128` or similar)
    - `BorderBrush` to the Blue color (`#58A6FF`)
    - `BorderThickness` to `2,0,0,0` (left border only)
    - `Foreground` to `Text1` (`#E6EDF3`)

    Apply this pattern to the following nav buttons (check the exact CommandParameter
    values in MainWindow.xaml to confirm panel names):
    - Dashboard button → trigger when `CurrentPanel == "Dashboard"`
    - Diagnostics button → trigger when `CurrentPanel == "Diagnostics"`
    - Database button → trigger when `CurrentPanel == "Database"`
    - Any other nav buttons that map to named panels

    Do NOT apply active styling to Settings, Help, About buttons — they navigate to
    the generic OperationPanel, so triggering on "Settings" etc. is fine but verify
    the CommandParameter values first.

    Pattern for each button (example for Dashboard):
    ```xml
    <Button Command="{Binding NavigateCommand}" CommandParameter="Dashboard" ...>
        <Button.Style>
            <Style BasedOn="{StaticResource NavBtn}" TargetType="Button">
                <Style.Triggers>
                    <DataTrigger Binding="{Binding CurrentPanel}" Value="Dashboard">
                        <Setter Property="Background" Value="#1C2128"/>
                        <Setter Property="BorderBrush" Value="#58A6FF"/>
                        <Setter Property="BorderThickness" Value="2,0,0,0"/>
                        <Setter Property="Foreground" Value="#E6EDF3"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Button.Style>
        ... button content ...
    </Button>
    ```

    Read DarkTheme.xaml to get the exact property values from the `NavBtnActive` style
    before writing the triggers — do not guess colors.

    After editing MainWindow.xaml, verify the file is valid XML:
    `xmllint --noout CSharp/src/WsusManager.App/Views/MainWindow.xaml 2>&1` or use
    `dotnet build` which validates XAML at compile time.
  </action>
  <verify>
    cd /mnt/c/projects/GA-WsusManager/CSharp && dotnet build src/WsusManager.App/WsusManager.App.csproj --configuration Release 2>&1 | tail -10
  </verify>
  <done>
    `dotnet build` succeeds with 0 errors. MainWindow.xaml compiles without
    `XamlParseException`. Each primary nav button (Dashboard, Diagnostics, Database)
    has a DataTrigger on CurrentPanel that applies active-style properties.
  </done>
</task>

<task type="auto">
  <name>Task 3: Full test suite and build verification</name>
  <files></files>
  <action>
    Run the complete test suite to confirm no regressions from Tasks 1 and 2.
    Then do a full Release build to confirm the App project still compiles cleanly.

    Commands to run in sequence:
    1. `cd /mnt/c/projects/GA-WsusManager/CSharp && dotnet test --configuration Release --verbosity normal 2>&1`
    2. Check that the count of passing tests is >= 247 (245 baseline + 2 new tests from Task 1)
    3. Check that 0 tests fail
    4. `dotnet build --configuration Release 2>&1 | tail -5` — must end with "0 Error(s)"

    If any test fails, read the failure output and fix the root cause before proceeding.
    Do not mark this task done with failing tests.
  </action>
  <verify>
    cd /mnt/c/projects/GA-WsusManager/CSharp && dotnet test --configuration Release 2>&1 | grep -E "passed|failed|Error"
  </verify>
  <done>
    All tests pass (>= 247). Zero failures. `dotnet build` reports 0 Error(s).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `dotnet test` passes with >= 247 tests, 0 failures
2. `dotnet build --configuration Release` exits with 0 errors
3. Grep MainViewModel.cs confirms only ONE `if (!IsWsusInstalled)` block exists in
   InitializeAsync, and it appears AFTER the `await RefreshDashboard()` call
4. Grep MainWindow.xaml confirms `NavBtnActive` or `DataTrigger` with `CurrentPanel`
   binding appears for Dashboard, Diagnostics, and Database nav buttons
</verification>

<success_criteria>
- UI-01: Startup log is clean — no premature "WSUS not installed" message on
  machines where WSUS is installed
- UI-02: Dashboard populates correctly (no change required, was already correct)
- UI-03: Dark theme renders correctly (no change required, XAML was verified clean)
- UI-04: All panels switch correctly (no change required, navigation was correct)
- UI-05: Log panel works (no change required, was already correct)
- Visual gap closed: selected nav button shows active highlighting
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-launch-and-ui-verification/09-01-SUMMARY.md`
</output>
