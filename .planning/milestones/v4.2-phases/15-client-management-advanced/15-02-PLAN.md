---
phase: 15-client-management-advanced
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/WsusManager.Core/Services/Interfaces/IScriptGeneratorService.cs
  - src/WsusManager.Core/Services/ScriptGeneratorService.cs
  - src/WsusManager.App/ViewModels/MainViewModel.cs
  - src/WsusManager.App/Views/MainWindow.xaml
  - src/WsusManager.App/Program.cs
  - src/WsusManager.Tests/Services/ScriptGeneratorServiceTests.cs
autonomous: true
requirements:
  - CLI-08

must_haves:
  truths:
    - "Admin can select an operation type and generate a complete PowerShell script ready to run on a target host"
    - "Generated scripts cover all 5 client operations: cancel stuck jobs, force check-in, test connectivity, run diagnostics, and mass GPUpdate"
    - "Generated script is saved to a file via Save dialog — admin copies it to the target machine and runs it"
    - "Scripts are self-contained and require no external modules or WSUS Manager installation"
  artifacts:
    - path: "src/WsusManager.Core/Services/Interfaces/IScriptGeneratorService.cs"
      provides: "IScriptGeneratorService interface with GenerateScript method"
      contains: "GenerateScript"
    - path: "src/WsusManager.Core/Services/ScriptGeneratorService.cs"
      provides: "Script generation for all 5 operation types"
      contains: "ScriptGeneratorService"
    - path: "src/WsusManager.App/ViewModels/MainViewModel.cs"
      provides: "GenerateScript command with operation type selection"
      contains: "GenerateScript"
    - path: "src/WsusManager.App/Views/MainWindow.xaml"
      provides: "Script Generator card in Client Tools panel"
      contains: "Script Generator"
    - path: "src/WsusManager.App/Program.cs"
      provides: "IScriptGeneratorService DI registration"
      contains: "IScriptGeneratorService"
  key_links:
    - from: "MainViewModel.GenerateScript"
      to: "IScriptGeneratorService.GenerateScript"
      via: "_scriptGeneratorService.GenerateScript"
      pattern: "GenerateScript"
    - from: "ScriptGeneratorService"
      to: "SaveFileDialog"
      via: "ViewModel saves returned script content to user-chosen file"
      pattern: "File.WriteAllText"
---

<objective>
Implement the Script Generator fallback service (CLI-08). When WinRM is unavailable on a target host, the admin generates a self-contained PowerShell script for any client operation that can be manually run on the target machine.

Purpose: Many enterprise environments have WinRM disabled or blocked. The script generator ensures admins can still perform all client management operations by copying a ready-to-run script to the target.
Output: IScriptGeneratorService, ScriptGeneratorService, Script Generator UI card, ViewModel commands.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/WsusManager.Core/Services/ClientService.cs
@src/WsusManager.App/ViewModels/MainViewModel.cs
@src/WsusManager.App/Views/MainWindow.xaml
@src/WsusManager.App/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IScriptGeneratorService and ScriptGeneratorService</name>
  <files>
    src/WsusManager.Core/Services/Interfaces/IScriptGeneratorService.cs
    src/WsusManager.Core/Services/ScriptGeneratorService.cs
    src/WsusManager.Tests/Services/ScriptGeneratorServiceTests.cs
  </files>
  <action>
    Create IScriptGeneratorService interface:
    ```csharp
    namespace WsusManager.Core.Services.Interfaces;

    public interface IScriptGeneratorService
    {
        /// <summary>
        /// Generates a self-contained PowerShell script for the given operation type.
        /// The script is ready to run on the target host without any dependencies.
        /// </summary>
        /// <param name="operationType">One of: CancelStuckJobs, ForceCheckIn, TestConnectivity, RunDiagnostics, MassGpUpdate</param>
        /// <param name="wsusServerUrl">WSUS server URL — used for connectivity test script. Null for operations that don't need it.</param>
        /// <param name="hostnames">List of target hostnames — used for MassGpUpdate script. Null for single-host operations.</param>
        /// <returns>The complete PowerShell script content as a string.</returns>
        string GenerateScript(string operationType, string? wsusServerUrl = null, IReadOnlyList<string>? hostnames = null);

        /// <summary>
        /// Returns the list of available operation types for the UI dropdown.
        /// </summary>
        IReadOnlyList<string> GetAvailableOperations();
    }
    ```

    Create ScriptGeneratorService implementation. Each script must:
    - Start with a comment header: `# WSUS Manager - {Operation Name} Script` + `# Generated: {date}` + `# Run this script on the target host as Administrator`
    - Include `#Requires -RunAsAdministrator`
    - Be fully self-contained — no module imports, no external dependencies
    - Use Write-Host with colors for output (green for success, red for failure, yellow for warnings)
    - End with `Write-Host "Script complete. Press Enter to exit." -ForegroundColor Cyan` + `Read-Host`

    Script templates (embed as string constants or methods — NOT external template files):

    **CancelStuckJobs:**
    - Stop-Service wuauserv, bits -Force
    - Remove-Item 'C:\Windows\SoftwareDistribution\*' -Recurse -Force
    - Start-Service bits, wuauserv
    - Verify services running with Get-Service

    **ForceCheckIn:**
    - gpupdate /force
    - wuauclt /resetauthorization
    - wuauclt /detectnow
    - wuauclt /reportnow
    - If usoclient exists: usoclient StartScan

    **TestConnectivity (uses wsusServerUrl parameter):**
    - Extract hostname from URL
    - Test-NetConnection to port 8530 and 8531
    - Report pass/fail for each port with latency
    - Test DNS resolution of WSUS server

    **RunDiagnostics:**
    - Read WSUS registry keys (WUServer, WUStatusServer, UseWUServer)
    - Get-Service wuauserv, bits, cryptsvc with status
    - Check pending reboot registry key
    - Read WUA agent version
    - Report all findings in a formatted table

    **MassGpUpdate (uses hostnames parameter):**
    - Generate a script that iterates the provided hostname list
    - For each host: Test-WSMan, if available run Invoke-Command with gpupdate + wuauclt commands
    - If WinRM unavailable for a host, log and continue
    - Summary at end with pass/fail count
    - If hostnames is null/empty, generate a template with placeholder: `$Hostnames = @("HOST1", "HOST2", "HOST3")` for the admin to fill in

    GetAvailableOperations returns:
    `["Cancel Stuck Jobs", "Force Check-In", "Test Connectivity", "Run Diagnostics", "Mass GPUpdate"]`

    Internally map display names to operation type strings used in GenerateScript.

    Unit tests:
    - Each operation type generates valid PowerShell (contains #Requires -RunAsAdministrator, contains operation-specific commands)
    - TestConnectivity script includes the provided WSUS server URL
    - MassGpUpdate script includes provided hostnames in the $Hostnames array
    - MassGpUpdate with null hostnames generates placeholder template
    - GetAvailableOperations returns 5 items
    - Unknown operation type returns a helpful error message or throws ArgumentException
  </action>
  <verify>
    Run `dotnet build src/WsusManager.Core` succeeds.
    Run `dotnet test src/WsusManager.Tests --filter "ScriptGenerator"` — all tests pass.
  </verify>
  <done>
    ScriptGeneratorService generates complete, self-contained PowerShell scripts for all 5 operation types. Scripts include admin requirement, colored output, and are ready to run without edits. Tests verify each operation type produces valid content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Script Generator UI card, ViewModel command, and DI registration</name>
  <files>
    src/WsusManager.App/ViewModels/MainViewModel.cs
    src/WsusManager.App/Views/MainWindow.xaml
    src/WsusManager.App/Program.cs
  </files>
  <action>
    In Program.cs, add DI registration after the IClientService line:
    ```csharp
    builder.Services.AddSingleton<IScriptGeneratorService, ScriptGeneratorService>();
    ```
    Add the `using WsusManager.Core.Services.Interfaces;` if not already present (it should be).

    In MainViewModel.cs:

    1. Add `IScriptGeneratorService` as a constructor parameter and store as `_scriptGeneratorService` field.

    2. Add properties:
       ```csharp
       [ObservableProperty]
       private string _selectedScriptOperation = string.Empty;

       public IReadOnlyList<string> ScriptOperations => _scriptGeneratorService.GetAvailableOperations();
       ```

    3. Add GenerateScript command (no CanExecute on IsOperationRunning — script generation is local and instant):
       ```csharp
       [RelayCommand]
       private void GenerateScript()
       ```
       - If SelectedScriptOperation is empty, AppendLog("Select an operation type first.") and return
       - Call _scriptGeneratorService.GenerateScript with the selected operation, passing:
         - wsusServerUrl: construct from settings like the TestConnectivity command does (`http://{host}:8530`)
         - hostnames: if MassGpUpdate, parse MassHostnames (same parsing as RunMassGpUpdate); otherwise null
       - Open SaveFileDialog with filter "PowerShell Scripts (*.ps1)|*.ps1|All Files (*.*)|*.*", default name "WsusManager-{operation}-{date}.ps1"
       - If user confirms, File.WriteAllText the script content
       - AppendLog("Script saved to: {path}")

    4. Add GenerateScriptCommand to NotifyCommandCanExecuteChanged() (even though it has no CanExecute, keeping the pattern consistent is fine — just add the line).

    In MainWindow.xaml, add a "Script Generator" card AFTER the "Mass Operations" card and BEFORE the "Error Code Lookup" card:

    ```xml
    <!-- Script Generator -->
    <Border Background="{StaticResource BgCard}" CornerRadius="6"
            Padding="16" Margin="0,0,0,12">
        <StackPanel>
            <TextBlock Text="Script Generator" FontSize="14" FontWeight="SemiBold"
                       Foreground="{StaticResource Text1}" Margin="0,0,0,8"/>
            <TextBlock Text="Generate a ready-to-run PowerShell script for environments where WinRM is unavailable. Copy the script to the target host and run it as Administrator."
                       Foreground="{StaticResource Text2}" FontSize="12"
                       TextWrapping="Wrap" Margin="0,0,0,12"/>
            <Grid Margin="0,0,0,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="90"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Operation:"
                           Foreground="{StaticResource Text2}" FontSize="13"
                           VerticalAlignment="Center"/>
                <ComboBox Grid.Column="1"
                          ItemsSource="{Binding ScriptOperations}"
                          SelectedItem="{Binding SelectedScriptOperation}"
                          Background="{StaticResource BgInput}"
                          Foreground="{StaticResource Text1}"
                          BorderBrush="{StaticResource Border}"
                          Padding="8,6" FontSize="13"/>
            </Grid>
            <Button Content="Generate Script" Style="{StaticResource BtnSec}"
                    Padding="16,8" HorizontalAlignment="Left"
                    Command="{Binding GenerateScriptCommand}"
                    ToolTip="Generate a PowerShell script file for the selected operation"/>
        </StackPanel>
    </Border>
    ```

    IMPORTANT:
    - The ComboBox may need a dark theme style override if the default WPF ComboBox does not match the dark theme. Check if there's a ComboBox style in App.xaml resources. If not, add inline style setters for Background, Foreground, and dropdown appearance to match BgInput/Text1.
    - Match existing UI patterns exactly (same margins, padding, font sizes).
  </action>
  <verify>
    Run `dotnet build` succeeds for the entire solution.
    Run `dotnet test` passes all existing and new tests.
    Client Tools panel now shows: Target Host, Remote Operations, Mass Operations, Script Generator, Error Code Lookup (in that order).
  </verify>
  <done>
    Script Generator card appears in Client Tools panel with operation ComboBox and Generate button. Selecting an operation and clicking Generate opens a Save dialog and writes a complete PowerShell script. DI registration wires IScriptGeneratorService to ScriptGeneratorService. The ViewModel correctly passes WSUS URL and hostnames context to the generator.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for the entire solution
2. `dotnet test` passes all existing and new tests
3. Script Generator ComboBox shows 5 operation types
4. Each generated script contains #Requires -RunAsAdministrator and operation-specific commands
5. Generated scripts are self-contained — no imports or external dependencies
6. Mass GPUpdate script includes hostnames from the Mass Operations TextBox when present
7. Test Connectivity script includes the WSUS server URL from settings
</verification>

<success_criteria>
- CLI-08 is fully implemented: admin can generate ready-to-run PowerShell scripts for all 5 client operations
- Scripts are complete and require no edits before execution
- DI registration is in place and resolves correctly
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-client-management-advanced/15-02-SUMMARY.md`
</output>
