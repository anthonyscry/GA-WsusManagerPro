---
phase: 13-operation-feedback-and-dialog-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/WsusManager.App/ViewModels/MainViewModel.cs
  - src/WsusManager.App/Views/MainWindow.xaml
  - src/WsusManager.App/Themes/DarkTheme.xaml
autonomous: true
requirements: [UX-01, UX-02, UX-03, UX-04]

must_haves:
  truths:
    - "An indeterminate progress bar is visible in the log panel header whenever an operation is running"
    - "Multi-step operations (Diagnostics 12 checks, Deep Cleanup 6 steps) show current step name in the progress area"
    - "When an operation completes, a colored success (green) or failure (red) banner is visible in the status area"
    - "The log panel auto-scrolls to latest output during operations (already implemented)"
  artifacts:
    - path: "src/WsusManager.App/ViewModels/MainViewModel.cs"
      provides: "IsProgressBarVisible, OperationStepText, StatusBannerColor, StatusBannerVisibility properties"
      contains: "IsProgressBarVisible"
    - path: "src/WsusManager.App/Views/MainWindow.xaml"
      provides: "ProgressBar element and status banner in log panel header"
      contains: "ProgressBar"
    - path: "src/WsusManager.App/Themes/DarkTheme.xaml"
      provides: "ProgressBar dark theme style"
      contains: "ProgressBar"
  key_links:
    - from: "MainViewModel.RunOperationAsync"
      to: "IsProgressBarVisible"
      via: "Set true on start, false in finally block"
      pattern: "IsProgressBarVisible = true"
    - from: "MainWindow.xaml ProgressBar"
      to: "MainViewModel.IsProgressBarVisible"
      via: "Visibility binding"
      pattern: "Binding IsProgressBarVisible"
---

<objective>
Add real-time operation feedback to the main window: an indeterminate progress bar visible during operations, step tracking text for multi-step operations, and a colored success/failure banner when operations complete.

Purpose: Admins currently see only log text during operations with no visual indicator that something is running. This plan makes operation state immediately obvious at a glance.
Output: MainViewModel with progress/banner properties, MainWindow with ProgressBar and banner elements, DarkTheme with ProgressBar styling.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/WsusManager.App/ViewModels/MainViewModel.cs
@src/WsusManager.App/Views/MainWindow.xaml
@src/WsusManager.App/Themes/DarkTheme.xaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progress bar, step text, and status banner to ViewModel and XAML</name>
  <files>
    src/WsusManager.App/ViewModels/MainViewModel.cs
    src/WsusManager.App/Views/MainWindow.xaml
    src/WsusManager.App/Themes/DarkTheme.xaml
  </files>
  <action>
**MainViewModel.cs — Add observable properties:**

1. Add `[ObservableProperty]` fields with appropriate notifications:
   - `_isProgressBarVisible` (bool, default false) — controls progress bar visibility
   - `_operationStepText` (string, default empty) — shows "Step 3/6: Rebuilding indexes" text
   - `_statusBannerText` (string, default empty) — shows "Diagnostics completed successfully" or "Deep Cleanup failed"
   - `_statusBannerColor` (SolidColorBrush, default transparent) — Green (#3FB950) for success, Red (#F85149) for failure

2. Add computed properties:
   - `ProgressBarVisibility` => IsProgressBarVisible ? Visible : Collapsed
   - `StatusBannerVisibility` => !string.IsNullOrEmpty(StatusBannerText) ? Visible : Collapsed

3. In `RunOperationAsync`:
   - At start: set `IsProgressBarVisible = true`, clear `OperationStepText`, clear `StatusBannerText`
   - On success: set `StatusBannerText` to "{operationName} completed successfully.", `StatusBannerColor` to green (#3FB950)
   - On failure: set `StatusBannerText` to "{operationName} failed.", `StatusBannerColor` to red (#F85149)
   - On cancel: set `StatusBannerText` to "{operationName} cancelled.", `StatusBannerColor` to orange (#D29922)
   - In finally: set `IsProgressBarVisible = false`, clear `OperationStepText`

4. Add a public method `ReportStep(string stepText)` that sets `OperationStepText = stepText`. This can be called via progress reporting from services that use the `[Step N/M]` format. Parse the progress text in `AppendLog` — when a line matches `[Step \d+/\d+]`, also set `OperationStepText` to that line. Implementation: in the `Progress<string>` callback inside RunOperationAsync, check if the line starts with "[Step " and if so, set OperationStepText. Similarly, check for `[PASS]`/`[FAIL]` prefixes from diagnostics to count progress.

**MainWindow.xaml — Add UI elements:**

1. In the log panel header (the `<Border DockPanel.Dock="Top">` area), between the left StackPanel and right StackPanel, add:
   - An indeterminate `ProgressBar` (Height="3", Width="120", IsIndeterminate="True") bound to `ProgressBarVisibility`
   - A `TextBlock` bound to `OperationStepText` with Text2 foreground, FontSize 11, next to the CurrentOperationName

2. Above the log panel (or at the bottom of Grid.Row="1"), add a status banner:
   - A `Border` with Height="Auto", Padding="8,4", bound to `StatusBannerVisibility`
   - Background bound to `StatusBannerColor`
   - Contains a `TextBlock` bound to `StatusBannerText`, Foreground White, FontSize 12, FontWeight SemiBold
   - Place this inside the log panel area, above the log text but below the header — specifically, add it as a new element between the log header and the log TextBox in the DockPanel, docked to Top

**DarkTheme.xaml — Add ProgressBar style:**

Add a `Style TargetType="ProgressBar"` that styles the progress bar for dark theme:
- Background: BgDark (#0D1117)
- Foreground/fill: Blue (#58A6FF)
- Height: 3
- BorderThickness: 0

**UX-04 verification:** The auto-scroll is already implemented in `MainWindow.xaml.cs` via `LogTextBox_TextChanged` calling `ScrollToEnd()`. No changes needed — just verify it exists.
  </action>
  <verify>
1. `dotnet build src/WsusManager.App/WsusManager.App.csproj` succeeds with 0 errors
2. Grep for "IsProgressBarVisible" in MainViewModel.cs — property exists
3. Grep for "ProgressBar" in MainWindow.xaml — element exists with IsIndeterminate binding
4. Grep for "StatusBannerText" in MainWindow.xaml — bound to a TextBlock
5. Grep for "ProgressBar" in DarkTheme.xaml — style exists
6. Grep for "ScrollToEnd" in MainWindow.xaml.cs — auto-scroll exists (UX-04)
  </verify>
  <done>
- Indeterminate progress bar appears in log panel header during operations and disappears when done
- Step text shows current step from multi-step operations (parsed from "[Step N/M]" progress lines)
- Colored status banner appears after operation completion: green for success, red for failure, orange for cancel
- Banner text includes operation name and result
- Auto-scroll confirmed working (UX-04)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests and verify build</name>
  <files>
    src/WsusManager.Tests/ViewModels/MainViewModelTests.cs
  </files>
  <action>
Add or extend tests in `MainViewModelTests.cs` to cover the new operation feedback properties:

1. **Test: Progress bar visible during operation** — Call RunOperationAsync, verify IsProgressBarVisible is true during the operation callback and false after completion.

2. **Test: Status banner shows success on completion** — Call RunOperationAsync with a successful operation, verify StatusBannerText contains "completed successfully" and StatusBannerColor is green.

3. **Test: Status banner shows failure on error** — Call RunOperationAsync with a failing operation, verify StatusBannerText contains "failed" and StatusBannerColor is red.

4. **Test: Step text updated from progress lines** — During RunOperationAsync, report a line starting with "[Step 3/6]", verify OperationStepText is updated.

5. **Test: Progress bar and step text cleared after operation** — After RunOperationAsync completes, verify IsProgressBarVisible is false and OperationStepText is empty.

Follow the existing test patterns in the file. Use the existing mock/service setup. Run all tests with `dotnet test` to confirm everything passes.
  </action>
  <verify>
1. `dotnet test src/WsusManager.Tests/WsusManager.Tests.csproj` — all tests pass
2. `dotnet build --configuration Release` — full solution builds
  </verify>
  <done>
- All new tests pass
- Full test suite passes (263+ tests, 0 failures)
- Solution builds in Release configuration with 0 errors
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with 0 errors
2. `dotnet test` passes all tests (263+)
3. MainWindow.xaml contains ProgressBar element
4. MainViewModel.cs contains IsProgressBarVisible, OperationStepText, StatusBannerText properties
5. DarkTheme.xaml contains ProgressBar style
6. LogTextBox_TextChanged with ScrollToEnd confirmed present (UX-04)
</verification>

<success_criteria>
- Progress bar visible during operations, hidden when idle
- Step text shows "[Step N/M]: ..." for multi-step operations
- Colored banner appears after operation completion (green/red/orange)
- Log panel auto-scrolls during operations
- All tests pass, solution builds
</success_criteria>

<output>
After completion, create `.planning/phases/13-operation-feedback-and-dialog-polish/13-01-SUMMARY.md`
</output>
