---
phase: 12-settings-and-mode-override
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/WsusManager.App/Views/MainWindow.xaml
  - src/WsusManager.App/ViewModels/MainViewModel.cs
autonomous: true
requirements:
  - SET-03
  - SET-04

must_haves:
  truths:
    - "Dashboard shows an Air-Gap / Online toggle button the admin can click"
    - "Clicking the toggle switches the mode instantly — UI updates ConnectionDotColor and ServerModeText immediately"
    - "After toggling to Air-Gap, the next auto-refresh does NOT flip back to Online (network detection bypassed)"
    - "After toggling to Online, the next auto-refresh respects real network connectivity"
    - "Manual override persists to settings.json so it survives an app restart"
    - "QuickSync button stays disabled when mode is manually set to Air-Gap"
  artifacts:
    - path: "src/WsusManager.App/Views/MainWindow.xaml"
      provides: "Toggle button in Dashboard Quick Actions section"
      contains: "ToggleModeCommand binding, dynamic Content showing current mode"
    - path: "src/WsusManager.App/ViewModels/MainViewModel.cs"
      provides: "ToggleMode command + _modeOverrideActive flag that bypasses DashboardService.IsOnline"
  key_links:
    - from: "ToggleModeCommand"
      to: "_modeOverrideActive flag"
      via: "Flips IsOnline, sets _modeOverrideActive=true, saves settings"
      pattern: "ToggleMode"
    - from: "UpdateDashboardCards"
      to: "_modeOverrideActive"
      via: "If _modeOverrideActive, ignore data.IsOnline — keep current IsOnline"
      pattern: "_modeOverrideActive"
---

<objective>
Add a mode toggle button to the dashboard Quick Actions bar that lets admins manually switch between Online and Air-Gap mode instantly. Once toggled manually, the automatic network detection (ping check in DashboardService) is bypassed so the mode stays pinned until the admin changes it again.

Purpose: Air-gapped servers have no internet connectivity. The auto-detection ping check will always return offline, but the admin may want to force "Online" mode for local-network WSUS scenarios, or force "Air-Gap" to prevent sync operations from running. Manual override gives full control.
Output: Toggle button in MainWindow.xaml Quick Actions + ToggleMode command in MainViewModel with override logic.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/WsusManager.App/ViewModels/MainViewModel.cs
@src/WsusManager.App/Views/MainWindow.xaml
@src/WsusManager.Core/Models/AppSettings.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ToggleMode command and override logic to MainViewModel</name>
  <files>
    src/WsusManager.App/ViewModels/MainViewModel.cs
  </files>
  <action>
Add a manual mode override system to MainViewModel. When the admin uses the toggle, the override is active and dashboard refreshes no longer flip the mode.

**New fields and properties:**

```csharp
// Manual mode override — when true, dashboard refresh ignores DashboardService.IsOnline
private bool _modeOverrideActive;

// Dynamic button label for the toggle button in the UI
public string ToggleModeText => IsOnline ? "Switch to Air-Gap" : "Switch to Online";

// Indicator text for whether override is active (shown as subtext near toggle)
public string ModeOverrideIndicator => _modeOverrideActive ? "(manual)" : "(auto)";
```

Add `[NotifyPropertyChangedFor(nameof(ToggleModeText))]` and `[NotifyPropertyChangedFor(nameof(ModeOverrideIndicator))]` to the `_isOnline` observable property declaration. Also update the existing `_isOnline` property's `[NotifyPropertyChangedFor]` list to include these two new properties.

**ToggleMode command:**

```csharp
[RelayCommand]
private async Task ToggleMode()
{
    // Flip mode and activate override
    IsOnline = !IsOnline;
    _modeOverrideActive = true;

    // Persist the new mode to settings
    _settings.ServerMode = IsOnline ? "Online" : "AirGap";
    await SaveSettingsAsync();

    // Notify CanExecute for online-dependent operations
    NotifyCommandCanExecuteChanged();

    var modeLabel = IsOnline ? "Online" : "Air-Gap";
    AppendLog($"Server mode manually set to {modeLabel}. Auto-detection bypassed until changed.");
}
```

**Update UpdateDashboardCards to respect override:**

In `UpdateDashboardCards(DashboardData data)`, the current line:
```csharp
IsOnline = data.IsOnline;
```
Replace with:
```csharp
// Only update mode from network detection when no manual override is active
if (!_modeOverrideActive)
{
    IsOnline = data.IsOnline;
}
// When override is active, IsOnline stays at the manually chosen value
```

**Update ApplySettings to restore override state:**

In `ApplySettings(AppSettings settings)`, the server mode is restored from settings on startup. Add logic to detect if the saved mode was manually chosen vs auto-detected. Since there's no separate "wasOverrideActive" field in AppSettings, use a simple heuristic: if `ServerMode == "AirGap"`, activate the override so the app doesn't flip back to Online on the first ping success.

Actually: simpler approach — always activate override on startup if ServerMode is "AirGap" (since an air-gap server will never ping-succeed anyway, and Online mode should auto-refresh). So in `ApplySettings`:

```csharp
private void ApplySettings(AppSettings settings)
{
    IsLogPanelExpanded = settings.LogPanelExpanded;
    IsOnline = settings.ServerMode == "Online";
    // Activate override if saved mode is AirGap so auto-detection doesn't flip it
    _modeOverrideActive = settings.ServerMode == "AirGap";
    ConfigContentPath = settings.ContentPath;
    ConfigSqlInstance = settings.SqlInstance;
    ConfigLogPath = @"C:\WSUS\Logs";
}
```

**Update NotifyCommandCanExecuteChanged():**

Add `ToggleModeCommand.NotifyCanExecuteChanged();` to the list. ToggleMode has no CanExecute restriction but including it is safe.
  </action>
  <verify>
`dotnet build /mnt/c/projects/GA-WsusManager/src/WsusManager.sln` passes with zero errors.
  </verify>
  <done>
MainViewModel compiles. _modeOverrideActive field exists. ToggleModeCommand exists. UpdateDashboardCards has the override guard. ApplySettings activates override for AirGap mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mode toggle button to Dashboard Quick Actions in MainWindow.xaml</name>
  <files>
    src/WsusManager.App/Views/MainWindow.xaml
  </files>
  <action>
Add the toggle button to the Quick Actions WrapPanel on the dashboard. The button label dynamically reflects current mode.

**In MainWindow.xaml**, find the Quick Actions WrapPanel (contains QBtnDiagnostics, QBtnCleanup, QBtnSync, QBtnStartServices). Add the toggle button after QBtnStartServices:

```xml
<Button x:Name="QBtnToggleMode"
        Style="{StaticResource QuickActionBtn}"
        Content="{Binding ToggleModeText}"
        Margin="0,0,8,8"
        Command="{Binding ToggleModeCommand}"
        ToolTip="Manually override Online/Air-Gap mode. Bypasses automatic network detection."/>
```

**Also update the Configuration section** in the dashboard to show the override indicator. Find the "Server Mode" row (Grid Row 3):

```xml
<!-- Replace the existing Server Mode value TextBlock with a StackPanel: -->
<StackPanel Grid.Row="3" Grid.Column="1" Orientation="Horizontal">
    <TextBlock Text="{Binding ServerModeText}"
               Foreground="{StaticResource Text1}" FontSize="12"/>
    <TextBlock Text="{Binding ModeOverrideIndicator}"
               Foreground="{StaticResource Text3}" FontSize="11"
               Margin="6,0,0,0" VerticalAlignment="Center"/>
</StackPanel>
```

Remove the existing `<TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding ServerModeText}" .../>` and replace it with the StackPanel above.

**Also update the header connection status indicator** to show manual override hint when active. Find the connection status StackPanel in the header bar (contains Ellipse + ConnectionStatusText TextBlock). Add a small "(manual)" indicator:

```xml
<!-- After the existing ConnectionStatusText TextBlock, add: -->
<TextBlock Text="{Binding ModeOverrideIndicator}"
           Foreground="{StaticResource Text3}" FontSize="11"
           Margin="4,0,0,0"
           VerticalAlignment="Center"/>
```

This gives the admin a clear signal in the header that the mode is manually controlled.
  </action>
  <verify>
`dotnet build /mnt/c/projects/GA-WsusManager/src/WsusManager.sln` passes with zero errors.
Run: `dotnet run --project /mnt/c/projects/GA-WsusManager/src/WsusManager.App`
- Dashboard shows "Switch to Air-Gap" button in Quick Actions
- Clicking it changes button label to "Switch to Online" and shows "(manual)" in Configuration
- Header shows "(manual)" indicator
- After clicking, waiting 30 seconds (auto-refresh) does NOT flip mode back
  </verify>
  <done>
Toggle button visible in Quick Actions. Clicking switches mode instantly. Configuration section shows "(manual)" indicator. Auto-refresh does not override manual setting. Mode persists to settings.json (verifiable by closing/reopening app).
  </done>
</task>

</tasks>

<verification>
- `dotnet build /mnt/c/projects/GA-WsusManager/src/WsusManager.sln` passes with zero errors
- Dashboard Quick Actions contains "Switch to Air-Gap" / "Switch to Online" toggle button
- Toggling to Air-Gap: button label changes, "(manual)" appears in config and header, Online Sync quick button becomes disabled
- Toggling back to Online: "(manual)" remains (still overriding), Online Sync re-enables
- Waiting through an auto-refresh cycle (30s): mode does not flip back
- settings.json reflects the chosen mode after toggle
- App restart restores the chosen Air-Gap mode (override re-activates in ApplySettings)
</verification>

<success_criteria>
1. "Switch to Air-Gap" button appears in Quick Actions on the dashboard
2. Clicking it instantly changes the mode — ConnectionDotColor goes red, ServerModeText shows "Air-Gap"
3. "(manual)" indicator appears in both the header and the Configuration section
4. Online Sync button becomes disabled in Air-Gap mode
5. 30-second auto-refresh does not revert the manually chosen mode
6. Clicking "Switch to Online" restores online mode indicators instantly
7. Mode choice is written to settings.json and survives app restart
</success_criteria>

<output>
After completion, create `.planning/phases/12-settings-and-mode-override/12-02-SUMMARY.md`
</output>
