---
phase: 16-theme-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/WsusManager.App/Themes/DarkTheme.xaml
  - src/WsusManager.App/Themes/SharedStyles.xaml
  - src/WsusManager.App/Themes/DefaultDark.xaml
  - src/WsusManager.App/Services/ThemeService.cs
  - src/WsusManager.App/Services/IThemeService.cs
  - src/WsusManager.App/App.xaml
  - src/WsusManager.App/App.xaml.cs
  - src/WsusManager.App/Program.cs
  - src/WsusManager.Core/Models/AppSettings.cs
  - src/WsusManager.App/Views/MainWindow.xaml
  - src/WsusManager.App/Views/SettingsDialog.xaml
  - src/WsusManager.App/Views/TransferDialog.xaml
  - src/WsusManager.App/Views/ScheduleTaskDialog.xaml
  - src/WsusManager.App/Views/InstallDialog.xaml
  - src/WsusManager.App/Views/SyncProfileDialog.xaml
  - src/WsusManager.App/Views/GpoInstructionsDialog.xaml
  - src/WsusManager.App/ViewModels/MainViewModel.cs
  - src/WsusManager.Tests/ViewModels/MainViewModelTests.cs
  - src/WsusManager.Tests/Services/ThemeServiceTests.cs
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03
  - INFRA-04
  - INFRA-05

must_haves:
  truths:
    - "App renders identically to v4.2 after all changes — zero visual regressions on default dark theme"
    - "Changing the active color dictionary at runtime causes all colored UI elements to update immediately without restart"
    - "Dashboard card status bars and connection dot colors update when the theme swaps (ViewModel brushes use TryFindResource, not hardcoded Color.FromRgb)"
    - "App reads SelectedTheme from settings.json on startup and applies it before the main window appears — no theme flash"
    - "A grep for StaticResource on any color/brush resource key returns zero results across all 8 XAML files"
  artifacts:
    - path: "src/WsusManager.App/Themes/SharedStyles.xaml"
      provides: "Permanent structural styles (ControlTemplates, Styles, layout definitions) referencing colors via DynamicResource"
      contains: "DynamicResource"
    - path: "src/WsusManager.App/Themes/DefaultDark.xaml"
      provides: "Swappable color token dictionary with all 14+ semantic color keys as SolidColorBrush and Color resources"
      contains: "PrimaryBackground"
    - path: "src/WsusManager.App/Services/IThemeService.cs"
      provides: "IThemeService interface with ApplyTheme and CurrentTheme"
      contains: "ApplyTheme"
    - path: "src/WsusManager.App/Services/ThemeService.cs"
      provides: "ThemeService singleton that swaps color dictionaries at runtime"
      contains: "MergedDictionaries"
    - path: "src/WsusManager.App/App.xaml"
      provides: "Loads SharedStyles.xaml permanently plus DefaultDark.xaml as the swappable color dictionary"
      contains: "SharedStyles.xaml"
    - path: "src/WsusManager.Core/Models/AppSettings.cs"
      provides: "SelectedTheme property persisted to settings.json"
      contains: "SelectedTheme"
  key_links:
    - from: "Program.Main"
      to: "ThemeService.ApplyTheme"
      via: "Applies persisted theme before MainWindow construction"
      pattern: "ApplyTheme"
    - from: "ThemeService.ApplyTheme"
      to: "Application.Current.Resources.MergedDictionaries"
      via: "Clears old color dict, adds new theme ResourceDictionary"
      pattern: "MergedDictionaries"
    - from: "MainViewModel dashboard color properties"
      to: "Application.Current.TryFindResource"
      via: "Looks up theme-aware brush instead of hardcoded Color.FromRgb"
      pattern: "TryFindResource"
---

<objective>
Migrate the app's styling system to support runtime color-scheme swapping. Split DarkTheme.xaml into permanent structural styles and swappable color tokens, convert all StaticResource color references to DynamicResource, extract hardcoded hex values to named keys, migrate ViewModel brushes to theme-aware lookups, and implement ThemeService for runtime swapping.

Purpose: Establishes the infrastructure for Phase 17's theme picker. Without this, adding new themes would produce no visual effect because StaticResource bindings are resolved once at load time and never update.
Output: SharedStyles.xaml, DefaultDark.xaml, ThemeService, all XAML files using DynamicResource, all ViewModel brushes using TryFindResource.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-theme-infrastructure/16-CONTEXT.md
@src/WsusManager.App/Themes/DarkTheme.xaml
@src/WsusManager.App/App.xaml
@src/WsusManager.App/App.xaml.cs
@src/WsusManager.App/Program.cs
@src/WsusManager.Core/Models/AppSettings.cs
@src/WsusManager.App/ViewModels/MainViewModel.cs
@src/WsusManager.App/Views/MainWindow.xaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split DarkTheme.xaml into SharedStyles.xaml + DefaultDark.xaml, create ThemeService, update App.xaml</name>
  <files>
    src/WsusManager.App/Themes/DarkTheme.xaml
    src/WsusManager.App/Themes/SharedStyles.xaml
    src/WsusManager.App/Themes/DefaultDark.xaml
    src/WsusManager.App/Services/IThemeService.cs
    src/WsusManager.App/Services/ThemeService.cs
    src/WsusManager.App/App.xaml
    src/WsusManager.App/App.xaml.cs
    src/WsusManager.App/Program.cs
    src/WsusManager.Core/Models/AppSettings.cs
    src/WsusManager.Tests/Services/ThemeServiceTests.cs
  </files>
  <action>
    **Step 1a: Create DefaultDark.xaml (color tokens only)**

    Create `src/WsusManager.App/Themes/DefaultDark.xaml` containing ONLY color definitions using semantic names. Map existing DarkTheme.xaml keys to semantic equivalents:

    ```
    Existing Key    -> Semantic Key              -> Value
    BgDark          -> PrimaryBackground         -> #0D1117
    BgSidebar       -> NavBackground             -> #161B22
    BgCard          -> CardBackground            -> #21262D
    BgInput         -> InputBackground           -> #0D1117
    Border          -> BorderPrimary             -> #30363D
    Blue            -> AccentBrush               -> #58A6FF
    Green           -> StatusSuccess             -> #3FB950
    Orange          -> StatusWarning             -> #D29922
    Red             -> StatusError               -> #F85149
    Text1           -> TextPrimary               -> #E6EDF3
    Text2           -> TextSecondary             -> #8B949E
    Text3           -> TextMuted                 -> #484F58
    (new)           -> AccentHover               -> #79C0FF
    (new)           -> BorderSubtle              -> #21262D
    (new)           -> ButtonPrimary             -> #238636
    (new)           -> ButtonPrimaryHover        -> #2EA043
    (new)           -> ButtonDanger              -> #DA3633
    (new)           -> ButtonDangerHover         -> #F85149
    (new)           -> NavActiveBackground       -> #21262D
    ```

    Each key gets both a SolidColorBrush resource and a matching Color resource (prefix `Color`):
    ```xml
    <Color x:Key="ColorPrimaryBackground">#0D1117</Color>
    <SolidColorBrush x:Key="PrimaryBackground" Color="{StaticResource ColorPrimaryBackground}"/>
    ```

    Note: Within DefaultDark.xaml itself, use StaticResource for the Color-to-Brush binding (both are in the same dictionary, resolved together).

    ALSO keep backward-compatible alias keys so the split is non-breaking. For every old key name (BgDark, BgSidebar, BgCard, BgInput, Border, Blue, Green, Orange, Red, Text1, Text2, Text3), add an alias:
    ```xml
    <SolidColorBrush x:Key="BgDark" Color="{StaticResource ColorPrimaryBackground}"/>
    ```
    These aliases will be removed in a later task after all references are migrated to semantic names.

    **Step 1b: Create SharedStyles.xaml (structural styles)**

    Create `src/WsusManager.App/Themes/SharedStyles.xaml` with all styles and ControlTemplates from DarkTheme.xaml (NavBtn, NavBtnActive, Btn, BtnSec, BtnGreen, BtnRed, QuickActionBtn, CategoryLabel, CardTitle, CardValue, CardSubtext, LogTextBox, ProgressBar, ScrollBar).

    CRITICAL: Every color/brush reference inside SharedStyles.xaml MUST use `DynamicResource` instead of `StaticResource`. This includes:
    - Setter values referencing brush keys (e.g., `Value="{DynamicResource TextSecondary}"`)
    - ControlTemplate trigger Setter values that reference brush keys
    - Hardcoded hex values inside ControlTemplate triggers MUST be replaced with DynamicResource references to the new semantic keys

    Specific hardcoded hex replacements in styles:
    - `#21262D` (hover/active bg) -> `{DynamicResource NavActiveBackground}` or `{DynamicResource CardBackground}`
    - `#58A6FF` (accent) -> `{DynamicResource AccentBrush}`
    - `#238636` (green button bg) -> `{DynamicResource ButtonPrimary}`
    - `#2EA043` (green button hover) -> `{DynamicResource ButtonPrimaryHover}`
    - `#DA3633` (red button bg) -> `{DynamicResource ButtonDanger}`
    - `#F85149` (red button hover) -> `{DynamicResource ButtonDangerHover}`
    - `#E6EDF3` (text) -> `{DynamicResource TextPrimary}`

    Note: `BasedOn="{StaticResource NavBtn}"` stays as StaticResource — it references a Style, not a color.

    **Step 1c: Update App.xaml**

    Replace the single DarkTheme.xaml merge with two dictionaries:
    ```xml
    <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="Themes/SharedStyles.xaml"/>
        <ResourceDictionary Source="Themes/DefaultDark.xaml"/>
    </ResourceDictionary.MergedDictionaries>
    ```

    SharedStyles.xaml must come FIRST so its DynamicResource references resolve against the color dictionary that follows.

    **Step 1d: Create IThemeService and ThemeService**

    Create `src/WsusManager.App/Services/IThemeService.cs`:
    ```csharp
    public interface IThemeService
    {
        string CurrentTheme { get; }
        void ApplyTheme(string themeName);
        IReadOnlyList<string> AvailableThemes { get; }
    }
    ```

    Create `src/WsusManager.App/Services/ThemeService.cs`:
    - Constructor takes ISettingsService and ILogService
    - `_themeMap` dictionary maps theme names to XAML resource URIs: `{ "DefaultDark" -> "Themes/DefaultDark.xaml" }`
    - `ApplyTheme(string themeName)`:
      1. Validate themeName is in _themeMap (log warning and return if not found)
      2. Create new ResourceDictionary from the theme URI
      3. Find and remove the current color dictionary from `Application.Current.Resources.MergedDictionaries` (identify by checking if it contains the "PrimaryBackground" key)
      4. Add the new dictionary to MergedDictionaries
      5. Update `CurrentTheme` property
      6. Log the change
    - `AvailableThemes` returns _themeMap.Keys
    - For Phase 16, only "DefaultDark" is in the map. Phase 17 will add more.

    **Step 1e: Add SelectedTheme to AppSettings**

    Add to `AppSettings.cs`:
    ```csharp
    [JsonPropertyName("selectedTheme")]
    public string SelectedTheme { get; set; } = "DefaultDark";
    ```

    **Step 1f: Wire ThemeService into Program.cs**

    1. Register ThemeService as singleton in DI:
       ```csharp
       builder.Services.AddSingleton<IThemeService, ThemeService>();
       ```
    2. After `app.InitializeComponent()` and `app.ConfigureServices(host.Services)`, resolve ThemeService and call ApplyTheme with the persisted setting:
       ```csharp
       var themeService = host.Services.GetRequiredService<IThemeService>();
       themeService.ApplyTheme(
           host.Services.GetRequiredService<ISettingsService>().GetSettings().SelectedTheme);
       ```
       This MUST happen BEFORE `new MainWindow()` to prevent theme flash.

    **Step 1g: Delete DarkTheme.xaml**

    Remove `src/WsusManager.App/Themes/DarkTheme.xaml` — it has been split into SharedStyles.xaml + DefaultDark.xaml.

    **Step 1h: Add ThemeService unit tests**

    Create `src/WsusManager.Tests/Services/ThemeServiceTests.cs`:
    - Test that ApplyTheme with unknown name logs warning and does not crash
    - Test that CurrentTheme returns "DefaultDark" after construction
    - Test that AvailableThemes contains "DefaultDark"
    - Note: Cannot test actual ResourceDictionary swapping in unit tests (requires WPF Application). These are basic safety tests.
  </action>
  <verify>
    Run `dotnet build src/WsusManager.App` succeeds.
    Run `dotnet test src/WsusManager.Tests` — all existing and new tests pass.
    DarkTheme.xaml no longer exists. SharedStyles.xaml and DefaultDark.xaml exist.
    App.xaml references both SharedStyles.xaml and DefaultDark.xaml.
  </verify>
  <done>
    DarkTheme.xaml split into SharedStyles.xaml (permanent structural styles with DynamicResource color refs) and DefaultDark.xaml (swappable color tokens with semantic names + backward aliases). ThemeService can swap color dictionaries at runtime. Theme is applied from persisted settings before MainWindow construction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all StaticResource color references to DynamicResource and semantic names across all XAML files</name>
  <files>
    src/WsusManager.App/Views/MainWindow.xaml
    src/WsusManager.App/Views/SettingsDialog.xaml
    src/WsusManager.App/Views/TransferDialog.xaml
    src/WsusManager.App/Views/ScheduleTaskDialog.xaml
    src/WsusManager.App/Views/InstallDialog.xaml
    src/WsusManager.App/Views/SyncProfileDialog.xaml
    src/WsusManager.App/Views/GpoInstructionsDialog.xaml
  </files>
  <action>
    Across all 7 view XAML files, perform these replacements:

    **A. StaticResource -> DynamicResource for all color/brush keys**

    Replace every `{StaticResource X}` where X is a color/brush key with `{DynamicResource X}`. The color/brush keys are:
    - Old names: BgDark, BgSidebar, BgCard, BgInput, Border, Blue, Green, Orange, Red, Text1, Text2, Text3
    - New semantic names (migrate to these where straightforward): PrimaryBackground, NavBackground, CardBackground, InputBackground, BorderPrimary, AccentBrush, StatusSuccess, StatusWarning, StatusError, TextPrimary, TextSecondary, TextMuted

    Since backward-compatible aliases exist in DefaultDark.xaml, the migration can be done in two passes:
    1. First pass: change `StaticResource` to `DynamicResource` for ALL color/brush references (keeps old key names)
    2. Second pass: rename old key names to semantic names

    IMPORTANT: Do NOT change `StaticResource` references to Style keys (NavBtn, NavBtnActive, Btn, BtnSec, BtnGreen, BtnRed, QuickActionBtn, CategoryLabel, CardTitle, CardValue, CardSubtext, LogTextBox). Style references STAY as `StaticResource` — they reference structural styles, not colors.

    Exception: `BasedOn="{StaticResource NavBtn}"` stays as StaticResource.

    **B. Extract hardcoded hex values in MainWindow.xaml**

    MainWindow.xaml has 12 hardcoded hex values in nav button DataTrigger setters (4 buttons x 3 values each: Diagnostics, ClientTools, Database, Dashboard). Replace:
    - `Value="#21262D"` (Background) -> `Value="{DynamicResource NavActiveBackground}"`
    - `Value="#58A6FF"` (BorderBrush) -> `Value="{DynamicResource AccentBrush}"`
    - `Value="#E6EDF3"` (Foreground) -> `Value="{DynamicResource TextPrimary}"`

    **C. Estimated scope per file:**
    - MainWindow.xaml: ~157 StaticResource refs to color keys + 12 hex values = ~169 changes
    - SettingsDialog.xaml: ~18 changes
    - TransferDialog.xaml: ~28 changes
    - ScheduleTaskDialog.xaml: ~26 changes
    - InstallDialog.xaml: ~15 changes
    - SyncProfileDialog.xaml: ~14 changes
    - GpoInstructionsDialog.xaml: ~7 changes

    **D. Verification grep**

    After all changes, run: `grep -r "StaticResource" src/WsusManager.App/Views/ src/WsusManager.App/Themes/SharedStyles.xaml | grep -E "BgDark|BgSidebar|BgCard|BgInput|Border\b|Blue\b|Green\b|Orange\b|Red\b|Text1|Text2|Text3|PrimaryBackground|NavBackground|CardBackground|InputBackground|BorderPrimary|AccentBrush|StatusSuccess|StatusWarning|StatusError|TextPrimary|TextSecondary|TextMuted"`

    This MUST return zero results. The only StaticResource references remaining should be to Style keys.
  </action>
  <verify>
    Run `dotnet build src/WsusManager.App` succeeds.
    A grep for StaticResource on any color/brush key across all 8 XAML view files and SharedStyles.xaml returns zero results.
    Only StaticResource references remaining are to Style keys (NavBtn, Btn, etc.) and BasedOn references.
  </verify>
  <done>
    All 283 StaticResource color/brush references migrated to DynamicResource across 7 view files. All 12 hardcoded hex values in MainWindow.xaml nav triggers extracted to semantic DynamicResource keys. Old key names replaced with semantic names. Zero StaticResource references to color keys remain.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate ViewModel hardcoded brushes to theme-aware TryFindResource lookups</name>
  <files>
    src/WsusManager.App/ViewModels/MainViewModel.cs
    src/WsusManager.Tests/ViewModels/MainViewModelTests.cs
  </files>
  <action>
    **Step 3a: Add theme-aware brush helper to MainViewModel**

    Add a private helper method to MainViewModel:
    ```csharp
    /// <summary>
    /// Resolves a theme brush by key. Falls back to the provided default color if the resource is not found.
    /// </summary>
    private static SolidColorBrush GetThemeBrush(string resourceKey, Color fallback)
    {
        if (Application.Current?.TryFindResource(resourceKey) is SolidColorBrush brush)
            return brush;
        return new SolidColorBrush(fallback);
    }
    ```

    **Step 3b: Replace all Color.FromRgb / new SolidColorBrush calls**

    There are ~27 hardcoded brush creations in MainViewModel.cs. Replace each with GetThemeBrush:

    Color mappings:
    - `Color.FromRgb(0x3F, 0xB9, 0x50)` (green) -> `GetThemeBrush("StatusSuccess", Color.FromRgb(0x3F, 0xB9, 0x50))`
    - `Color.FromRgb(0xF8, 0x51, 0x49)` (red) -> `GetThemeBrush("StatusError", Color.FromRgb(0xF8, 0x51, 0x49))`
    - `Color.FromRgb(0xD2, 0x99, 0x22)` (orange) -> `GetThemeBrush("StatusWarning", Color.FromRgb(0xD2, 0x99, 0x22))`
    - `Color.FromRgb(0x8B, 0x94, 0x9E)` (gray/neutral) -> `GetThemeBrush("TextSecondary", Color.FromRgb(0x8B, 0x94, 0x9E))`

    Specific locations to update:
    1. Status banner colors (lines ~279, 287, 298, 307): success green, failure red, cancel orange, error red
    2. Field initializers for bar colors (lines ~392-404): ServicesBarColor, DatabaseBarColor, DiskBarColor, TaskBarColor defaults
    3. ConnectionDotColor computed property (line ~433-434): online green, offline red
    4. NotInstalledDashboard method (lines ~1131-1143): reset all bar colors to gray
    5. UpdateDashboardColors method (lines ~1151-1196): conditional green/orange/red/gray for services, database, disk, task bars

    **Step 3c: Update tests**

    In MainViewModelTests.cs, any test that asserts on specific Color.FromRgb values needs to be updated to accept the theme-resolved brush OR simply check that the brush is not null (since TryFindResource may return null in test context without a WPF Application).

    If tests create SolidColorBrush directly for assertions, keep them as-is but note they test the fallback path. The important thing is tests still pass.
  </action>
  <verify>
    Run `dotnet build src/WsusManager.App` succeeds.
    Run `dotnet test src/WsusManager.Tests` — all tests pass.
    A grep for `Color.FromRgb` in MainViewModel.cs returns ONLY the fallback parameters inside GetThemeBrush calls — no standalone `new SolidColorBrush(Color.FromRgb(...))` remains.
  </verify>
  <done>
    All 27 hardcoded brush creations in MainViewModel.cs replaced with GetThemeBrush lookups using theme resource keys (StatusSuccess, StatusError, StatusWarning, TextSecondary). Dashboard card status bars, connection dots, and status banners now respond to runtime theme changes. Fallback colors ensure no crash if a resource key is missing.
  </done>
</task>

<task type="auto">
  <name>Task 4: Remove backward-compatible alias keys and verify zero regressions</name>
  <files>
    src/WsusManager.App/Themes/DefaultDark.xaml
  </files>
  <action>
    After Tasks 2 and 3, all references use semantic key names. Remove the backward-compatible alias keys from DefaultDark.xaml:

    Remove these aliases:
    - BgDark, BgSidebar, BgCard, BgInput, Border, Blue, Green, Orange, Red, Text1, Text2, Text3
    - ColorGreen, ColorOrange, ColorRed, ColorBlue, ColorText2

    Keep ONLY the semantic keys (PrimaryBackground, NavBackground, CardBackground, etc.) and their Color counterparts (ColorPrimaryBackground, etc.).

    Run a final grep to confirm no file references the old key names:
    ```
    grep -r "BgDark\|BgSidebar\|BgCard\|BgInput\|\"Border\"\|\"Blue\"\|\"Green\"\|\"Orange\"\|\"Red\"\|\"Text1\"\|\"Text2\"\|\"Text3\"" src/WsusManager.App/
    ```
    Must return zero results (excluding comments if any).
  </action>
  <verify>
    Run `dotnet build` succeeds for the entire solution.
    Run `dotnet test` — all tests pass.
    No XAML or C# file references old key names (BgDark, BgSidebar, etc.).
    DefaultDark.xaml contains only semantic keys.
  </verify>
  <done>
    Backward-compatible alias keys removed. DefaultDark.xaml contains only semantic color keys. All XAML and C# code uses semantic names exclusively. Clean theme dictionary ready for Phase 17 to add additional theme files.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for the entire solution (WsusManager.App, WsusManager.Core, WsusManager.Tests)
2. `dotnet test` passes all existing and new tests
3. `grep -rn "StaticResource" src/WsusManager.App/Views/ src/WsusManager.App/Themes/SharedStyles.xaml` shows ZERO results for any color/brush key — only Style references remain
4. `grep -rn "new SolidColorBrush(Color.FromRgb" src/WsusManager.App/ViewModels/` returns zero results (all replaced with GetThemeBrush)
5. DarkTheme.xaml no longer exists; replaced by SharedStyles.xaml + DefaultDark.xaml
6. DefaultDark.xaml contains only semantic key names (no BgDark, Text1, etc.)
7. AppSettings.cs has SelectedTheme property
8. ThemeService is registered in DI and applies theme before MainWindow construction
</verification>

<success_criteria>
- INFRA-01: DarkTheme.xaml split into SharedStyles.xaml (permanent) and DefaultDark.xaml (swappable color tokens)
- INFRA-02: All XAML color/brush references use DynamicResource (283 refs migrated)
- INFRA-03: All hardcoded hex values extracted to named theme resource keys (12 in MainWindow.xaml + 26 in styles)
- INFRA-04: All ViewModel Color.FromRgb brushes use theme-aware TryFindResource lookup (~27 calls)
- INFRA-05: ThemeService can swap color dictionaries at runtime without app restart
- App renders identically to v4.2 on default dark theme — zero visual regressions
</success_criteria>

<output>
After completion, create `.planning/phases/16-theme-infrastructure/16-01-SUMMARY.md`
</output>
