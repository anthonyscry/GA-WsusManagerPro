---
phase: 12-settings-and-mode-override
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/WsusManager.App/Views/SettingsDialog.xaml
  - src/WsusManager.App/Views/SettingsDialog.xaml.cs
  - src/WsusManager.App/ViewModels/MainViewModel.cs
autonomous: true
requirements:
  - SET-01
  - SET-02

must_haves:
  truths:
    - "Admin opens Settings dialog and sees editable fields (not read-only TextBlocks)"
    - "ServerMode ComboBox shows Online/Air-Gap options and reflects current setting"
    - "RefreshInterval, ContentPath, and SqlInstance fields show current values and accept edits"
    - "Clicking Save writes updated values to settings.json and applies them in-memory immediately"
    - "Dashboard Configuration section reflects updated values after save without restart"
  artifacts:
    - path: "src/WsusManager.App/Views/SettingsDialog.xaml"
      provides: "Settings dialog with editable fields"
      contains: "ComboBox ServerMode, TextBox RefreshInterval, TextBox ContentPath, TextBox SqlInstance"
    - path: "src/WsusManager.App/Views/SettingsDialog.xaml.cs"
      provides: "Dialog code-behind — Save/Cancel handling, ESC close"
    - path: "src/WsusManager.App/ViewModels/MainViewModel.cs"
      provides: "OpenSettings command that shows dialog, applies and persists settings on OK"
  key_links:
    - from: "SettingsDialog"
      to: "MainViewModel.OpenSettingsAsync"
      via: "dialog.ShowDialog() == true → ApplySettings + SaveAsync"
      pattern: "OpenSettingsCommand"
    - from: "MainViewModel.ApplySettings"
      to: "_settings fields"
      via: "Updates _settings, ConfigContentPath, ConfigSqlInstance, restarts timer if interval changed"
      pattern: "ApplySettings.*settings"
---

<objective>
Make the Settings dialog fully editable. Right now Settings navigates to a generic "future update" panel. This plan replaces that with a proper WPF dialog containing editable fields for all AppSettings properties. Saving persists to JSON and applies the new values immediately in the running app.

Purpose: Admins need to change server mode, refresh interval, and WSUS paths without restarting the application.
Output: SettingsDialog.xaml + code-behind + OpenSettings command in MainViewModel.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/WsusManager.Core/Models/AppSettings.cs
@src/WsusManager.App/ViewModels/MainViewModel.cs
@src/WsusManager.App/Views/InstallDialog.xaml
@src/WsusManager.App/Views/InstallDialog.xaml.cs
@src/WsusManager.App/Themes/Generic.xaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettingsDialog XAML and code-behind</name>
  <files>
    src/WsusManager.App/Views/SettingsDialog.xaml
    src/WsusManager.App/Views/SettingsDialog.xaml.cs
  </files>
  <action>
Create a new WPF Window dialog at `src/WsusManager.App/Views/SettingsDialog.xaml` and its code-behind.

**XAML layout** (model after InstallDialog.xaml for consistent dark-theme styling):
- Window: Width=480, Height=380, ResizeMode=NoResize, WindowStartupLocation=CenterOwner, Background="{StaticResource BgDark}"
- Title: "Settings — WSUS Manager"
- Add KeyDown handler to close on ESC (per CLAUDE.md pattern — add immediately after ResizeMode)
- Grid layout: 16px padding, two sections:

**Section 1 — Server Mode:**
- Label: "Server Mode" (Text2 color, FontSize=12)
- ComboBox `CboServerMode` with two items: "Online", "Air-Gap" (SelectedItem bound to backing variable)
- Helper text: "Online uses network connectivity detection. Air-Gap disables sync operations." (Text3, 11px, TextWrapping=Wrap)

**Section 2 — General Settings (Grid with label column 160px, value column *):**
- Row 0: "Refresh Interval (sec)" label + TextBox `TxtRefreshInterval`
- Row 1: "Content Path" label + TextBox `TxtContentPath`
- Row 2: "SQL Instance" label + TextBox `TxtSqlInstance`

**Buttons (right-aligned, bottom):**
- "Save" button (BtnGreen style, IsDefault=True, Click=BtnSave_Click)
- "Cancel" button (BtnSec style, IsCancel=True, Click=BtnCancel_Click)

**Code-behind (SettingsDialog.xaml.cs):**
```csharp
// Constructor takes AppSettings to pre-populate fields
public SettingsDialog(AppSettings current)
{
    InitializeComponent();
    // Populate fields from current settings
    CboServerMode.SelectedItem = current.ServerMode == "AirGap" ? "Air-Gap" : "Online";
    TxtRefreshInterval.Text = current.RefreshIntervalSeconds.ToString();
    TxtContentPath.Text = current.ContentPath;
    TxtSqlInstance.Text = current.SqlInstance;
    // ESC close
    KeyDown += (s, e) => { if (e.Key == Key.Escape) Close(); };
}

// Public property — caller reads this after ShowDialog() == true
public AppSettings? Result { get; private set; }

private void BtnSave_Click(object sender, RoutedEventArgs e)
{
    // Basic validation: refresh interval must be a positive integer
    if (!int.TryParse(TxtRefreshInterval.Text, out var interval) || interval < 5)
    {
        MessageBox.Show("Refresh interval must be a number >= 5 seconds.", "Validation Error",
            MessageBoxButton.OK, MessageBoxImage.Warning);
        return;
    }
    Result = new AppSettings
    {
        ServerMode = CboServerMode.SelectedItem?.ToString() == "Air-Gap" ? "AirGap" : "Online",
        RefreshIntervalSeconds = interval,
        ContentPath = TxtContentPath.Text.Trim(),
        SqlInstance = TxtSqlInstance.Text.Trim(),
        // Preserve fields not shown in this dialog
        LogPanelExpanded = true,  // caller overrides with current value
        LiveTerminalMode = false   // caller overrides with current value
    };
    DialogResult = true;
    Close();
}

private void BtnCancel_Click(object sender, RoutedEventArgs e)
{
    DialogResult = false;
    Close();
}
```

Note: The caller in MainViewModel will fix up LogPanelExpanded and LiveTerminalMode from `_settings` before saving so those fields are not lost.
  </action>
  <verify>
Build passes: `dotnet build /mnt/c/projects/GA-WsusManager/src/WsusManager.sln`
No XAML binding errors in Output window.
  </verify>
  <done>SettingsDialog.xaml and SettingsDialog.xaml.cs exist, build compiles without errors, dialog structure matches spec.</done>
</task>

<task type="auto">
  <name>Task 2: Wire OpenSettings command in MainViewModel</name>
  <files>
    src/WsusManager.App/ViewModels/MainViewModel.cs
  </files>
  <action>
Replace the current "Settings" nav button behavior (which just calls Navigate("Settings") → generic placeholder panel) with a proper modal dialog flow. The nav button already calls `NavigateCommand` with "Settings" — we need to intercept this at the Settings case.

**Changes to MainViewModel.cs:**

1. **Add `OpenSettings` RelayCommand** (does NOT use CanExecute restriction — settings must always be accessible):

```csharp
[RelayCommand]
private async Task OpenSettings()
{
    var dialog = new SettingsDialog(_settings);
    if (Application.Current.MainWindow is not null)
        dialog.Owner = Application.Current.MainWindow;

    if (dialog.ShowDialog() != true || dialog.Result is null) return;

    var updated = dialog.Result;

    // Preserve fields not shown in dialog
    updated.LogPanelExpanded = _settings.LogPanelExpanded;
    updated.LiveTerminalMode = _settings.LiveTerminalMode;

    // Check if refresh interval changed (need timer restart)
    var intervalChanged = updated.RefreshIntervalSeconds != _settings.RefreshIntervalSeconds;

    // Apply in-memory
    _settings = updated;
    ApplySettings(_settings);

    // Restart timer if interval changed
    if (intervalChanged)
    {
        StopRefreshTimer();
        StartRefreshTimer();
    }

    // Persist to disk
    await SaveSettingsAsync();

    // Refresh dashboard so new paths/mode take effect immediately
    await RefreshDashboard();

    AppendLog($"Settings saved. Server mode: {_settings.ServerMode}, Refresh: {_settings.RefreshIntervalSeconds}s");
}
```

2. **Update Navigate() method** — in the "Settings" case, call OpenSettings instead of navigating:

In the `Navigate(string panel)` method, add a guard at the top:
```csharp
private void Navigate(string panel)
{
    // Settings opens a dialog, not a panel
    if (panel == "Settings")
    {
        _ = OpenSettings();
        return;
    }
    // ... existing code ...
}
```

3. **Update `NotifyCommandCanExecuteChanged()`** — add `OpenSettingsCommand.NotifyCanExecuteChanged();` so it's included in the standard notifications (though it has no CanExecute restriction).

**Important:** Do NOT change MainWindow.xaml — the sidebar "Settings" button already calls `NavigateCommand` with parameter "Settings" and Navigate() will now redirect it to OpenSettings(). No XAML change needed.
  </action>
  <verify>
Build passes: `dotnet build /mnt/c/projects/GA-WsusManager/src/WsusManager.sln`
Smoke test: `dotnet run --project /mnt/c/projects/GA-WsusManager/src/WsusManager.App` — clicking Settings sidebar button opens a dialog with editable fields (not the "future update" placeholder).
  </verify>
  <done>
Clicking Settings in sidebar opens SettingsDialog with populated fields. Editing values and clicking Save: (a) closes dialog, (b) dashboard Configuration section reflects new values, (c) settings.json is updated on disk, (d) no restart required.
  </done>
</task>

</tasks>

<verification>
- `dotnet build /mnt/c/projects/GA-WsusManager/src/WsusManager.sln` passes with zero errors
- SettingsDialog.xaml exists at `src/WsusManager.App/Views/`
- MainViewModel.cs contains `OpenSettings` RelayCommand
- Navigate("Settings") redirects to dialog (no panel navigation)
- ESC key closes the dialog
- Save validates refresh interval >= 5 before accepting
- Saved settings survive a dashboard refresh (no revert to old values)
</verification>

<success_criteria>
1. Admin opens Settings from sidebar — a modal dialog appears (not the generic placeholder panel)
2. Dialog shows current values in editable TextBoxes and ComboBox
3. Changing ContentPath and clicking Save → dashboard Configuration section updates immediately
4. Changing RefreshIntervalSeconds → timer restarts with new interval (no app restart)
5. settings.json on disk reflects the new values
6. ESC key closes the dialog without saving
</success_criteria>

<output>
After completion, create `.planning/phases/12-settings-and-mode-override/12-01-SUMMARY.md`
</output>
