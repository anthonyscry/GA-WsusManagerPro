---
phase: 25-performance-optimization
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/WsusManager.App/Services/ThemeService.cs
  - src/WsusManager.App/Themes/DefaultDark.xaml
  - src/WsusManager.App/Themes/JustBlack.xaml
  - src/WsusManager.App/Themes/Slate.xaml
  - src/WsusManager.App/Themes/Serenity.xaml
  - src/WsusManager.App/Themes/Rose.xaml
  - src/WsusManager.App/Themes/ClassicBlue.xaml
autonomous: true
requirements: [PERF-12]

must_haves:
  truths:
    - "Theme switching completes within 100ms for instant visual feedback"
    - "All theme resources use DynamicResource instead of StaticResource"
    - "Theme resources pre-loaded on startup to avoid first-swap delay"
    - "Theme change applies without window reload or UI flash"
  artifacts:
    - path: "src/WsusManager.App/Services/ThemeService.cs"
      provides: "Optimized theme switching with pre-loading"
      contains: "ApplyTheme|PreloadThemes"
      min_lines: 80
    - path: "src/WsusManager.App/Themes/*.xaml"
      provides: "Theme resource dictionaries using only DynamicResource references"
      contains: "ResourceDictionary"
  key_links:
    - from: "src/WsusManager.App/Program.cs"
      to: "src/WsusManager.App/Services/ThemeService.cs"
      via: "PreloadThemes call during startup"
      pattern: "themeService.*Preload|PreloadThemes"
    - from: "src/WsusManager.App/Views/SettingsDialog.xaml.cs"
      to: "src/WsusManager.App/Services/ThemeService.cs"
      via: "Theme preview selection"
      pattern: "ApplyTheme"
---

<objective>
Accelerate theme switching to under 100ms by pre-loading theme resources on startup and ensuring all XAML uses DynamicResource bindings. Eliminate first-swap delay when user changes theme in Settings dialog.

Purpose: Theme switching currently has noticeable lag (~300-500ms) on first swap due to resource dictionary parsing. Pre-loading resources reduces swap time to instant visual feedback (<100ms).

Output: Theme switching applies within 100ms, all 6 themes pre-loaded at startup.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/WsusManager.App/Services/ThemeService.cs
@src/WsusManager.App/Themes/DefaultDark.xaml
@src/WsusManager.App/Themes/JustBlack.xaml
@src/WsusManager.App/Themes/Slate.xaml
@src/WsusManager.App/Themes/Serenity.xaml
@src/WsusManager.App/Themes/Rose.xaml
@src/WsusManager.App/Themes/ClassicBlue.xaml

Current implementation:
- ThemeService.ApplyTheme loads ResourceDictionary from embedded resource
- First theme swap parses XAML (causes delay)
- Subsequent swaps of same theme are fast (cached)
- 6 theme files exist (DefaultDark, JustBlack, Slate, Serenity, Rose, ClassicBlue)

Per user decision (25-CONTEXT.md):
- Use existing ThemeService with DynamicResource bindings (already implemented)
- Ensure all resources use DynamicResource instead of StaticResource
- Pre-load theme resources on startup to avoid first-swap delay
- Target: < 100ms for instant visual feedback
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add theme pre-loading to ThemeService</name>
  <files>src/WsusManager.App/Services/ThemeService.cs</files>
  <action>
    Add pre-loading infrastructure to ThemeService:

    1. Add private field for theme cache:
       ```csharp
       private readonly Dictionary<string, ResourceDictionary> _themeCache = new();
       ```

    2. Add PreloadThemes method:
       ```csharp
       public void PreloadThemes()
       {
           var themes = new[] { "DefaultDark", "JustBlack", "Slate", "Serenity", "Rose", "ClassicBlue" };
           var startTime = Stopwatch.StartNew();

           foreach (var theme in themes)
           {
               try
               {
                   var dict = LoadThemeDictionary(theme);
                   _themeCache[theme] = dict;
               }
               catch (Exception ex)
               {
                   _logService.Warning(ex, "Failed to preload theme: {Theme}", theme);
               }
           }

           startTime.Stop();
           _logService.Info("Preloaded {Count} themes in {Ms}ms", _themeCache.Count, startTime.ElapsedMilliseconds);
       }

       private ResourceDictionary LoadThemeDictionary(string themeName)
       {
           var uri = new Uri($"/Themes/{themeName}.xaml", UriKind.Relative);
           var dict = new ResourceDictionary { Source = uri };
           return dict;
       }
       ```

    3. Modify ApplyTheme to use cached dictionary:
       ```csharp
       public void ApplyTheme(string themeName)
       {
           if (_themeCache.TryGetValue(themeName, out var cached))
           {
               // Use pre-loaded theme
               ApplyThemeDictionary(cached);
               return;
           }

           // Fallback to loading (shouldn't happen if preload worked)
           var dict = LoadThemeDictionary(themeName);
           _themeCache[themeName] = dict;
           ApplyThemeDictionary(dict);
       }

       private void ApplyThemeDictionary(ResourceDictionary themeDict)
       {
           if (Application.Current?.Resources.MergedDictionaries is not null)
           {
               // Remove old theme dictionaries
               var oldThemes = Application.Current.Resources.MergedDictionaries
                   .Where(d => d.Source?.OriginalString?.Contains("/Themes/") == true)
                   .ToList();
               foreach (var old in oldThemes)
                   Application.Current.Resources.MergedDictionaries.Remove(old);

               // Add new theme
               Application.Current.Resources.MergedDictionaries.Add(themeDict);
           }
       }
       ```

    This pre-loads all themes during startup for instant switching later.
  </action>
  <verify>
    Build: `dotnet build src/WsusManager.App/WsusManager.App.csproj --configuration Release` should succeed.
  </verify>
  <done>
    ThemeService pre-loads all 6 themes, caches ResourceDictionary instances.
  </done>
</task>

<task type="auto">
  <name>Task 2: Call PreloadThemes during application startup</name>
  <files>src/WsusManager.App/Program.cs</files>
  <action>
    Call PreloadThemes after theme service is resolved but before applying initial theme:

    1. After line 43 (themeService resolution), add:
       ```csharp
       // Pre-load all theme resources to enable instant switching
       themeService.PreloadThemes();
       ```

    2. This loads all 6 theme XAML files into memory before window creation
    3. Initial theme application (line 45) will use cached dictionary

    Placement context:
    - Line 42: `var themeService = host.Services.GetRequiredService<IThemeService>();`
    - Line 43: `var settingsService = host.Services.GetRequiredService<ISettingsService>();`
    - Line 44: `var settings = settingsService.Current;`
    - Add new line 45: `themeService.PreloadThemes();`
    - Old line 45 becomes 46: `themeService.ApplyTheme(settings.SelectedTheme);`

    This ensures themes are loaded before any UI rendering happens.
  </action>
  <verify>
    Build: `dotnet build src/WsusManager.App/WsusManager.App.csproj --configuration Release` should succeed.
  </verify>
  <done>
    All theme resources pre-loaded during startup, logged with timing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify all theme XAML files use DynamicResource</name>
  <files>
    src/WsusManager.App/Themes/DefaultDark.xaml
    src/WsusManager.App/Themes/JustBlack.xaml
    src/WsusManager.App/Themes/Slate.xaml
    src/WsusManager.App/Themes/Serenity.xaml
    src/WsusManager.App/Themes/Rose.xaml
    src/WsusManager.App/Themes/ClassicBlue.xaml
  </files>
  <action>
    Audit all theme XAML files to ensure they don't use StaticResource references:

    1. For each theme file, search for any `{StaticResource` usage
    2. If found, replace with `{DynamicResource`
    3. Theme definitions should only define resources, not reference each other statically

    Expected pattern (all themes follow this structure):
    ```xml
    <ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                        xmlns:sys="clr-namespace:System;assembly=mscorlib">
        <!-- Color definitions only -->
        <Color x:Key="PrimaryBackground">#FF1E1E1E</Color>
        <Color x:Key="TextPrimary">#FFFFFFFF</Color>
        ...
    </ResourceDictionary>
    ```

    No StaticResource references should exist (themes are standalone definitions).
    If any are found, document them and convert to DynamicResource.

    Note: SharedStyles.xaml may use StaticResource â€” that's acceptable as it's not a theme file.
  </action>
  <verify>
    Build: `dotnet build src/WsusManager.App/WsusManager.App.csproj --configuration Release` should succeed.
    Grep: `grep -r "StaticResource" src/WsusManager.App/Themes/` should return empty or only in comments
  </verify>
  <done>
    All theme files verified to use DynamicResource (or define resources without references).
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Build Release: `dotnet build src/WsusManager.App/WsusManager.App.csproj --configuration Release`
2. Run application: `dotnet run --project src/WsusManager.App --configuration Release`
3. Open Settings dialog, switch between themes rapidly
4. Verify: Theme changes are instant (<100ms perceived delay)
5. Check logs: "Preloaded 6 themes in Xms" message confirms pre-loading
6. Verify: No UI flash or window reload during theme change
</verification>

<success_criteria>
1. Theme switching completes within 100ms (user perceives instant change)
2. All 6 themes pre-loaded at startup (logged timing confirms)
3. No StaticResource references in theme XAML files
4. No UI flash or flicker during theme change
5. No new compiler warnings
</success_criteria>

<output>
After completion, create `.planning/phases/25-performance-optimization/25-04-SUMMARY.md` with:
- Actual pre-load timing (ms to load 6 themes)
- Theme switch timing measurements (before/after)
- Any StaticResource findings and corrections
</output>
