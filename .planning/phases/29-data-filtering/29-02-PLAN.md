---
phase: 29-data-filtering
plan: 02
type: execute
wave: 1
depends_on:
  - 29-01
files_modified:
  - src/WsusManager.App/Views/MainWindow.xaml
  - src/WsusManager.App/ViewModels/MainViewModel.cs
  - src/WsusManager.Core/Models/AppSettings.cs
  - src/WsusManager.Tests/ViewModels/MainViewModelTests.cs
autonomous: true
requirements:
  - DAT-02
  - DAT-03

must_haves:
  truths:
    - "Updates panel shows approval status filter ComboBox (All/Approved/Not Approved/Declined)"
    - "Updates panel shows classification filter ComboBox (All/Critical/Security/Definition/Updates)"
    - "Updates panel shows search TextBox with 300ms debounce for KB/title search"
    - "Multiple filters combine with AND logic (e.g., Approved AND Critical)"
    - "Search matches KB number, title, classification, and approval status (case-insensitive)"
    - "Clear filters button resets both ComboBoxes and search TextBox"
    - "Empty state shows 'No items match your current filters' when filter results empty"
    - "Filters persist to AppSettings and restore on startup"
  artifacts:
    - path: "src/WsusManager.App/Views/MainWindow.xaml"
      provides: "Updates panel filter UI (approval ComboBox, classification ComboBox, search TextBox, clear button)"
      contains: "ApprovalFilterComboBox, ClassificationFilterComboBox, UpdateSearchTextBox, ClearUpdateFiltersButton"
    - path: "src/WsusManager.App/ViewModels/MainViewModel.cs"
      provides: "Filter properties, debounce timer, CollectionView filter logic for updates"
      contains: "UpdateApprovalFilter, UpdateClassificationFilter, UpdateSearchText, _updateSearchDebounceTimer"
    - path: "src/WsusManager.Core/Models/AppSettings.cs"
      provides: "Filter persistence properties for updates"
      contains: "UpdateApprovalFilter, UpdateClassificationFilter, UpdateSearchText"
  key_links:
    - from: "UpdateApprovalFilter property"
      to: "AppSettings.UpdateApprovalFilter"
      via: "settings persistence on property change"
      pattern: "settings save"
    - from: "UpdateClassificationFilter property"
      to: "AppSettings.UpdateClassificationFilter"
      via: "settings persistence on property change"
      pattern: "settings save"
    - from: "Filter controls"
      to: "CollectionView.GetDefaultView(FilteredUpdates).Filter"
      via: "Refresh() call on filter change"
      pattern: "CollectionView filtering"
---

<objective>
Add filter UI controls to the Updates panel with approval status filter, classification filter, real-time search box with 300ms debounce, multi-filter AND logic, CollectionView-based filtering, and filter persistence to AppSettings. Filters work instantly without an Apply button, and show clear empty state when no items match.

Purpose: Users need to quickly find updates by approval status (Approved/Not Approved/Declined), classification (Critical/Security/Definition/Updates), or search by KB number/title. Multi-filter AND logic enables precise queries like "show all approved critical updates". Real-time filtering with debounce provides responsive search without UI flickering.

Output: Updates panel with filter row (approval ComboBox + classification ComboBox + search TextBox + clear button), working filters with CollectionView multi-filter logic, debounce timer, filter persistence, empty state UI, and unit tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/29-data-filtering/29-CONTEXT.md
@.planning/phases/29-data-filtering/29-01-PLAN.md
@src/WsusManager.App/Views/MainWindow.xaml
@src/WsusManager.App/ViewModels/MainViewModel.cs
@src/WsusManager.Core/Models/AppSettings.cs
@src/WsusManager.Core/Models/UpdateInfo.cs
</context>

<tasks>

<task type="auto">
  <name>Add update filter properties to AppSettings</name>
  <files>src/WsusManager.Core/Models/AppSettings.cs</files>
  <action>
    Add to src/WsusManager.Core/Models/AppSettings.cs (in the BEHAVIOR SETTINGS section, after ComputerSearchText):

    ```csharp
    /// <summary>Last selected approval filter for Updates panel.</summary>
    [JsonPropertyName("updateApprovalFilter")]
    public string UpdateApprovalFilter { get; set; } = "All";

    /// <summary>Last selected classification filter for Updates panel.</summary>
    [JsonPropertyName("updateClassificationFilter")]
    public string UpdateClassificationFilter { get; set; } = "All";

    /// <summary>Last search text for Updates panel.</summary>
    [JsonPropertyName("updateSearchText")]
    public string UpdateSearchText { get; set; } = string.Empty;
    ```

    DO NOT: Change existing filter properties - only add update-specific ones
  </action>
  <verify>
    dotnet build src/WsusManager.Core succeeds
  </verify>
  <done>
    AppSettings.cs has UpdateApprovalFilter, UpdateClassificationFilter, and UpdateSearchText properties with JsonPropertyName attributes for JSON persistence
  </done>
</task>

<task type="auto">
  <name>Add update filter properties to MainViewModel</name>
  <files>src/WsusManager.App/ViewModels/MainViewModel.cs</files>
  <action>
    Add to MainViewModel.cs (in the DATA FILTERING section, after computer filters):

    ```csharp
    // ═══════════════════════════════════════════════════════════════
    // DATA FILTERING - Updates Panel
    // ═══════════════════════════════════════════════════════════════

    /// <summary>Selected approval filter for Updates panel.</summary>
    [ObservableProperty]
    private string _updateApprovalFilter = "All";

    /// <summary>Selected classification filter for Updates panel.</summary>
    [ObservableProperty]
    private string _updateClassificationFilter = "All";

    /// <summary>Search text for Updates panel (debounced).</summary>
    [ObservableProperty]
    private string _updateSearchText = string.Empty;

    /// <summary>Debounce timer for update search input (300ms).</summary>
    private DispatcherTimer? _updateSearchDebounceTimer;

    /// <summary>Whether to show the Clear Filters button (any filter active).</summary>
    public bool ShowClearUpdateFilters =>
        !string.Equals(UpdateApprovalFilter, "All", StringComparison.Ordinal) ||
        !string.Equals(UpdateClassificationFilter, "All", StringComparison.Ordinal) ||
        !string.IsNullOrWhiteSpace(UpdateSearchText);

    /// <summary>Number of visible items after filtering.</summary>
    public int UpdateVisibleCount => FilteredUpdates.Count;

    /// <summary>Text showing filter count (e.g., "45 of 300 updates visible").</summary>
    public string UpdateFilterCountText =>
        FilteredUpdates.Count == UpdateInfo.All.Count
            ? $"{FilteredUpdates.Count} updates"
            : $"{FilteredUpdates.Count} of {UpdateInfo.All.Count} visible";
    ```

    NOTE: UpdateInfo.All is a placeholder - in a later task we'll populate this from the WSUS database.

    DO NOT: Add OnChanged handlers yet - that's the next task
  </action>
  <verify>
    dotnet build src/WsusManager.App succeeds
  </verify>
  <done>
    MainViewModel.cs has UpdateApprovalFilter, UpdateClassificationFilter, UpdateSearchText properties with ObservableProperty attribute, _updateSearchDebounceTimer field, ShowClearUpdateFilters computed property, UpdateVisibleCount computed property, and UpdateFilterCountText computed property
  </done>
</task>

<task type="auto">
  <name>Add update filter change handlers and logic</name>
  <files>src/WsusManager.App/ViewModels/MainViewModel.cs</files>
  <action>
    Add to MainViewModel.cs (after the property declarations from previous task):

    ```csharp
    partial void OnUpdateApprovalFilterChanged(string value)
    {
        ApplyUpdateFilters();
        SaveUpdateFilterSettings();
    }

    partial void OnUpdateClassificationFilterChanged(string value)
    {
        ApplyUpdateFilters();
        SaveUpdateFilterSettings();
    }

    partial void OnUpdateSearchTextChanged(string value)
    {
        // Reset or start debounce timer
        _updateSearchDebounceTimer?.Stop();
        _updateSearchDebounceTimer = new DispatcherTimer
        {
            Interval = TimeSpan.FromMilliseconds(300)
        };
        _updateSearchDebounceTimer.Tick += (s, e) =>
        {
            _updateSearchDebounceTimer?.Stop();
            ApplyUpdateFilters();
            SaveUpdateFilterSettings();
        };
        _updateSearchDebounceTimer.Start();

        // Update status text to show "(filtering...)"
        if (!string.IsNullOrWhiteSpace(value))
        {
            _logService?.LogDebug("(filtering...)");
        }
    }

    private void ApplyUpdateFilters()
    {
        var view = CollectionViewSource.GetDefaultView(FilteredUpdates);
        view.Filter = (obj) =>
        {
            if (obj is not UpdateInfo update) return false;

            // Approval filter (combines IsApproved and IsDeclined)
            if (!string.Equals(UpdateApprovalFilter, "All", StringComparison.Ordinal))
            {
                bool matchesApproval = UpdateApprovalFilter switch
                {
                    "Approved" => update.IsApproved && !update.IsDeclined,
                    "Not Approved" => !update.IsApproved && !update.IsDeclined,
                    "Declined" => update.IsDeclined,
                    _ => true
                };
                if (!matchesApproval) return false;
            }

            // Classification filter
            if (!string.Equals(UpdateClassificationFilter, "All", StringComparison.Ordinal))
            {
                // Handle both classification string formats
                var classification = update.Classification?.ToLowerInvariant() ?? "";
                var filter = UpdateClassificationFilter.ToLowerInvariant();

                // Exact match or partial match (e.g., "Critical" matches "Critical Updates")
                if (!classification.Contains(filter))
                    return false;
            }

            // Search filter (case-insensitive substring across multiple fields)
            if (!string.IsNullOrWhiteSpace(UpdateSearchText))
            {
                var search = UpdateSearchText.ToLowerInvariant();
                var match = (update.Title?.ToLowerInvariant().Contains(search) ?? false) ||
                           (update.KbArticle?.ToLowerInvariant().Contains(search) ?? false) ||
                           (update.Classification?.ToLowerInvariant().Contains(search) ?? false) ||
                           (update.IsApproved && "approved".Contains(search)) ||
                           (update.IsDeclined && "declined".Contains(search));
                if (!match) return false;
            }

            return true;
        };
        view.Refresh();

        // Notify UI updates
        OnPropertyChanged(nameof(ShowClearUpdateFilters));
        OnPropertyChanged(nameof(UpdateVisibleCount));
        OnPropertyChanged(nameof(UpdateFilterCountText));
    }

    private void SaveUpdateFilterSettings()
    {
        _settingsService.UpdateSettings(s =>
        {
            s.UpdateApprovalFilter = UpdateApprovalFilter;
            s.UpdateClassificationFilter = UpdateClassificationFilter;
            s.UpdateSearchText = UpdateSearchText;
        });
    }

    [RelayCommand]
    private void ClearUpdateFilters()
    {
        UpdateApprovalFilter = "All";
        UpdateClassificationFilter = "All";
        UpdateSearchText = string.Empty;
        _updateSearchDebounceTimer?.Stop();
        ApplyUpdateFilters();
        SaveUpdateFilterSettings();
    }
    ```

    DO NOT: Call LoadUpdatesAsync in this task - that's in a later phase
  </action>
  <verify>
    dotnet build src/WsusManager.App succeeds
  </verify>
  <done>
    MainViewModel.cs has OnUpdateApprovalFilterChanged, OnUpdateClassificationFilterChanged, OnUpdateSearchTextChanged with 300ms debounce timer, ApplyUpdateFilters with multi-filter AND logic (approval + classification + search), SaveUpdateFilterSettings, and ClearUpdateFiltersCommand.
  </done>
</task>

<task type="auto">
  <name>Add Updates panel with filter UI to MainWindow.xaml</name>
  <files>src/WsusManager.App/Views/MainWindow.xaml</files>
  <action>
    Add the Updates panel to MainWindow.xaml after the Computers panel from 29-01:

    ```xml
    <!-- Updates Panel (Phase 29) -->
    <Border x:Name="UpdatesPanel"
            automation:AutomationProperties.AutomationId="UpdatesPanel"
            Visibility="{Binding IsUpdatesPanelVisible}">
        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
            <StackPanel>

                <!-- Filter Row -->
                <StackPanel Style="{StaticResource FilterRow}">
                    <!-- Approval Filter -->
                    <TextBlock Text="Approval:"
                               Foreground="{DynamicResource TextSecondary}"
                               FontSize="12"
                               VerticalAlignment="Center"
                               Margin="0,0,6,0"/>
                    <ComboBox Style="{StaticResource FilterComboBox}"
                              SelectedItem="{Binding UpdateApprovalFilter}"
                              Width="140">
                        <ComboBoxItem Content="All"/>
                        <ComboBoxItem Content="Approved"/>
                        <ComboBoxItem Content="Not Approved"/>
                        <ComboBoxItem Content="Declined"/>
                    </ComboBox>

                    <!-- Classification Filter -->
                    <TextBlock Text="Class:"
                               Foreground="{DynamicResource TextSecondary}"
                               FontSize="12"
                               VerticalAlignment="Center"
                               Margin="12,0,6,0"/>
                    <ComboBox Style="{StaticResource FilterComboBox}"
                              SelectedItem="{Binding UpdateClassificationFilter}"
                              Width="120">
                        <ComboBoxItem Content="All"/>
                        <ComboBoxItem Content="Critical"/>
                        <ComboBoxItem Content="Security"/>
                        <ComboBoxItem Content="Definition"/>
                        <ComboBoxItem Content="Updates"/>
                    </ComboBox>

                    <!-- Search Box -->
                    <TextBox Style="{StaticResource FilterSearchBox}"
                             Text="{Binding UpdateSearchText, UpdateSourceTrigger=PropertyChanged}"
                             automation:AutomationProperties.AutomationId="UpdateSearchTextBox"
                             Margin="12,0,0,0">
                        <TextBox.InputBindings>
                            <KeyBinding Key="Escape" Command="{Binding ClearUpdateFiltersCommand}"/>
                        </TextBox.InputBindings>
                    </TextBox>

                    <!-- Clear Filters Button -->
                    <Button Content="Clear Filters"
                            Style="{StaticResource ClearFiltersButton}"
                            Command="{Binding ClearUpdateFiltersCommand}"
                            Visibility="{Binding ShowClearUpdateFilters, Converter={StaticResource BoolToVisibilityConverter}}"
                            automation:AutomationProperties.AutomationId="ClearUpdateFiltersButton"/>
                </StackPanel>

                <!-- Filter Count Text -->
                <TextBlock Text="{Binding UpdateFilterCountText}"
                           Foreground="{DynamicResource TextMuted}"
                           FontSize="11"
                           Margin="0,0,0,12"/>

                <!-- Updates ListView (virtualized) -->
                <Border Background="{DynamicResource InputBackground}"
                        BorderBrush="{DynamicResource BorderPrimary}"
                        BorderThickness="1"
                        CornerRadius="4"
                        MinHeight="300">
                    <ListView x:Name="UpdatesListView"
                              ItemsSource="{Binding FilteredUpdates}"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                              Background="Transparent"
                              BorderThickness="0"
                              automation:AutomationProperties.AutomationId="UpdatesListView">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="KB Article" Width="100">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding KbArticle, StringFormat='{}KB{0}'}"
                                                       Foreground="{DynamicResource TextPrimary}"
                                                       FontSize="12"
                                                       TextTrimming="CharacterEllipsis"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Title" Width="400">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Title}"
                                                       Foreground="{DynamicResource TextPrimary}"
                                                       FontSize="12"
                                                       TextTrimming="CharacterEllipsis"
                                                       ToolTip="{Binding Title}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Classification" Width="120">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Classification}"
                                                       Foreground="{DynamicResource TextSecondary}"
                                                       FontSize="12"
                                                       TextTrimming="CharacterEllipsis"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Status" Width="100">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock>
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="FontSize" Value="12"/>
                                                        <Setter Property="Foreground" Value="{DynamicResource TextSecondary}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsApproved}" Value="True">
                                                                <Setter Property="Foreground" Value="{DynamicResource StatusSuccess}"/>
                                                                <Setter Property="Text" Value="Approved"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding IsDeclined}" Value="True">
                                                                <Setter Property="Foreground" Value="{DynamicResource StatusError}"/>
                                                                <Setter Property="Text" Value="Declined"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding IsApproved}" Value="False">
                                                                <DataTrigger Binding="{Binding IsDeclined}" Value="False">
                                                                    <Setter Property="Text" Value="Not Approved"/>
                                                                </DataTrigger>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Date" Width="100">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding ApprovalDate, StringFormat='{}{0:yyyy-MM-dd}'}"
                                                       Foreground="{DynamicResource TextSecondary}"
                                                       FontSize="12"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                            </GridView>
                        </ListView.View>

                        <!-- Empty State -->
                        <ListView.Style>
                            <Style TargetType="ListView" BasedOn="{StaticResource {x:Type ListView}}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding FilteredUpdates.Count}" Value="0">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ListView">
                                                    <TextBlock Text="No items match your current filters"
                                                               Style="{StaticResource EmptyStateText}"/>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ListView.Style>
                    </ListView>
                </Border>

            </StackPanel>
        </ScrollViewer>
    </Border>
    ```

    Also add the visibility property to MainViewModel.cs:

    ```csharp
    public Visibility IsUpdatesPanelVisible =>
        string.Equals(CurrentPanel, "Updates", StringComparison.Ordinal)
            ? Visibility.Visible
            : Visibility.Collapsed;
    ```

    And update the Navigate method to handle the Updates panel:

    ```csharp
    OnPropertyChanged(nameof(IsUpdatesPanelVisible));
    ```

    DO NOT: Add navigation button yet - that's optional for this phase
  </action>
  <verify>
    dotnet build src/WsusManager.App succeeds
    MainWindow.xaml has UpdatesPanel with filter row (approval ComboBox + classification ComboBox + search TextBox + clear button), filter count text, and virtualized ListView with GridView columns
  </verify>
  <done>
    MainWindow.xaml has Updates panel with filter UI controls (approval ComboBox, classification ComboBox, search TextBox, clear button), filter count text, virtualized ListView with GridView showing KB Article, Title, Classification, Status (color-coded Approved/Not Approved/Declined), Date, empty state template with "No items match your current filters" message, and proper binding to all ViewModel properties.
  </done>
</task>

<task type="auto">
  <name>Update InitializeFiltersAsync to restore update filters</name>
  <files>src/WsusManager.App/ViewModels/MainViewModel.cs</files>
  <action>
    Update the InitializeFiltersAsync method in MainViewModel.cs to also restore update filters:

    ```csharp
    private async Task InitializeFiltersAsync()
    {
        var settings = _settingsService.GetSettings();

        // Restore Computers filters
        ComputerStatusFilter = settings.ComputerStatusFilter ?? "All";
        ComputerSearchText = settings.ComputerSearchText ?? string.Empty;

        // Restore Updates filters
        UpdateApprovalFilter = settings.UpdateApprovalFilter ?? "All";
        UpdateClassificationFilter = settings.UpdateClassificationFilter ?? "All";
        UpdateSearchText = settings.UpdateSearchText ?? string.Empty;

        await Task.CompletedTask.ConfigureAwait(false);
    }
    ```

    DO NOT: Apply filters before data is loaded - LoadUpdatesAsync should call ApplyUpdateFilters after populating the collection
  </action>
  <verify>
    dotnet build src/WsusManager.App succeeds
  </verify>
  <done>
    InitializeFiltersAsync method restores UpdateApprovalFilter, UpdateClassificationFilter, and UpdateSearchText from AppSettings on startup with proper null coalescing defaults.
  </done>
</task>

<task type="auto">
  <name>Add unit tests for update filter logic</name>
  <files>src/WsusManager.Tests/ViewModels/MainViewModelTests.cs</files>
  <action>
    Add unit tests for the update filter logic to src/WsusManager.Tests/ViewModels/MainViewModelTests.cs:

    ```csharp
    [Fact]
    public void UpdateApprovalFilter_WhenSetToApproved_ShowsOnlyApprovedUpdates()
    {
        // Arrange
        var viewModel = _serviceProvider.GetRequiredService<MainViewModel>();
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034441", "Security Update", "Security",
            DateTime.Now, true, false));
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034442", "Critical Update", "Critical",
            DateTime.Now, false, false));

        // Act
        viewModel.UpdateApprovalFilter = "Approved";

        // Assert
        var view = CollectionViewSource.GetDefaultView(viewModel.FilteredUpdates);
        view.Refresh();
        Assert.Single(viewModel.FilteredUpdates);
        Assert.True(viewModel.FilteredUpdates.First().IsApproved);
    }

    [Fact]
    public void UpdateClassificationFilter_WhenSetToCritical_ShowsOnlyCriticalUpdates()
    {
        // Arrange
        var viewModel = _serviceProvider.GetRequiredService<MainViewModel>();
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034441", "Security Update", "Security",
            DateTime.Now, true, false));
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034442", "Critical Update", "Critical",
            DateTime.Now, false, false));

        // Act
        viewModel.UpdateClassificationFilter = "Critical";

        // Assert
        var view = CollectionViewSource.GetDefaultView(viewModel.FilteredUpdates);
        view.Refresh();
        Assert.Single(viewModel.FilteredUpdates);
        Assert.Contains("Critical", viewModel.FilteredUpdates.First().Classification);
    }

    [Fact]
    public void UpdateFilters_CombineWithANDLogic()
    {
        // Arrange
        var viewModel = _serviceProvider.GetRequiredService<MainViewModel>();
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034441", "Security Update", "Security",
            DateTime.Now, true, false)); // Approved + Security
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034442", "Critical Update", "Critical",
            DateTime.Now, true, false)); // Approved + Critical
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034443", "Critical Update", "Critical",
            DateTime.Now, false, false)); // Not Approved + Critical

        // Act: Filter for Approved AND Critical
        viewModel.UpdateApprovalFilter = "Approved";
        viewModel.UpdateClassificationFilter = "Critical";

        // Assert
        var view = CollectionViewSource.GetDefaultView(viewModel.FilteredUpdates);
        view.Refresh();
        Assert.Single(viewModel.FilteredUpdates);
        var result = viewModel.FilteredUpdates.First();
        Assert.True(result.IsApproved);
        Assert.Contains("Critical", result.Classification);
    }

    [Fact]
    public void UpdateSearchText_MatchesKbArticle()
    {
        // Arrange
        var viewModel = _serviceProvider.GetRequiredService<MainViewModel>();
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034441", "Security Update", "Security",
            DateTime.Now, true, false));
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034442", "Critical Update", "Critical",
            DateTime.Now, false, false));

        // Act
        viewModel.UpdateSearchText = "5034441";
        Thread.Sleep(350); // Wait for debounce

        // Assert
        Assert.Single(viewModel.FilteredUpdates);
        Assert.Contains("5034441", viewModel.FilteredUpdates.First().KbArticle);
    }

    [Fact]
    public void UpdateSearchText_MatchesTitle()
    {
        // Arrange
        var viewModel = _serviceProvider.GetRequiredService<MainViewModel>();
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034441", "Security Update for .NET Framework", "Security",
            DateTime.Now, true, false));
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034442", "Critical Update", "Critical",
            DateTime.Now, false, false));

        // Act
        viewModel.UpdateSearchText = ".NET";
        Thread.Sleep(350); // Wait for debounce

        // Assert
        Assert.Single(viewModel.FilteredUpdates);
        Assert.Contains(".NET", viewModel.FilteredUpdates.First().Title);
    }

    [Fact]
    public void ClearUpdateFiltersCommand_WhenExecuted_ResetsAllFilters()
    {
        // Arrange
        var viewModel = _serviceProvider.GetRequiredService<MainViewModel>();
        viewModel.FilteredUpdates.Add(new UpdateInfo(
            Guid.NewGuid(), "KB5034441", "Security Update", "Security",
            DateTime.Now, true, false));
        viewModel.UpdateApprovalFilter = "Approved";
        viewModel.UpdateClassificationFilter = "Security";
        viewModel.UpdateSearchText = "KB";

        // Act
        viewModel.ClearUpdateFiltersCommand.Execute(null);

        // Assert
        Assert.Equal("All", viewModel.UpdateApprovalFilter);
        Assert.Equal("All", viewModel.UpdateClassificationFilter);
        Assert.Empty(viewModel.UpdateSearchText);
    }

    [Fact]
    public void ShowClearUpdateFilters_WhenAnyFilterActive_ReturnsTrue()
    {
        // Arrange
        var viewModel = _serviceProvider.GetRequiredService<MainViewModel>();

        // Act & Assert - Approval filter
        viewModel.UpdateApprovalFilter = "Approved";
        Assert.True(viewModel.ShowClearUpdateFilters);

        // Act & Assert - Classification filter
        viewModel.UpdateApprovalFilter = "All";
        viewModel.UpdateClassificationFilter = "Critical";
        Assert.True(viewModel.ShowClearUpdateFilters);

        // Act & Assert - Search filter
        viewModel.UpdateClassificationFilter = "All";
        viewModel.UpdateSearchText = "test";
        Assert.True(viewModel.ShowClearUpdateFilters);

        // Act & Assert - All filters reset
        viewModel.UpdateApprovalFilter = "All";
        viewModel.UpdateClassificationFilter = "All";
        viewModel.UpdateSearchText = "";
        Assert.False(viewModel.ShowClearUpdateFilters);
    }
    ```

    DO NOT: Test LoadUpdatesAsync - that's in a later phase
  </action>
  <verify>
    dotnet test src/WsusManager.Tests --filter "FullyQualifiedName~Update" passes
    dotnet test src/WsusManager.Tests passes all tests
  </verify>
  <done>
    MainViewModelTests.cs has 8 new tests for update filters: UpdateApprovalFilter_WhenSetToApproved_ShowsOnlyApprovedUpdates, UpdateClassificationFilter_WhenSetToCritical_ShowsOnlyCriticalUpdates, UpdateFilters_CombineWithANDLogic, UpdateSearchText_MatchesKbArticle, UpdateSearchText_MatchesTitle, ClearUpdateFiltersCommand_WhenExecuted_ResetsAllFilters, and ShowClearUpdateFilters_WhenAnyFilterActive_ReturnsTrue (with 3 scenarios). All tests pass and verify filter logic, AND combination, search matching, clear functionality, and visibility conditions.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: dotnet build src/WsusManager.App
2. Build succeeds: dotnet build src/WsusManager.Core
3. Tests pass: dotnet test src/WsusManager.Tests
4. AppSettings.cs has UpdateApprovalFilter, UpdateClassificationFilter, UpdateSearchText properties
5. MainViewModel has UpdateApprovalFilter, UpdateClassificationFilter, UpdateSearchText properties with OnChanged handlers
6. MainViewModel has _updateSearchDebounceTimer with 300ms interval
7. MainViewModel has ApplyUpdateFilters method with multi-filter AND logic
8. MainViewModel has ClearUpdateFiltersCommand
9. MainWindow.xaml has Updates panel with filter UI (approval ComboBox + classification ComboBox + search TextBox + clear button)
10. MainWindow.xaml has virtualized ListView with GridView columns (KB, Title, Classification, Status, Date)
11. MainWindow.xaml has empty state template when FilteredUpdates.Count is 0
12. Filters restore from AppSettings on startup via InitializeFiltersAsync
13. ShowClearUpdateFilters returns true when any filter is active
14. Multi-filter AND logic works correctly (e.g., Approved AND Critical)
15. Search matches KB article, title, classification, and status fields
16. Unit tests cover approval filter, classification filter, AND logic, search matching, clear, and visibility
</verification>

<success_criteria>
DAT-02: Updates panel has approval status filter (All/Approved/Not Approved/Declined) and classification filter (All/Critical/Security/Definition/Updates).
DAT-03: Updates panel has real-time search with 300ms debounce. Filters use CollectionView with multi-filter AND logic. Empty state shows when no items match. Clear button appears only when filters are active. Filters persist to AppSettings and restore on startup.
</success_criteria>

<output>
After completion, create `.planning/phases/29-data-filtering/29-02-SUMMARY.md`
</output>
