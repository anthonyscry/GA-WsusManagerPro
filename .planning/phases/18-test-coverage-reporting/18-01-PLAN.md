---
phase: 18-test-coverage-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/coverlet.runsettings
  - src/Directory.Build.props
  - .github/workflows/build-csharp.yml
  - .gitignore
autonomous: true
requirements:
  - TEST-01
  - TEST-02
  - TEST-03
user_setup: []

must_haves:
  truths:
    - "Developer can run `dotnet test` and generate HTML coverage report locally"
    - "CI/CD pipeline produces coverage HTML artifact accessible from GitHub Actions run"
    - "Coverage report shows line coverage percentage and branch coverage analysis"
    - "Build fails if coverage drops below 70% threshold"
  artifacts:
    - path: "src/coverlet.runsettings"
      provides: "Coverage collection configuration (exclusions, format, output)"
      contains: "[XPlat Code Coverage]"
    - path: "src/Directory.Build.props"
      provides: "Coverage thresholds and quality gate configuration"
      contains: "Threshold"
    - path: ".github/workflows/build-csharp.yml"
      provides: "CI coverage collection and HTML report generation"
      contains: "reportgenerator"
  key_links:
    - from: ".github/workflows/build-csharp.yml"
      to: "src/WsusManager.Tests/WsusManager.Tests.csproj"
      via: "dotnet test --collect:\"XPlat Code Coverage\""
      pattern: "--collect.*XPlat Code Coverage"
    - from: "dotnet test"
      to: "coverage.cobertura.xml"
      via: "Coverlet collector"
      pattern: "coverage\\.cobertura\\.xml"
    - from: "reportgenerator"
      to: "CoverageReport/index.html"
      via: "HTML report generation"
      pattern: "reportgenerator.*-targetdir.*CoverageReport"
---

<objective>
Set up code coverage measurement and HTML reporting infrastructure for the C# WPF application. Configure Coverlet to collect branch coverage data during test execution, generate HTML reports via ReportGenerator, set quality gates that fail builds below threshold, and integrate coverage artifacts into CI/CD pipeline.

Purpose: Enable transparent visibility into test coverage across the codebase with automated quality enforcement
Output: Working coverage infrastructure with local and CI HTML report generation
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/18-test-coverage-reporting/18-CONTEXT.md
@.planning/phases/18-test-coverage-reporting/18-RESEARCH.md
@src/WsusManager.Tests/WsusManager.Tests.csproj
@.github/workflows/build-csharp.yml
@src/Directory.Build.props
</context>

<tasks>

<task type="auto">
  <name>Configure Coverlet coverage collection with exclusions</name>
  <files>src/coverlet.runsettings</files>
  <action>
Create `src/coverlet.runsettings` file with the following configuration:

1. Set `Format` to `cobertura` for ReportGenerator compatibility
2. Add exclusions for:
   - Test assemblies: `[*Tests]*`
   - Generated code: `*.g.cs`, `*.g.i.cs`, `*.Designer.cs` via `ExcludeByFile`
   - Test attributes: `[ExcludeByAttribute]Obsolete,GeneratedCode,CompilerGenerated`
3. Set `IncludeTestAssembly` to `false` (don't cover test code)
4. Set output directory to `./coverage/` relative to test project

Use exact XML structure from research (RESEARCH.md section "Exclusions Configuration"). The file must be valid XML that dotnet test can parse with `--settings coverlet.runsettings`.

Do NOT modify existing test project file. This is a standalone configuration file that the CI will reference.
  </action>
  <verify>
Run `dotnet test src/WsusManager.Tests/WsusManager.Tests.csproj --settings src/coverlet.runsettings --collect:"XPlat Code Coverage" --configuration Release` and verify:
1. Test run completes (336 tests pass)
2. `coverage.cobertura.xml` file is generated in `src/WsusManager.Tests/TestResults/` or `src/coverage/` directory
3. XML file contains `<coverage>` root element with `line-rate` and `branch-rate` attributes
  </verify>
  <done>
Coverlet configuration file exists and generates valid Cobertura XML when tests run with coverage collection enabled
  </done>
</task>

<task type="auto">
  <name>Add coverage thresholds to enforce 70% quality gate</name>
  <files>src/Directory.Build.props</files>
  <action>
Update `src/Directory.Build.props` to add coverage threshold properties.

Add a new `<PropertyGroup>` after the existing one with:
- `CollectCoverage`: `true` (enables coverage collection by default)
- `Threshold`: `70` (minimum 70% coverage required)
- `ThresholdType`: `branch` (branch coverage per user decision in CONTEXT.md)
- `ThresholdStat`: `minimum` (each module must meet threshold)

Important: Add these as NEW properties, do not modify existing Version/AssemblyVersion/Product properties. The thresholds will apply to all projects but will only be enforced during test runs with coverage collection.

This ensures local builds and CI both enforce the same quality standard. If current coverage is below 70%, the build will fail - this is intentional to establish the quality gate.
  </action>
  <verify>
Run `dotnet test src/WsusManager.Tests/WsusManager.Tests.csproj --collect:"XPlat Code Coverage" --configuration Release` and check:
1. If coverage >= 70%: tests pass, build succeeds
2. If coverage < 70%: tests still pass but build reports coverage gap (Coverlet outputs coverage percentage to console)
3. Output contains "line-rate" and "branch-rate" values showing actual coverage

Note: Initial coverage may be below threshold - this is expected. The threshold establishes the quality gate for future improvements.
  </verify>
  <done>
Directory.Build.props contains coverage threshold properties that enforce minimum 70% branch coverage quality gate
  </done>
</task>

<task type="auto">
  <name>Integrate ReportGenerator and HTML coverage report in CI pipeline</name>
  <files>.github/workflows/build-csharp.yml</files>
  <action>
Update `.github/workflows/build-csharp.yml` to add coverage report generation after the "Run tests" step.

Add TWO new steps after "Upload test results" (after line 67):

1. **"Generate coverage report"** step:
   - Install ReportGenerator: `dotnet tool install -g dotnet-reportgenerator-globaltool`
   - Run: `reportgenerator -reports:./src/WsusManager.Tests/TestResults/**/coverage.cobertura.xml -targetdir:./CoverageReport -reporttypes:HtmlInline`
   - Use `-reporttypes:HtmlInline` for source code highlighting (per research recommendation)

2. **"Upload coverage report"** step:
   - Use `actions/upload-artifact@v4`
   - Name: `code-coverage-report`
   - Path: `./CoverageReport/`
   - Include `if: always()` so coverage uploads even if tests fail

Modify the existing "Run tests" step (line 53-60) to add coverage collection:
- Add `--collect:"XPlat Code Coverage"` flag to the dotnet test command
- Add `--settings src/coverlet.runsettings` to use the exclusion configuration
- Keep all existing flags (`--configuration Release`, `--no-build`, `--verbosity normal`, `--logger`, `--filter`)

The test step should run coverage collection on every CI execution.
  </action>
  <verify>
Push changes to GitHub and verify Actions run completes:
1. Coverage collection runs during test step (check logs for "XPlat Code Coverage")
2. Coverage report generation step succeeds (reportgenerator output visible)
3. Coverage report artifact is uploaded (check Artifacts section in Actions run)
4. Download `code-coverage-report` artifact and verify `index.html` exists and opens in browser showing coverage visualization
  </verify>
  <done>
CI/CD pipeline generates HTML coverage reports and publishes them as GitHub Actions artifacts accessible from any build run
  </done>
</task>

<task type="auto">
  <name>Add coverage report directory to gitignore</name>
  <files>.gitignore</files>
  <action>
Update `.gitignore` to exclude coverage report directories (local and CI-generated).

Add these entries (if not already present):
- `# Coverage reports`
- `CoverageReport/`
- `src/coverage/`
- `**/coverage.cobertura.xml`

These patterns ignore both local HTML reports and the raw Cobertura XML files. We want CI artifacts (downloadable from Actions) but don't want to commit generated coverage files to the repository.
  </action>
  <verify>
Run `git status` and verify:
1. CoverageReport/ directory (if created) is not listed as untracked
2. `coverage.cobertura.xml` files are not listed as untracked
3. Only the new configuration files (coverlet.runsettings, modified Directory.Build.props, updated workflow) show as changes
  </verify>
  <done>
Coverage report directories are excluded from version control while configuration files remain tracked
  </done>
</task>

</tasks>

<verification>
## Post-Execution Verification

### Local Developer Workflow
1. Run `dotnet test src/WsusManager.Tests/WsusManager.Tests.csproj --settings src/coverlet.runsettings --collect:"XPlat Code Coverage" --configuration Release`
2. Run `reportgenerator -reports:./src/WsusManager.Tests/TestResults/**/coverage.cobertura.xml -targetdir:./CoverageReport -reporttypes:HtmlInline`
3. Open `./CoverageReport/index.html` in browser
4. Verify: Report shows line coverage % and branch coverage % per class

### CI/CD Integration
1. Push to `main` branch
2. Navigate to GitHub Actions â†’ latest build run
3. Verify "Run tests" step shows coverage collection
4. Verify "Generate coverage report" step succeeds
5. Download "code-coverage-report" artifact
6. Open `index.html` - verify coverage visualization matches local report

### Quality Gate
1. Check build logs for coverage percentage output
2. Verify threshold enforcement message appears (coverage vs 70% threshold)
3. Confirm build behavior matches expectations (pass if >=70%, report gap if <70%)
</verification>

<success_criteria>
## Phase 18 Success Criteria (Partial)

From this plan:
- [x] Developer can run `dotnet test` and generate HTML coverage report showing line/branch coverage
- [x] CI/CD pipeline produces coverage HTML artifact accessible from GitHub Actions run
- [x] Coverage report includes both line coverage percentage and branch coverage analysis

Remaining criteria (Plans 02-03):
- [ ] Edge cases (null inputs, empty collections, boundary values) are explicitly tested
- [ ] All exception handling paths have corresponding test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/18-test-coverage-reporting/18-01-SUMMARY.md` documenting:
1. Actual coverage baseline measurements (line % and branch %)
2. Any adjustments needed to thresholds (if baseline significantly different from expected)
3. ReportGenerator version installed
4. Link to sample coverage report artifact from CI run
</output>
