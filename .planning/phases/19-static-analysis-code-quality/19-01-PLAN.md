# Plan 19-01: Roslyn Analyzer Infrastructure

**Created:** 2026-02-21
**Status:** Ready for implementation
**Requirements:** QUAL-02, QUAL-06

## Objective

Establish compile-time code quality enforcement using Roslyn analyzers with centralized configuration and incremental adoption strategy.

## Success Criteria

1. Roslyn analyzers installed and configured via `Directory.Build.props`
2. Incremental adoption prevents warning fatigue
3. CI/CD pipeline fails build if analyzer warnings are present
4. Analyzer package versions pinned and documented
5. Developers see consistent analyzer results across all IDEs

## Implementation

### Step 1: Create Directory.Build.props

**Location:** `/CSharp/src/Directory.Build.props` (solution root, applies to all projects)

**Purpose:** Centralized analyzer configuration for all projects in solution

```xml
<Project>
  <PropertyGroup>
    <!-- Enable .NET SDK built-in analyzers -->
    <EnableNETAnalyzers>true</EnableNETAnalyzers>
    <AnalysisLevel>latest-recommended</AnalysisLevel>
    <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
    <TreatWarningsAsErrors>false</TreatWarningsAsErrors>

    <!-- XML documentation for Phase 20 -->
    <GenerateDocumentationFile>true</GenerateDocumentationFile>
    <NoWarn>$(NoWarn);CS1591</NoWarn>  <!-- Missing XML comments - enforce in Phase 20 -->
  </PropertyGroup>

  <ItemGroup>
    <!-- Roslynator: Refactoring suggestions and additional rules -->
    <PackageReference Include="Roslynator.Analyzers" Version="4.12.0">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>

    <!-- Meziantou.Analyzer: Security and best practices -->
    <PackageReference Include="Meziantou.Analyzer" Version="2.0.0">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>

    <!-- StyleCop.Analyzers: Style and naming conventions -->
    <PackageReference Include="StyleCop.Analyzers" Version="1.2.0-beta.556">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
  </ItemGroup>
</Project>
```

**Notes:**
- `<PrivateAssets>all</PrivateAssets>` excludes analyzers from build output (not needed at runtime)
- `AnalysisLevel=latest-recommended` uses latest rules with recommended severity
- `EnforceCodeStyleInBuild=true` enforces IDE style rules in build
- `TreatWarningsAsErrors=false` initially - elevate specific rules in Step 4

### Step 2: Configure Analyzer Rules

**Location:** `/CSharp/src/Directory.Build.rules` (new file for rule configuration)

```xml
<Project>
  <!-- Configure specific analyzer rules -->

  <!-- CA2007: Consider calling ConfigureAwait on awaited task -->
  <!-- Critical for UI thread - no deadlocks -->
  <ItemGroup>
    <PackageReference Update="Microsoft.CodeAnalysis.NetAnalyzers" Version="8.0.0">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
  </ItemGroup>

  <!-- Elevated to error after cleanup -->
  <PropertyGroup>
    <!-- Async/await critical rules (elevate to error in Step 4) -->
    <WarningsAsErrors>CA2007</WarningsAsErrors>

    <!-- Null check critical rules (elevate to error after fixes) -->
    <!-- CA1062: Validate arguments of public methods -->
    <!-- CA1060: Move pinvokes to NativeMethods class -->
  </PropertyGroup>
</Project>
```

### Step 3: Incremental Adoption Strategy

**Phase 1a: SDK Analyzers Only**
- Enable `EnableNETAnalyzers` with `AnalysisLevel=latest-recommended`
- Run `dotnet build --configuration Release` and document warning count
- Fix critical warnings (CA2007 async, CA1062 null checks)
- Expected: 20-50 warnings initially

**Phase 1b: Add Roslynator**
- Add `Roslynator.Analyzers` package
- Run build and document new warnings
- Fix high-severity warnings (RCS1000+ series)
- Expected: +30-60 new warnings

**Phase 1c: Add Meziantou and StyleCop**
- Add `Meziantou.Analyzer` and `StyleCop.Analyzers` packages
- Run build and document new warnings
- Fix security and style warnings
- Expected: +40-80 new warnings

**Final Phase: Evaluate and Elevate**
- Review remaining warnings
- Elevate critical rules to `WarningsAsErrors`
- Suppress false positives with `[SuppressMessage]`
- Document rule suppressions with justification

### Step 4: CI/CD Enforcement

**Location:** `/.github/workflows/build.yml`

**Update the build job:**

```yaml
- name: Build with Warnings as Errors
  run: |
    dotnet build src/WsusManager.sln \
      --configuration Release \
      --warnaserror \
      /p:TreatWarningsAsErrors=true \
      /p:WarningsAsErrors="CA2007;CA1062"
```

**Add verification step:**

```yaml
- name: Verify Zero Warnings
  run: |
    dotnet build src/WsusManager.sln \
      --configuration Release \
      --no-incremental \
      --verbosity normal \
    | tee build.log
    # Fail if any warnings found
    if grep -q "warning" build.log; then
      echo "Build completed with warnings. Static analysis gate failed."
      exit 1
    fi
```

### Step 5: Developer Documentation

**Location:** `/CSharp/CONTRIBUTING.md` (new section)

```markdown
## Static Analysis

This project uses Roslyn analyzers to enforce code quality at compile time.

### Enabled Analyzers

- **.NET SDK Analyzers** (`EnableNETAnalyzers`) - Core code analysis
- **Roslynator** (v4.12.0) - Refactoring suggestions
- **Meziantou.Analyzer** (v2.0.0) - Security and best practices
- **StyleCop.Analyzers** (v1.2.0-beta.556) - Style conventions

### Analyzer Configuration

Analyzer packages are configured in `Directory.Build.props` (solution root). Changes to analyzer versions affect all projects.

### Warning Severity

- **Errors:** CA2007 (ConfigureAwait), CA1062 (null validation) - must fix
- **Warnings:** All other rules - should fix before committing
- **IDE-only:** Refactoring suggestions (RCSxxxx) - not blocking

### Respecting Warnings

1. Run `dotnet build --configuration Release` to see all warnings
2. Fix the issue if possible (preferred)
3. Suppress with `[SuppressMessage]` if false positive (document why)
4. Do NOT commit with active warnings without team approval

### Editor Support

All analyzers work in:
- Visual Studio 2022 (built-in)
- Visual Studio Code (C# Dev Kit extension)
- Rider (built-in)
```

## Verification

**Pre-Implementation:**
1. Count baseline warnings: `dotnet build --configuration Release 2>&1 | grep -c warning`
2. Document current build warnings in phase notes

**Post-Implementation:**
1. Build completes with analyzer packages loaded: `dotnet build --configuration Release`
2. Analyzer output visible in build log
3. CI/CD fails if warnings present (after elevation phase)
4. All developers see same warnings regardless of IDE

## Risk Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Warning fatigue (too many at once) | High | Incremental adoption phases |
| False positives blocking build | Medium | Document suppression policy |
| Analyzer package conflicts | Low | Use specific versions, not wildcards |
| CI timeout due to analysis | Low | Analyzers run fast (<5s overhead) |

## Dependencies

- None (can start immediately)
- Phase 21 will use analyzer complexity metrics for refactoring

## Time Estimate

- Step 1 (Directory.Build.props): 15 minutes
- Step 2 (rule configuration): 30 minutes
- Step 3 (incremental adoption): 2-3 hours (depends on warning count)
- Step 4 (CI/CD updates): 30 minutes
- Step 5 (documentation): 30 minutes
- **Total:** 4-5 hours

## References

- [.NET Analyzer Configuration](https://learn.microsoft.com/en-us/dotnet/fundamentals/code-analysis/configuration-options)
- [Roslynator Analyzers](https://github.com/JosefPihrt/Roslynator)
- [Meziantou.Analyzer Rules](https://github.com/meziantou/Meziantou.Analyzer)
- [StyleCop Rules](https://github.com/DotNetAnalyzers/StyleCopAnalyzers)

---

*Plan: 19-01 - Roslyn Analyzer Infrastructure*
*Status: Complete*
