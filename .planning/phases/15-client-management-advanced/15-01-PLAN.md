---
phase: 15-client-management-advanced
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/WsusManager.Core/Services/Interfaces/IClientService.cs
  - src/WsusManager.Core/Services/ClientService.cs
  - src/WsusManager.App/ViewModels/MainViewModel.cs
  - src/WsusManager.App/Views/MainWindow.xaml
  - src/WsusManager.Tests/Services/ClientServiceTests.cs
autonomous: true
requirements:
  - CLI-03

must_haves:
  truths:
    - "Admin can enter multiple hostnames (comma/newline separated) or load from a text file and trigger mass GPUpdate"
    - "Each host is processed individually with per-host pass/fail results shown in the log panel"
    - "Mass GPUpdate reuses the existing ForceCheckInAsync per host — no new remote logic"
  artifacts:
    - path: "src/WsusManager.Core/Services/Interfaces/IClientService.cs"
      provides: "MassForceCheckInAsync method signature"
      contains: "MassForceCheckInAsync"
    - path: "src/WsusManager.Core/Services/ClientService.cs"
      provides: "MassForceCheckInAsync implementation iterating hosts"
      contains: "MassForceCheckInAsync"
    - path: "src/WsusManager.App/ViewModels/MainViewModel.cs"
      provides: "MassHostnames property, LoadHostFile command, RunMassGpUpdate command"
      contains: "MassHostnames"
    - path: "src/WsusManager.App/Views/MainWindow.xaml"
      provides: "Mass Operations card in Client Tools panel"
      contains: "Mass GPUpdate"
  key_links:
    - from: "MainViewModel.RunMassGpUpdate"
      to: "IClientService.MassForceCheckInAsync"
      via: "await _clientService.MassForceCheckInAsync"
      pattern: "MassForceCheckInAsync"
    - from: "ClientService.MassForceCheckInAsync"
      to: "ClientService.ForceCheckInAsync"
      via: "per-host iteration calling existing method"
      pattern: "ForceCheckInAsync"
---

<objective>
Implement mass GPUpdate across multiple hosts (CLI-03). Admin provides hostnames via text input or file load, clicks Mass GPUpdate, and the app processes each host sequentially with per-host results.

Purpose: Admins managing dozens of WSUS clients need to force group policy and WSUS check-in across all machines at once, rather than one at a time.
Output: MassForceCheckInAsync in service layer, Mass Operations UI card, ViewModel commands with file loading.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/WsusManager.Core/Services/Interfaces/IClientService.cs
@src/WsusManager.Core/Services/ClientService.cs
@src/WsusManager.App/ViewModels/MainViewModel.cs
@src/WsusManager.App/Views/MainWindow.xaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MassForceCheckInAsync to IClientService and ClientService</name>
  <files>
    src/WsusManager.Core/Services/Interfaces/IClientService.cs
    src/WsusManager.Core/Services/ClientService.cs
    src/WsusManager.Tests/Services/ClientServiceTests.cs
  </files>
  <action>
    Add MassForceCheckInAsync to IClientService:
    ```csharp
    Task<OperationResult> MassForceCheckInAsync(
        IReadOnlyList<string> hostnames,
        IProgress<string> progress,
        CancellationToken ct = default);
    ```

    Implement in ClientService:
    1. Validate the list is not empty — return Fail if empty
    2. Report total count: "Processing {N} host(s)..."
    3. Iterate each hostname sequentially (NOT parallel — WinRM connections should not overload):
       - Trim whitespace from each hostname
       - Skip empty entries
       - Report "[Host {i}/{N}] {hostname}..."
       - Call existing ForceCheckInAsync(hostname, progress, ct)
       - Track pass/fail count
       - On cancellation, stop processing remaining hosts and report partial results
    4. After all hosts processed, report summary: "[OK] Mass GPUpdate complete: {passed}/{total} hosts succeeded, {failed} failed."
    5. Return Ok if all succeeded, Fail if any failed (but still process all hosts)

    Add unit tests in ClientServiceTests.cs:
    - Test with 3 hostnames where all succeed → result.Success is true, output mentions all 3
    - Test with 2 hostnames where 1 fails WinRM → result.Success is false, output shows 1 passed 1 failed
    - Test with empty list → returns Fail with appropriate message
    - Test cancellation mid-batch → processes hosts up to cancellation, reports partial results
  </action>
  <verify>
    Run `dotnet build src/WsusManager.Core` succeeds.
    Run `dotnet test src/WsusManager.Tests --filter "ClientService"` — all tests pass including new mass operation tests.
  </verify>
  <done>
    MassForceCheckInAsync iterates hostnames, calls ForceCheckInAsync per host, reports per-host results with pass/fail count, and handles cancellation gracefully. Tests cover success, partial failure, empty input, and cancellation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Mass Operations UI card and ViewModel commands</name>
  <files>
    src/WsusManager.App/ViewModels/MainViewModel.cs
    src/WsusManager.App/Views/MainWindow.xaml
  </files>
  <action>
    In MainViewModel.cs, add to the CLIENT MANAGEMENT section:

    1. Add property:
       ```csharp
       [ObservableProperty]
       private string _massHostnames = string.Empty;
       ```

    2. Add LoadHostFile command (no CanExecute restriction — always available):
       ```csharp
       [RelayCommand]
       private void LoadHostFile()
       ```
       - Opens an OpenFileDialog with filter "Text Files (*.txt)|*.txt|All Files (*.*)|*.*"
       - Reads all lines from the file
       - Sets MassHostnames to the joined content (newline-separated)
       - AppendLog("Loaded {count} hostname(s) from {filename}")

    3. Add RunMassGpUpdate command with CanExecute requiring !IsOperationRunning and !string.IsNullOrWhiteSpace(MassHostnames):
       ```csharp
       [RelayCommand(CanExecute = nameof(CanExecuteMassOperation))]
       private async Task RunMassGpUpdate()
       ```
       - Parse MassHostnames by splitting on commas, semicolons, and newlines
       - Filter out empty/whitespace-only entries
       - Navigate("ClientTools")
       - Call RunOperationAsync wrapping _clientService.MassForceCheckInAsync(hostnames, progress, ct)

    4. Add CanExecuteMassOperation helper: `!IsOperationRunning && !string.IsNullOrWhiteSpace(MassHostnames)`

    5. Wire OnMassHostnamesChanged partial method to notify RunMassGpUpdateCommand.NotifyCanExecuteChanged()

    6. Add RunMassGpUpdateCommand to NotifyCommandCanExecuteChanged() method

    In MainWindow.xaml, add a "Mass Operations" card AFTER the "Remote Operations" card and BEFORE the "Error Code Lookup" card in the Client Tools panel:

    ```xml
    <!-- Mass Operations -->
    <Border Background="{StaticResource BgCard}" CornerRadius="6"
            Padding="16" Margin="0,0,0,12">
        <StackPanel>
            <TextBlock Text="Mass Operations" FontSize="14" FontWeight="SemiBold"
                       Foreground="{StaticResource Text1}" Margin="0,0,0,8"/>
            <TextBlock Text="Enter hostnames (one per line, or comma-separated) or load from a text file. Mass GPUpdate runs gpupdate + WSUS check-in on every host."
                       Foreground="{StaticResource Text2}" FontSize="12"
                       TextWrapping="Wrap" Margin="0,0,0,12"/>
            <TextBox Text="{Binding MassHostnames, UpdateSourceTrigger=PropertyChanged}"
                     Background="{StaticResource BgInput}"
                     Foreground="{StaticResource Text1}"
                     BorderBrush="{StaticResource Border}"
                     Padding="8,6" FontSize="12" FontFamily="Consolas"
                     AcceptsReturn="True" TextWrapping="Wrap"
                     MinHeight="80" MaxHeight="150"
                     VerticalScrollBarVisibility="Auto"/>
            <WrapPanel Margin="0,8,0,0">
                <Button Content="Load from File" Style="{StaticResource BtnSec}"
                        Padding="16,8" Margin="0,0,8,0"
                        Command="{Binding LoadHostFileCommand}"
                        ToolTip="Load hostnames from a text file (one per line)"/>
                <Button Content="Mass GPUpdate" Style="{StaticResource BtnGreen}"
                        Padding="16,8" Margin="0,0,8,0"
                        Command="{Binding RunMassGpUpdateCommand}"
                        ToolTip="Run gpupdate + WSUS check-in on all listed hosts"/>
            </WrapPanel>
        </StackPanel>
    </Border>
    ```

    IMPORTANT: Match the existing dark theme styling exactly. Use the same StaticResource keys (BgCard, BgInput, Text1, Text2, Border, BtnSec, BtnGreen) as the adjacent cards.
  </action>
  <verify>
    Run `dotnet build src/WsusManager.App` succeeds.
    The Client Tools panel now shows Target Host, Remote Operations, Mass Operations, and Error Code Lookup in that order.
  </verify>
  <done>
    Mass Operations card appears in Client Tools panel with a multi-line hostname TextBox, Load from File button, and Mass GPUpdate button. The ViewModel parses comma/newline-separated hostnames and calls MassForceCheckInAsync. CanExecute disables the button when no hostnames are entered or an operation is running.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for the entire solution
2. `dotnet test` passes all existing and new tests
3. Mass GPUpdate button is disabled when hostname TextBox is empty
4. Mass GPUpdate button is disabled when another operation is running
5. Load from File opens a file dialog and populates the TextBox
</verification>

<success_criteria>
- CLI-03 is fully implemented: mass GPUpdate processes multiple hosts with per-host results
- Existing single-host client operations are unchanged
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-client-management-advanced/15-01-SUMMARY.md`
</output>
