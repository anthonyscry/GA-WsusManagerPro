---
phase: 27-visual-feedback-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/WsusManager.App/ViewModels/MainViewModel.cs
autonomous: true
requirements:
  - UX-06

must_haves:
  truths:
    - "Long-running operations (>10s) show estimated time remaining in status area"
    - "Time estimate updates after each operation step completes"
    - "Fallback to 'Working...' message when no benchmark data exists"
    - "Estimation uses Phase 22 BenchmarkDotNet timing data when available"
  artifacts:
    - path: "src/WsusManager.App/ViewModels/MainViewModel.cs"
      provides: "Operation time estimation logic"
      exports: ["EstimatedTimeRemaining", "RunOperationAsync with timing"]
    - path: "src/WsusManager.Core/Services/BenchmarkTimingService.cs"
      provides: "Historical operation timing data storage"
      contains: "class BenchmarkTimingService"
  key_links:
    - from: "MainViewModel.RunOperationAsync"
      to: "BenchmarkTimingService"
      via: "DI injection and lookup by operation name"
      pattern: "GetAverageDuration|TryGetAverageDuration"
---

<objective>
Implement estimated time remaining display for long-running operations using historical timing data from Phase 22 BenchmarkDotNet benchmarks.

Purpose: Users want visibility into how long operations will take so they can plan their work accordingly. This reduces uncertainty and improves perceived responsiveness.

Output: Status area shows "Est. 2m 15s remaining" during operations, updating after each step completes.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/27-visual-feedback-polish/27-CONTEXT.md
@src/WsusManager.App/ViewModels/MainViewModel.cs
</context>

<tasks>

<task type="auto">
  <name>Create BenchmarkTimingService for historical operation timing data</name>
  <files>src/WsusManager.Core/Services/BenchmarkTimingService.cs</files>
  <action>
    Create a new service in src/WsusManager.Core/Services/ to store and retrieve historical operation timing data:

    1. Add interface IBenchmarkTimingService with:
       - Dictionary&lt;string, TimeSpan&gt; OperationTimings { get; } // operation name -> average duration
       - bool TryGetAverageDuration(string operationName, out TimeSpan duration)
       - void RecordTiming(string operationName, TimeSpan duration)

    2. Implement BenchmarkTimingService class with:
       - Pre-populated dictionary using Phase 22 BenchmarkDotNet data (approximate averages):
         * "Health Check": ~5 seconds
         * "Repair Health": ~30 seconds
         * "Deep Cleanup": ~120 seconds
         * "Online Sync": ~60-180 seconds (varies by profile)
         * "Export": ~90 seconds
         * "Import": ~60 seconds
         * "Content Reset": ~45 seconds
       - Thread-safe singleton pattern or DI registration

    3. Register service in DI container (Program.cs or ServiceCollectionExtensions)

    DO NOT: Create actual benchmarks — use approximate timing data from Phase 22 summary
  </action>
  <verify>
    dotnet build src/WsusManager.Core/WsusManager.Core.csproj succeeds
  </verify>
  <done>
    BenchmarkTimingService exists with IBenchmarkTimingService interface, registered in DI container, pre-populated with timing data for 7 common operations
  </done>
</task>

<task type="auto">
  <name>Add time estimation to RunOperationAsync and display in status area</name>
  <files>src/WsusManager.App/ViewModels/MainViewModel.cs</files>
  <action>
    Update MainViewModel to show estimated time remaining during operations:

    1. Inject IBenchmarkTimingService in constructor (add readonly field, parameter)

    2. Add new observable property:
       ```csharp
       [ObservableProperty]
       private string _estimatedTimeRemaining = string.Empty;
       ```

    3. In RunOperationAsync method (around line 331), after setting CurrentOperationName:
       - Look up timing: _benchmarkTimingService.TryGetAverageDuration(operationName, out var estimatedDuration)
       - If found: set EstimatedTimeRemaining = $"Est. {FormatTimeSpan(estimatedDuration)} remaining"
       - If not found: set EstimatedTimeRemaining = "Working..." (fallback per CONTEXT.md decision)

    4. Add helper method FormatTimeSpan(TimeSpan):
       - Returns "2m 15s" format for >= 1 minute
       - Returns "45s" format for &lt; 1 minute
       - Returns "10s" format for &lt; 10 seconds

    5. After each progress report (in Progress&lt;string&gt; callback around line 359-365):
       - Parse "[Step N/M]" from progress line to recalculate remaining time
       - Formula: remaining = estimatedDuration × (1 - currentStep / totalSteps)
       - Update EstimatedTimeRemaining with new calculation

    DO NOT: Change StatusMessage format — keep "Running: {operationName}..." as-is
  </action>
  <verify>
    dotnet build src/WsusManager.App/WsusManager.App.csproj succeeds
  </verify>
  <done>
    RunOperationAsync looks up timing data and sets EstimatedTimeRemaining property, progress callback parses step info and recalculates remaining time
  </done>
</task>

<task type="auto">
  <name>Bind EstimatedTimeRemaining to status area in MainWindow.xaml</name>
  <files>src/WsusManager.App/Views/MainWindow.xaml</files>
  <action>
    Add EstimatedTimeRemaining display to the status area in MainWindow.xaml header (around line 188-205):

    1. Find the ConnectionStatus StackPanel in the header bar
    2. Add a new TextBlock after ConnectionStatusText:
       ```xml
       <TextBlock Text="{Binding EstimatedTimeRemaining}"
                  Foreground="{DynamicResource TextMuted}" FontSize="11"
                  Margin="12,0,0,0"
                  VerticalAlignment="Center"/>
       ```

    3. The text will be empty string when no operation is running, so it won't clutter the UI

    DO NOT: Add additional visual elements (spinner, progress bar) — use existing StatusMessage for operation name
  </action>
  <verify>
    dotnet build src/WsusManager.App/WsusManager.App.csproj succeeds, EstimatedTimeRemaining appears in header when operation starts
  </verify>
  <done>
    EstimatedTimeRemaining displayed in header status area, shows "Est. 2m 15s remaining" during long operations, empty when idle
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: dotnet build src/WsusManager.App
2. EstimatedTimeRemaining displays in header during operations
3. Time estimate updates after each step completes
4. Fallback "Working..." appears for operations without benchmark data
5. No estimate shown when no operation is running (empty string)
</verification>

<success_criteria>
Long-running operations display estimated time remaining based on historical benchmark data. The estimate updates after each step completes, providing users with real-time visibility into operation duration.
</success_criteria>

<output>
After completion, create `.planning/phases/27-visual-feedback-polish/27-01-SUMMARY.md`
</output>
