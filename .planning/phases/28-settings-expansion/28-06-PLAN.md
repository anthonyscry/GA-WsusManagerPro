---
phase: 28-settings-expansion
plan: 06
type: execute
wave: 1
depends_on: ["28-01", "28-04"]
files_modified:
  - src/WsusManager.App/ViewModels/MainViewModel.cs
autonomous: true
requirements:
  - UX-06

must_haves:
  truths:
    - "Deep Cleanup operation shows confirmation when RequireConfirmationDestructive is true"
    - "Restore Database operation shows confirmation when RequireConfirmationDestructive is true"
    - "Reset Content operation shows confirmation when RequireConfirmationDestructive is true"
    - "Non-destructive operations (Health Check, Export, Import) do not show confirmation"
    - "Confirmation message includes operation name and warning about cannot be undone"
  artifacts:
    - path: "src/WsusManager.App/ViewModels/MainViewModel.cs"
      provides: "Confirmation prompt logic for destructive operations"
      contains: "confirmation dialog before cleanup/restore/reset"
  key_links:
    - from: "MainViewModel"
      to: "AppSettings.RequireConfirmationDestructive"
      via: "property check before operation"
      pattern: "conditional logic"
---

<objective>
Implement confirmation prompts for destructive operations based on RequireConfirmationDestructive setting. Show "Are you sure?" dialog before running Deep Cleanup, Restore Database, and Reset Content operations.

Purpose: Destructive operations can cause data loss or require significant recovery time. Confirmation prompts prevent accidental execution. The setting allows users to disable prompts for bulk operations.

Output: MainViewModel with conditional confirmation prompts for destructive operations.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/28-settings-expansion/28-CONTEXT.md
@src/WsusManager.App/ViewModels/MainViewModel.cs
@src/WsusManager.Core/Models/AppSettings.cs
</context>

<tasks>

<task type="auto">
  <name>Create confirmation prompt helper method</name>
  <files>src/WsusManager.App/ViewModels/MainViewModel.cs</files>
  <action>
    Add a helper method in MainViewModel for showing confirmation prompts:

    ```csharp
    /// <summary>
    /// Shows a confirmation dialog for destructive operations if the setting is enabled.
    /// Returns true if the user confirms or if prompts are disabled. Returns false if user cancels.
    /// </summary>
    /// <param name="operationName">The name of the destructive operation.</param>
    /// <returns>True to proceed with operation, false to cancel.</returns>
    private bool ConfirmDestructiveOperation(string operationName)
    {
        // If setting is disabled, auto-proceed
        if (!_settings.RequireConfirmationDestructive)
            return true;

        // Show confirmation dialog
        var result = MessageBox.Show(
            $"Are you sure you want to run {operationName}?\n\nThis action cannot be undone.",
            $"Confirm {operationName}",
            MessageBoxButton.YesNo,
            MessageBoxImage.Warning,
            MessageBoxResult.No);

        return result == MessageBoxResult.Yes;
    }
    ```

    Place this method in the "Helpers" region or near other dialog methods.

    DO NOT: Use MessageBoxImage.Error - Warning is more appropriate for confirmation
  </action>
  <verify>
    dotnet build src/WsusManager.App/WsusManager.App.csproj succeeds
  </verify>
  <done>
    ConfirmDestructiveOperation helper method added, checks RequireConfirmationDestructive setting, shows Yes/No dialog
  </done>
</task>

<task type="auto">
  <name>Add confirmation to Deep Cleanup operation</name>
  <files>src/WsusManager.App/ViewModels/MainViewModel.cs</files>
  <action>
    Find the RunDeepCleanupCommand method and add confirmation at the start:

    1. Locate the method (search for "Deep Cleanup" or "RunDeepCleanupCommand")

    2. Add confirmation check at the beginning:

    ```csharp
    [RelayCommand(CanExecute = nameof(CanExecuteOperation))]
    private async Task RunDeepCleanupAsync()
    {
        // Confirm before running destructive operation
        if (!ConfirmDestructiveOperation("Deep Cleanup"))
            return;

        // ... existing operation code continues unchanged
    }
    ```

    DO NOT: Modify the operation logic itself - only add the confirmation check at the start
  </action>
  <verify>
    dotnet build src/WsusManager.App/WsusManager.App.csproj succeeds
  </verify>
  <done>
    RunDeepCleanupAsync shows confirmation dialog before executing when RequireConfirmationDestructive is true
  </done>
</task>

<task type="auto">
  <name>Add confirmation to Restore Database operation</name>
  <files>src/WsusManager.App/ViewModels/MainViewModel.cs</files>
  <action>
    Find the Restore Database operation and add confirmation:

    1. Locate the method (search for "Restore Database" or "RunRestoreCommand")

    2. Add confirmation check at the beginning:

    ```csharp
    [RelayCommand(CanExecute = nameof(CanExecuteOperation))]
    private async Task RunRestoreAsync()
    {
        // Confirm before running destructive operation
        if (!ConfirmDestructiveOperation("Restore Database"))
            return;

        // ... existing operation code continues unchanged
    }
    ```

    DO NOT: Remove any existing validation - this is in addition to existing checks
  </action>
  <verify>
    dotnet build src/WsusManager.App/WsusManager.App.csproj succeeds
  </verify>
  <done>
    RunRestoreAsync shows confirmation dialog before executing when RequireConfirmationDestructive is true
  </done>
</task>

<task type="auto">
  <name>Add confirmation to Reset Content operation</name>
  <files>src/WsusManager.App/ViewModels/MainViewModel.cs</files>
  <action>
    Find the Reset Content operation and add confirmation:

    1. Locate the method (search for "Reset Content" or related command)

    2. Add confirmation check at the beginning:

    ```csharp
    [RelayCommand(CanExecute = nameof(CanExecuteOperation))]
    private async Task RunResetContentAsync()
    {
        // Confirm before running destructive operation
        if (!ConfirmDestructiveOperation("Reset Content"))
        return;

        // ... existing operation code continues unchanged
    }
    ```

    Note: If Reset Content is part of another command (e.g., Diagnostics section), add the check there instead.

    DO NOT: Add confirmation to non-destructive operations like Health Check or Export
  </action>
  <verify>
    dotnet build src/WsusManager.App/WsusManager.App.csproj succeeds
  </verify>
  <done>
    RunResetContentAsync shows confirmation dialog before executing when RequireConfirmationDestructive is true
  </done>
</task>

<task type="auto">
  <name>Verify non-destructive operations do not show confirmation</name>
  <files>src/WsusManager.App/ViewModels/MainViewModel.cs</files>
  <action>
    Review and ensure these operations do NOT show confirmation:

    1. Health Check - should run without confirmation
    2. Repair Health - should run without confirmation
    3. Export - should run without confirmation
    4. Import - should run without confirmation
    5. Online Sync - should run without confirmation

    Check each method and ensure there's no call to ConfirmDestructiveOperation.

    If any have confirmation dialogs, remove them OR move to a different setting if intentional.

    DO NOT: Add confirmation to operations that don't modify data destructively
  </action>
  <verify>
    dotnet build src/WsusManager.App/WsusManager.App.csproj succeeds
  </verify>
  <done>
    Non-destructive operations (Health Check, Repair, Export, Import, Sync) do not show confirmation prompts
  </done>
</task>

<task type="auto">
  <name>Add unit tests for confirmation logic</name>
  <files>src/WsusManager.Tests/SettingsTests.cs</files>
  <action>
    Create or update unit tests for confirmation prompt logic:

    1. Create test file src/WsusManager.Tests/SettingsTests.cs if it doesn't exist

    2. Add tests for confirmation behavior:

    ```csharp
    using Xunit;
    using WsusManager.Core.Models;

    namespace WsusManager.Tests;

    public class SettingsTests
    {
        [Fact]
        public void RequireConfirmationDestructive_DefaultIsTrue()
        {
            var settings = new AppSettings();
            Assert.True(settings.RequireConfirmationDestructive);
        }

        [Fact]
        public void RequireConfirmationDestructive_CanBeSetToFalse()
        {
            var settings = new AppSettings
            {
                RequireConfirmationDestructive = false
            };
            Assert.False(settings.RequireConfirmationDestructive);
        }

        [Fact]
        public void WindowBounds_DefaultIsNull()
        {
            var settings = new AppSettings();
            Assert.Null(settings.WindowBounds);
        }

        // Add tests for other new settings...
    }
    ```

    DO NOT: Test UI behavior (MessageBox) in unit tests - only test the settings model
  </action>
  <verify>
    dotnet test src/WsusManager.Tests/WsusManager.Tests.csproj --filter "FullyQualifiedName~SettingsTests"
  </verify>
  <done>
    SettingsTests.cs created with tests for RequireConfirmationDestructive default and settable behavior
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: dotnet build src/WsusManager.App
2. ConfirmDestructiveOperation helper method exists
3. Deep Cleanup shows confirmation when setting is true
4. Restore Database shows confirmation when setting is true
5. Reset Content shows confirmation when setting is true
6. Non-destructive operations do not show confirmation
7. Unit tests pass for settings model
8. Setting can be toggled in Settings dialog and takes effect immediately
</verification>

<success_criteria>
Confirmation prompts implemented for destructive operations. Setting controls whether prompts are shown. Non-destructive operations unaffected. Unit tests verify default behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/28-settings-expansion/28-06-SUMMARY.md`
</output>
