# Phase 30-02: Export Button UI

**Created:** 2026-02-21
**Status:** Complete
**Requirement:** DAT-05, DAT-06
**Dependencies:** 30-01 (CsvExportService must exist)

## Goal

Add "Export" buttons to Computers and Updates panels with click handlers that invoke the CSV export service. Buttons should be disabled when panels are empty or loading.

## Success Criteria (Observable Truths)

1. "Export" button appears in Computers panel filter row (right-aligned, after search box)
2. "Export" button appears in Updates panel filter row (right-aligned, after search box)
3. Buttons are disabled when `FilteredComputers.Count == 0` or `FilteredUpdates.Count == 0`
4. Buttons are enabled when data is visible (filtered results > 0)
5. Clicking export button triggers export operation via MainViewModel command

## Changes Required

### 1. Update MainViewModel

**File:** `/mnt/c/projects/GA-WsusManager/src/WsusManager.App/ViewModels/MainViewModel.cs`

#### Add ICsvExportService Dependency

In constructor parameters (around line 93):
```csharp
public MainViewModel(
    ILogService logService,
    ISettingsService settingsService,
    // ... existing services ...
    ICsvExportService csvExportService,  // ADD THIS
    ISettingsValidationService validationService)
{
    // ... existing assignments ...
    _csvExportService = csvExportService;  // ADD THIS
}
```

Add private field:
```csharp
private readonly ICsvExportService _csvExportService;
```

#### Add Export Commands

```csharp
/// <summary>
/// Exports the currently filtered computers list to CSV.
/// Button enabled when FilteredComputers has items.
/// </summary>
[RelayCommand(CanExecute = nameof(CanExportComputers))]
private async Task ExportComputersAsync()
{
    if (FilteredComputers.Count == 0)
    {
        MessageBox.Show(
            "No computers to export. Apply filters or load data first.",
            "Cannot Export",
            MessageBoxButton.OK,
            MessageBoxImage.Warning);
        return;
    }

    await RunOperationAsync(
        "Export Computers",
        async (progress, ct) =>
        {
            var filePath = await _csvExportService.ExportComputersAsync(
                FilteredComputers,
                progress,
                ct);

            // Open destination folder with file selected
            Process.Start(new ProcessStartInfo
            {
                FileName = "explorer.exe",
                Arguments = $"/select,\"{filePath}\"",
                UseShellExecute = true
            });

            return true;
        }).ConfigureAwait(false);
}

/// <summary>
/// Determines if ExportComputers command can execute.
/// Requires at least one visible computer in filtered list.
/// </summary>
private bool CanExportComputers() => FilteredComputers.Count > 0;

/// <summary>
/// Exports the currently filtered updates list to CSV.
/// Button enabled when FilteredUpdates has items.
/// </summary>
[RelayCommand(CanExecute = nameof(CanExportUpdates))]
private async Task ExportUpdatesAsync()
{
    if (FilteredUpdates.Count == 0)
    {
        MessageBox.Show(
            "No updates to export. Apply filters or load data first.",
            "Cannot Export",
            MessageBoxButton.OK,
            MessageBoxImage.Warning);
        return;
    }

    await RunOperationAsync(
        "Export Updates",
        async (progress, ct) =>
        {
            var filePath = await _csvExportService.ExportUpdatesAsync(
                FilteredUpdates,
                progress,
                ct);

            // Open destination folder with file selected
            Process.Start(new ProcessStartInfo
            {
                FileName = "explorer.exe",
                Arguments = $"/select,\"{filePath}\"",
                UseShellExecute = true
            });

            return true;
        }).ConfigureAwait(false);
}

/// <summary>
/// Determines if ExportUpdates command can execute.
/// Requires at least one visible update in filtered list.
/// </summary>
private bool CanExportUpdates() => FilteredUpdates.Count > 0;
```

#### Refresh CanExecute on Filter Changes

In `ApplyComputerFilters()` method (around line 2008):
```csharp
private void ApplyComputerFilters()
{
    var view = System.Windows.Data.CollectionViewSource.GetDefaultView(FilteredComputers);
    view.Filter = (obj) =>
    {
        // ... existing filter logic ...
    };
    view.Refresh();

    // Refresh export button state
    ExportComputersCommand.NotifyCanExecuteChanged();
}
```

In `ApplyUpdateFilters()` method (around line 2046):
```csharp
private void ApplyUpdateFilters()
{
    var view = System.Windows.Data.CollectionViewSource.GetDefaultView(FilteredUpdates);
    view.Filter = (obj) =>
    {
        // ... existing filter logic ...
    };
    view.Refresh();

    // Refresh export button state
    ExportUpdatesCommand.NotifyCanExecuteChanged();
}
```

In `LoadComputersAsync()` and `LoadUpdatesAsync()` after loading data:
```csharp
// After populating FilteredComputers
FilteredComputers.Clear();
foreach (var computer in computers)
{
    FilteredComputers.Add(computer);
}
// ... existing code ...
ExportComputersCommand.NotifyCanExecuteChanged();  // ADD THIS
```

```csharp
// After populating FilteredUpdates
FilteredUpdates.Clear();
foreach (var update in updates)
{
    FilteredUpdates.Add(update);
}
// ... existing code ...
ExportUpdatesCommand.NotifyCanExecuteChanged();  // ADD THIS
```

### 2. Update MainWindow.xaml

**File:** `/mnt/c/projects/GA-WsusManager/src/WsusManager.App/Views/MainWindow.xaml`

#### Add Export Button to Computers Panel

Find the Computers Panel filter row (around line 832). Add export button after Clear Filters button:

```xml
<!-- Filter Row -->
<StackPanel Style="{StaticResource FilterRow}">
    <!-- Status Filter -->
    <TextBlock Text="Status:"
               Foreground="{DynamicResource TextSecondary}"
               FontSize="12"
               VerticalAlignment="Center"
               Margin="0,0,6,0"/>
    <ComboBox Style="{StaticResource FilterComboBox}"
              SelectedItem="{Binding ComputerStatusFilter}"
              Width="120">
        <ComboBoxItem Content="All"/>
        <ComboBoxItem Content="Online"/>
        <ComboBoxItem Content="Offline"/>
        <ComboBoxItem Content="Error"/>
    </ComboBox>

    <!-- Search Box -->
    <TextBox Style="{StaticResource FilterSearchBox}"
             Text="{Binding ComputerSearchText, UpdateSourceTrigger=PropertyChanged}"
             automation:AutomationProperties.AutomationId="ComputerSearchTextBox"
             Margin="12,0,0,0">
        <TextBox.InputBindings>
            <KeyBinding Key="Escape" Command="{Binding ClearComputerFiltersCommand}"/>
        </TextBox.InputBindings>
    </TextBox>

    <!-- Clear Filters Button -->
    <Button Content="Clear Filters"
            Style="{StaticResource ClearFiltersButton}"
            Command="{Binding ClearComputerFiltersCommand}"
            Visibility="{Binding ShowClearComputerFilters, Converter={StaticResource BoolToVisibilityConverter}}"
            automation:AutomationProperties.AutomationId="ClearComputerFiltersButton"/>

    <!-- Export Button (Phase 30) -->
    <Button Content="Export"
            Style="{StaticResource ClearFiltersButton}"
            Command="{Binding ExportComputersCommand}"
            Margin="12,0,0,0"
            automation:AutomationProperties.AutomationId="ExportComputersButton"/>
</StackPanel>
```

#### Add Export Button to Updates Panel

Find the Updates Panel filter row (around line 967). Add export button after Clear Filters button:

```xml
<!-- Filter Row -->
<StackPanel Style="{StaticResource FilterRow}">
    <!-- Approval Filter -->
    <TextBlock Text="Approval:"
               Foreground="{DynamicResource TextSecondary}"
               FontSize="12"
               VerticalAlignment="Center"
               Margin="0,0,6,0"/>
    <ComboBox Style="{StaticResource FilterComboBox}"
              SelectedItem="{Binding UpdateApprovalFilter}"
              Width="140">
        <ComboBoxItem Content="All"/>
        <ComboBoxItem Content="Approved"/>
        <ComboBoxItem Content="Not Approved"/>
        <ComboBoxItem Content="Declined"/>
    </ComboBox>

    <!-- Classification Filter -->
    <!-- ... existing classification filter ... -->

    <!-- Search Box -->
    <TextBox Style="{StaticResource FilterSearchBox}"
             Text="{Binding UpdateSearchText, UpdateSourceTrigger=PropertyChanged}"
             automation:AutomationProperties.AutomationId="UpdateSearchTextBox"
             Margin="12,0,0,0">
        <TextBox.InputBindings>
            <KeyBinding Key="Escape" Command="{Binding ClearUpdateFiltersCommand}"/>
        </TextBox.InputBindings>
    </TextBox>

    <!-- Clear Filters Button -->
    <Button Content="Clear Filters"
            Style="{StaticResource ClearFiltersButton}"
            Command="{Binding ClearUpdateFiltersCommand}"
            Visibility="{Binding ShowClearUpdateFilters, Converter={StaticResource BoolToVisibilityConverter}}"
            automation:AutomationProperties.AutomationId="ClearUpdateFiltersButton"/>

    <!-- Export Button (Phase 30) -->
    <Button Content="Export"
            Style="{StaticResource ClearFiltersButton}"
            Command="{Binding ExportUpdatesCommand}"
            Margin="12,0,0,0"
            automation:AutomationProperties.AutomationId="ExportUpdatesButton"/>
</StackPanel>
```

## Implementation Notes

### Button Styling
- Reuse `ClearFiltersButton` style for consistency
- Button text: "Export" (simple, clear)
- Position: After Clear Filters button with 12px left margin
- Right-aligned in filter row (StackPanel default horizontal alignment)

### CanExecute Logic
- Command disabled when `FilteredComputers.Count == 0` or `FilteredUpdates.Count == 0`
- Must call `NotifyCanExecuteChanged()` after:
  - Loading data (`LoadComputersAsync`, `LoadUpdatesAsync`)
  - Applying filters (`ApplyComputerFilters`, `ApplyUpdateFilters`)
  - Clearing filters

### Export Behavior
- Exports currently **filtered** items (respects user's filter settings)
- Quick workaround for "export all": Clear filters first, then export
- Opens destination folder with file selected after completion
- Uses `RunOperationAsync` for consistent error handling and status updates

### AutomationId
- `ExportComputersButton` for UI automation testing
- `ExportUpdatesButton` for UI automation testing
- Follows Phase 26 accessibility requirements

## Testing Notes

Manual verification steps:
1. Navigate to Computers panel
2. Verify Export button is disabled when no data loaded
3. Load computers (navigate to panel or click refresh)
4. Verify Export button is enabled
5. Apply status filter to reduce visible items
6. Click Export button
7. Verify CSV file created in Documents folder
8. Verify Explorer opens with file selected
9. Verify CSV contains only filtered items (not all computers)
10. Repeat for Updates panel

## Related Files

- `30-01-PLAN.md` — CSV Export Service implementation
- `30-03-PLAN.md` — Export progress dialog
- `.planning/phases/30-data-export/30-CONTEXT.md` — Implementation decisions

---

_Requirement: DAT-05 (Computer export), DAT-06 (Update export)_
_Phase: 30-data-export_
