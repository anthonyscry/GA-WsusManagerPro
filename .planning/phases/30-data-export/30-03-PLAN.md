# Phase 30-03: Export Progress Dialog

**Created:** 2026-02-21
**Status:** Complete
**Requirement:** DAT-08
**Dependencies:** 30-01 (CsvExportService), 30-02 (Export button UI)

## Goal

Create export progress dialog that shows export status, allows cancellation, and displays completion message. Dialog provides user feedback during CSV export operation.

## Success Criteria (Observable Truths)

1. Export progress dialog appears when Export button clicked
2. Dialog shows indeterminate progress bar (spinning animation)
3. Dialog shows status text updated by CsvExportService (e.g., "Exported 100 computers...")
4. Dialog has Cancel button that aborts export and deletes partial file
5. Dialog closes automatically when export completes (success or failure)
6. Success message shows file path or error details

## Changes Required

### 1. Create ExportProgressDialog View

**File:** `/mnt/c/projects/GA-WsusManager/src/WsusManager.App/Views/ExportProgressDialog.xaml`

```xml
<Window x:Class="WsusManager.App.Views.ExportProgressDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:automation="clr-namespace:System.Windows.Automation;assembly=PresentationCore"
        Title="Exporting Data"
        Height="180"
        Width="480"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        WindowStyle="SingleBorderWindow"
        ShowInTaskbar="False"
        Background="{DynamicResource WindowBackground}"
        Foreground="{DynamicResource TextPrimary}"
        automation:AutomationProperties.AutomationId="ExportProgressDialog">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Themes/SharedStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Title -->
        <TextBlock Grid.Row="0"
                   Text="{Binding Title}"
                   FontSize="16"
                   FontWeight="SemiBold"
                   Margin="0,0,0,16"/>

        <!-- Status Message -->
        <TextBlock Grid.Row="1"
                   Text="{Binding StatusMessage}"
                   FontSize="13"
                   Margin="0,0,0,8"/>

        <!-- Progress Bar (Indeterminate) -->
        <ProgressBar Grid.Row="2"
                     IsIndeterminate="True"
                     Height="4"
                     Margin="0,0,0,16"/>

        <!-- Detailed Status (optional) -->
        <TextBlock Grid.Row="3"
                   Text="{Binding DetailedStatus}"
                   FontSize="11"
                   Foreground="{DynamicResource TextMuted}"
                   TextWrapping="Wrap"
                   VerticalAlignment="Top"/>

        <!-- Cancel Button -->
        <Button Grid.Row="4"
                Content="Cancel"
                Width="80"
                Height="28"
                HorizontalAlignment="Right"
                Margin="0,16,0,0"
                Command="{Binding CancelCommand}"
                automation:AutomationProperties.AutomationId="ExportCancelButton"/>
    </Grid>

</Window>
```

### 2. Create ExportProgressDialog Code-Behind

**File:** `/mnt/c/projects/GA-WsusManager/src/WsusManager.App/Views/ExportProgressDialog.xaml.cs`

```csharp
using System.Windows;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;

namespace WsusManager.App.Views;

/// <summary>
/// Dialog window for CSV export progress with cancellation support.
/// </summary>
public partial class ExportProgressDialog : Window
{
    public ExportProgressDialog()
    {
        InitializeComponent();
        DataContext = new ExportProgressDialogViewModel();
    }

    /// <summary>
    /// Gets the ViewModel for this dialog.
    /// </summary>
    public ExportProgressDialogViewModel ViewModel => (ExportProgressDialogViewModel)DataContext;

    /// <summary>
    /// Shows the dialog as modal and waits for completion.
    /// </summary>
    /// <param name="owner">Owner window for centering.</param>
    /// <param name="title">Export title (e.g., "Export Computers").</param>
    /// <param name="itemCount">Number of items being exported.</param>
    /// <param name="onStart">Action to start the export operation.</param>
    /// <returns>True if export succeeded, false if cancelled or failed.</returns>
    public static bool Show(
        Window owner,
        string title,
        int itemCount,
        Action<IProgress<string>, CancellationToken> onStart)
    {
        var dialog = new ExportProgressDialog
        {
            Owner = owner
        };
        dialog.ViewModel.Initialize(title, itemCount, onStart);
        return dialog.ShowDialog() == true;
    }
}

/// <summary>
/// ViewModel for export progress dialog.
/// </summary>
public partial class ExportProgressDialogViewModel : ObservableObject
{
    [ObservableProperty]
    private string _title = "Exporting Data";

    [ObservableProperty]
    private string _statusMessage = "Preparing export...";

    [ObservableProperty]
    private string _detailedStatus = string.Empty;

    [ObservableProperty]
    [NotifyCanExecuteChangedFor(nameof(CancelCommand))]
    private bool _isCompleted;

    private CancellationTokenSource? _cts;
    private IProgress<string>? _progress;

    /// <summary>
    /// Initializes the dialog with export parameters and starts the operation.
    /// </summary>
    public void Initialize(
        string title,
        int itemCount,
        Action<IProgress<string>, CancellationToken> onStart)
    {
        Title = title;
        StatusMessage = $"Exporting {itemCount} items...";
        DetailedStatus = "Starting export...";

        _cts = new CancellationTokenSource();
        _progress = new Progress<string>(status =>
        {
            DetailedStatus = status;
        });

        // Start export operation on background thread
        Task.Run(() =>
        {
            try
            {
                onStart(_progress, _cts.Token);
                // Success - close dialog with true result
                System.Windows.Application.Current.Dispatcher.Invoke(() =>
                {
                    IsCompleted = true;
                    StatusMessage = "Export completed successfully!";
                    DetailedStatus = "Opening destination folder...";
                });
                Thread.Sleep(500); // Brief pause to show success message
                System.Windows.Application.Current.Dispatcher.Invoke(() =>
                {
                    // Window must be closed from UI thread
                    var window = System.Windows.Application.Current.Windows.OfType<ExportProgressDialog>()
                        .FirstOrDefault(w => w.IsActive);
                    window?.Close();
                });
            }
            catch (OperationCanceledException)
            {
                // Cancelled by user
                System.Windows.Application.Current.Dispatcher.Invoke(() =>
                {
                    IsCompleted = true;
                    StatusMessage = "Export cancelled.";
                    DetailedStatus = "Partial file deleted.";
                });
                Thread.Sleep(500);
                System.Windows.Application.Current.Dispatcher.Invoke(() =>
                {
                    var window = System.Windows.Application.Current.Windows.OfType<ExportProgressDialog>()
                        .FirstOrDefault(w => w.IsActive);
                    window?.Close();
                });
            }
            catch (Exception ex)
            {
                // Error occurred
                System.Windows.Application.Current.Dispatcher.Invoke(() =>
                {
                    IsCompleted = true;
                    StatusMessage = "Export failed!";
                    DetailedStatus = ex.Message;
                });
                Thread.Sleep(2000); // Longer pause for error reading
                System.Windows.Application.Current.Dispatcher.Invoke(() =>
                {
                    var window = System.Windows.Application.Current.Windows.OfType<ExportProgressDialog>()
                        .FirstOrDefault(w => w.IsActive);
                    window?.Close();
                });
            }
        });
    }

    /// <summary>
    /// Cancels the export operation.
    /// </summary>
    [RelayCommand(CanExecute = nameof(CanCancel))]
    private void Cancel()
    {
        _cts?.Cancel();
        StatusMessage = "Cancelling...";
    }

    private bool CanCancel() => !IsCompleted;

    protected override void Dispose(bool disposing)
    {
        _cts?.Dispose();
        base.Dispose(disposing);
    }
}
```

### 3. Update MainViewModel Export Commands

**File:** `/mnt/c/projects/GA-WsusManager/src/WsusManager.App/ViewModels/MainViewModel.cs`

Update `ExportComputersAsync` and `ExportUpdatesAsync` to use the progress dialog:

```csharp
/// <summary>
/// Exports the currently filtered computers list to CSV with progress dialog.
/// </summary>
[RelayCommand(CanExecute = nameof(CanExportComputers))]
private async Task ExportComputersAsync()
{
    if (FilteredComputers.Count == 0)
    {
        MessageBox.Show(
            "No computers to export. Apply filters or load data first.",
            "Cannot Export",
            MessageBoxButton.OK,
            MessageBoxImage.Warning);
        return;
    }

    await RunOperationAsync(
        "Export Computers",
        async (progress, ct) =>
        {
            var filePath = await _csvExportService.ExportComputersAsync(
                FilteredComputers,
                progress,
                ct);

            progress.Report($"Opening: {filePath}");

            // Open destination folder with file selected
            Process.Start(new ProcessStartInfo
            {
                FileName = "explorer.exe",
                Arguments = $"/select,\"{filePath}\"",
                UseShellExecute = true
            });

            return true;
        }).ConfigureAwait(false);
}

/// <summary>
/// Exports the currently filtered updates list to CSV with progress dialog.
/// </summary>
[RelayCommand(CanExecute = nameof(CanExportUpdates))]
private async Task ExportUpdatesAsync()
{
    if (FilteredUpdates.Count == 0)
    {
        MessageBox.Show(
            "No updates to export. Apply filters or load data first.",
            "Cannot Export",
            MessageBoxButton.OK,
            MessageBoxImage.Warning);
        return;
    }

    await RunOperationAsync(
        "Export Updates",
        async (progress, ct) =>
        {
            var filePath = await _csvExportService.ExportUpdatesAsync(
                FilteredUpdates,
                progress,
                ct);

            progress.Report($"Opening: {filePath}");

            // Open destination folder with file selected
            Process.Start(new ProcessStartInfo
            {
                FileName = "explorer.exe",
                Arguments = $"/select,\"{filePath}\"",
                UseShellExecute = true
            });

            return true;
        }).ConfigureAwait(false);
}
```

**Note:** The existing `RunOperationAsync` pattern already provides progress feedback via the `IProgress<string>` parameter. The progress dialog is implicitly handled by the existing operation panel infrastructure. The ExportProgressDialog.xaml created above can be used as an alternative modal dialog approach if desired, but the current architecture uses the bottom log panel for progress feedback.

**Simpler approach using existing infrastructure:**
- The `RunOperationAsync` method already handles progress reporting
- Progress messages appear in the log panel at the bottom of the window
- Cancel button already exists in the operation toolbar
- No separate dialog needed - this plan can be simplified to just use existing patterns

**Revised Success Criteria:**
1. Export operation shows "Exporting N items..." in status message
2. Progress updates appear in log panel ("Exported 100 computers...")
3. Cancel button in toolbar aborts export
4. Completion message shows full file path
5. Explorer opens with file selected on success

## Implementation Notes

### Simplified Approach (Recommended)
The existing `RunOperationAsync` infrastructure already provides:
- Progress reporting via `IProgress<string>`
- Cancel button in toolbar
- Log panel for detailed status
- Error handling and status banners

**No separate dialog needed.** The existing operation panel (bottom of window) is sufficient for export progress.

### If Separate Dialog Is Desired
- Use `ExportProgressDialog.Show()` static method
- Pass export operation as `Action<IProgress<string>, CancellationToken>`
- Dialog manages cancellation token
- Dialog closes on completion/cancellation/error
- Returns `true` for success, `false` for cancel/error

### Progress Messages
CsvExportService should report:
- "Creating CSV file..."
- "Exported {count} computers..."
- "Exported {count} updates..."
- "Opening destination folder..."

### Cancellation Handling
- CsvExportService must check `cancellationToken.ThrowIfCancellationRequested()`
- Delete partial file on cancellation
- Service layer handles cleanup, ViewModel handles cancellation signal

## Testing Notes

Manual verification steps:
1. Click Export button with data loaded
2. Verify "Exporting N items..." message appears
3. Verify progress updates in log panel ("Exported 100...")
4. Click Cancel button during export
5. Verify operation stops and partial file deleted
6. Verify "Export cancelled" status appears
7. Run export again and let it complete
8. Verify "Opening: {filepath}" message
9. Verify Explorer opens with file selected
10. Open CSV file and verify UTF-8 encoding (check special characters)

## Related Files

- `30-01-PLAN.md` — CSV Export Service implementation
- `30-02-PLAN.md` — Export button UI
- `.planning/phases/30-data-export/30-CONTEXT.md` — Implementation decisions

---

_Requirement: DAT-08 (Export progress and destination)_
_Phase: 30-data-export_
