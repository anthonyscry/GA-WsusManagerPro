# Phase 30-01: CSV Export Service

**Created:** 2026-02-21
**Status:** Pending
**Requirement:** DAT-05, DAT-06, DAT-07
**Dependencies:** None

## Goal

Create `ICsvExportService` interface and `CsvExportService` implementation to export dashboard data (computers and updates) to CSV files with UTF-8 BOM for Excel compatibility.

## Success Criteria (Observable Truths)

1. `ICsvExportService` interface exists in `WsusManager.Core/Services/Interfaces/` with `ExportComputersAsync` and `ExportUpdatesAsync` methods
2. `CsvExportService` class implements `ICsvExportService` with streaming CSV writing (no StringBuilder for large datasets)
3. CSV files include UTF-8 BOM (EF BB BF) as first three bytes for Excel compatibility
4. Export writes directly to user's Documents folder with pattern `WsusManager-{ExportType}-{yyyyMMdd-HHmmss}.csv`
5. Service registered as singleton in `Program.cs` dependency injection container

## Changes Required

### 1. Create ICsvExportService Interface

**File:** `/mnt/c/projects/GA-WsusManager/src/WsusManager.Core/Services/Interfaces/ICsvExportService.cs`

```csharp
using WsusManager.Core.Models;

namespace WsusManager.Core.Services.Interfaces;

/// <summary>
/// Exports dashboard data to CSV format with UTF-8 BOM for Excel compatibility.
/// </summary>
public interface ICsvExportService
{
    /// <summary>
    /// Exports computer list to CSV file.
    /// </summary>
    /// <param name="computers">Collection of computers to export.</param>
    /// <param name="progress">Optional progress reporter for status updates.</param>
    /// <param name="cancellationToken">Cancellation token for aborting export.</param>
    /// <returns>Full path to the created CSV file.</returns>
    /// <exception cref="IOException">Thrown when Documents folder is inaccessible or disk is full.</exception>
    Task<string> ExportComputersAsync(
        IEnumerable<ComputerInfo> computers,
        IProgress<string>? progress = null,
        CancellationToken cancellationToken = default);

    /// <summary>
    /// Exports update list to CSV file.
    /// </summary>
    /// <param name="updates">Collection of updates to export.</param>
    /// <param name="progress">Optional progress reporter for status updates.</param>
    /// <param name="cancellationToken">Cancellation token for aborting export.</param>
    /// <returns>Full path to the created CSV file.</returns>
    /// <exception cref="IOException">Thrown when Documents folder is inaccessible or disk is full.</exception>
    Task<string> ExportUpdatesAsync(
        IEnumerable<UpdateInfo> updates,
        IProgress<string>? progress = null,
        CancellationToken cancellationToken = default);
}
```

### 2. Create CsvExportService Implementation

**File:** `/mnt/c/projects/GA-WsusManager/src/WsusManager.Core/Services/CsvExportService.cs`

**Key implementation details:**
- Use `StreamWriter` with UTF-8 encoding and BOM: `new UTF8Encoding(true)`
- Batch writes: 100 rows at a time for progress updates
- CRLF line endings: `Environment.NewLine`
- Quote fields containing commas, quotes, or newlines
- Escape quotes by doubling them (`"` → `""`)
- File naming: `WsusManager-Computers-{yyyyMMdd-HHmmss}.csv` or `WsusManager-Updates-{yyyyMMdd-HHmmss}.csv`
- Destination: `Environment.SpecialFolder.MyDocuments`

**CSV Format Specifications:**
- **Delimiters:** Comma (`,`)
- **Quote character:** Double quote (`"`)
- **Line ending:** CRLF (`\r\n`)
- **Encoding:** UTF-8 with BOM

**Computers Export Columns:**
1. `Hostname`
2. `IP Address`
3. `Status`
4. `Last Sync`
5. `Pending Updates`
6. `OS Version`

**Updates Export Columns:**
1. `KB Number`
2. `Title`
3. `Classification`
4. `Approval Status`
5. `Approval Date`
6. `Released Date` (if available, otherwise "N/A")

**Code Structure:**
```csharp
public sealed class CsvExportService : ICsvExportService
{
    private const int BatchSize = 100;

    public async Task<string> ExportComputersAsync(
        IEnumerable<ComputerInfo> computers,
        IProgress<string>? progress = null,
        CancellationToken cancellationToken = default)
    {
        var fileName = $"WsusManager-Computers-{DateTime.Now:yyyyMMdd-HHmmss}.csv";
        var documentsPath = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
        var filePath = Path.Combine(documentsPath, fileName);

        progress?.Report("Creating CSV file...");

        await using var stream = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.None);
        // Use UTF-8 with BOM for Excel compatibility
        await using var writer = new StreamWriter(stream, new UTF8Encoding(true));

        // Write header
        await writer.WriteLineAsync("Hostname,IP Address,Status,Last Sync,Pending Updates,OS Version");

        // Write data in batches
        var batch = new List<ComputerInfo>(BatchSize);
        var count = 0;

        foreach (var computer in computers)
        {
            cancellationToken.ThrowIfCancellationRequested();
            batch.Add(computer);

            if (batch.Count >= BatchSize)
            {
                await WriteBatchAsync(writer, batch);
                count += batch.Count;
                progress?.Report($"Exported {count} computers...");
                batch.Clear();
            }
        }

        // Write remaining items
        if (batch.Count > 0)
        {
            await WriteBatchAsync(writer, batch);
            count += batch.Count;
        }

        return filePath;
    }

    private static async Task WriteBatchAsync(StreamWriter writer, List<ComputerInfo> batch)
    {
        foreach (var computer in batch)
        {
            var line = $"{EscapeField(computer.Hostname)},{EscapeField(computer.IpAddress)}," +
                       $"{EscapeField(computer.Status)},{EscapeField(computer.LastSync.ToString("yyyy-MM-dd HH:mm:ss"))}," +
                       $"{computer.PendingUpdates},{EscapeField(computer.OsVersion)}";
            await writer.WriteLineAsync(line);
        }
    }

    private static string EscapeField(string field)
    {
        if (string.IsNullOrEmpty(field))
            return string.Empty;

        // Quote if contains comma, quote, or newline
        if (field.Contains(',') || field.Contains('"') || field.Contains('\n') || field.Contains('\r'))
        {
            return $"\"{field.Replace("\"", "\"\"")}\"";
        }
        return field;
    }

    // Similar implementation for ExportUpdatesAsync...
}
```

### 3. Register Service in DI Container

**File:** `/mnt/c/projects/GA-WsusManager/src/WsusManager.App/Program.cs`

Add to service registration:
```csharp
services.AddSingleton<ICsvExportService, CsvExportService>();
```

Place after other service registrations (around line 50-60).

## Implementation Notes

### UTF-8 BOM
- Excel requires UTF-8 BOM to properly detect UTF-8 encoding
- Without BOM, Excel opens CSV with system default encoding (e.g., Windows-1252)
- Result: Unicode characters display as garbage
- C# `new UTF8Encoding(true)` automatically writes BOM

### Streaming vs StringBuilder
- **StringBuilder**: Loads entire file in memory (bad for 2000+ computers)
- **StreamWriter**: Streams to disk with constant memory usage
- Use StreamWriter for scalability

### Cancellation Support
- Check `cancellationToken.ThrowIfCancellationRequested()` in loop
- Delete partial file if cancelled during export
- Caller (ViewModel) handles cleanup on cancellation

### Batch Processing
- Write 100 rows at a time to StreamWriter
- Report progress after each batch
- Balances I/O efficiency with UI responsiveness

## Testing Notes

Create unit tests in `/mnt/c/projects/GA-WsusManager/src/WsusManager.Tests/Services/CsvExportServiceTests.cs`:

1. **Test UTF-8 BOM**: Verify first 3 bytes are `EF BB BF`
2. **Test header row**: Verify column names match specification
3. **Test data encoding**: Verify special characters (commas, quotes, newlines) are properly escaped
4. **Test file location**: Verify file created in Documents folder
5. **Test file naming**: Verify pattern matches `WsusManager-{Type}-{yyyyMMdd-HHmmss}.csv`
6. **Test cancellation**: Verify partial file deleted on cancellation

## Related Files

- `30-02-PLAN.md` — Export button UI implementation
- `30-03-PLAN.md` — Export progress dialog
- `.planning/phases/30-data-export/30-CONTEXT.md` — Implementation decisions

---

_Requirement: DAT-05 (Computer export), DAT-06 (Update export), DAT-07 (UTF-8 BOM)_
_Phase: 30-data-export_
