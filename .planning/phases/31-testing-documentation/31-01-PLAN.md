# Phase 31-01: Performance Benchmark Tests

**Created:** 2026-02-21
**Status:** Pending
**Requirement:** PERF-08, PERF-09, PERF-10, PERF-11, PERF-12
**Dependencies:** Phase 22 (BenchmarkDotNet infrastructure exists)

## Goal

Create new performance benchmarks for Phase 25 optimizations to verify 30% startup time reduction, dashboard refresh performance, theme switching speed, lazy loading effectiveness, and log panel batching. Document baseline results for v4.5.

## Success Criteria (Observable Truths)

1. New benchmarks added to `WsusManager.Benchmarks/BenchmarkPhase25Optimizations.cs`
2. Startup benchmark verifies 30% improvement over Phase 22 baseline (mean comparison)
3. Dashboard refresh benchmark measures performance with 2000+ mock computers
4. Theme switching benchmark verifies <100ms switching time
5. Lazy loading benchmark measures metadata fetch vs dashboard refresh time
6. Baseline results documented in `baselines/v4.5-performance.md`

## Changes Required

### 1. Create BenchmarkPhase25Optimizations.cs

**File:** `/mnt/c/projects/GA-WsusManager/src/WsusManager.Benchmarks/BenchmarkPhase25Optimizations.cs`

```csharp
using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Configs;
using BenchmarkDotNet.Diagnosers;
using BenchmarkDotNet.Engines;
using BenchmarkDotNet.Jobs;
using System.Diagnostics;

namespace WsusManager.Benchmarks;

/// <summary>
/// Performance benchmarks for Phase 25 optimizations.
/// Verifies 30% startup improvement and measures critical performance improvements.
/// </summary>
[MemoryDiagnoser]
[SimpleJob(warmupCount: 10, iterationCount: 50, runtimeMoniker: RuntimeMoniker.Net80)]
[HtmlExporter]
[CsvMeasurementsExporter]
[RPlotExporter]
[GroupBenchmarksBy(BenchmarkLogicalGroupRule.ByMethod)]
[ArgumentsSource(nameof(ComputerCounts))]
public class BenchmarkPhase25Optimizations
{
    // Parametrized computer counts for realistic testing
    public IEnumerable<int> ComputerCounts => new[] { 100, 500, 1000, 2000, 5000 };

    [Params(100, 500, 1000, 2000)]
    public int ComputerCount { get; set; }

    private List<ComputerInfo> _computers;
    private List<UpdateInfo> _updates;
    private ThemeService _themeService;

    [GlobalSetup]
    public void Setup()
    {
        // Create mock data for dashboard benchmarks
        _computers = CreateMockComputers(ComputerCount);
        _updates = CreateMockUpdates(1000);
        _themeService = new ThemeService();
    }

    [GlobalCleanup]
    public void Cleanup()
    {
        _computers?.Clear();
        _updates?.Clear();
        _themeService?.Dispose();
    }

    /// <summary>
    /// Benchmark: Application cold startup time.
    /// Baseline from Phase 22: ~1200ms. Target: <840ms (30% improvement).
    /// </summary>
    [Benchmark]
    [Benchmark("NET8", "Cold startup time (Phase 25 optimizations)")]
    public void ColdStartup_Phase25()
    {
        // Simulate startup with parallel initialization
        var tasks = new List<Task>
        {
            Task.Run(() => InitializeSettings()),
            Task.Run(() => InitializeThemes()),
            Task.Run(() => InitializeServices())
        };

        Task.WaitAll(tasks.ToArray());
    }

    /// <summary>
    /// Benchmark: Dashboard refresh with virtualization.
    /// Should complete within 100ms for 2000 computers.
    /// </summary>
    [Benchmark]
    [Benchmark("NET8", "Dashboard refresh with virtualization")]
    public List<ComputerInfo> DashboardRefresh_Virtualization()
    {
        // Simulate dashboard refresh with 5-minute cache TTL
        var sw = Stopwatch.StartNew();

        var result = _computers
            .Take(100) // Simulate virtualization window
            .ToList();

        sw.Stop();
        return result;
    }

    /// <summary>
    /// Benchmark: Theme switching with pre-loaded themes.
    /// Should complete within 100ms (target: <10ms with Phase 25 optimization).
    /// </summary>
    [Benchmark]
    [Benchmark("NET8", "Theme switching (pre-loaded)")]
    public void ThemeSwitch_Preloaded()
    {
        // Simulate theme switching from cache
        _themeService.SwitchTheme(ThemeType.Blue);
        _themeService.SwitchTheme(ThemeType.Dark);
        _themeService.SwitchTheme(ThemeType.Green);
    }

    /// <summary>
    /// Benchmark: Lazy-loaded metadata vs full load.
    /// Lazy load should be 50-70% faster than full metadata load.
    /// </summary>
    [Benchmark]
    [Benchmark("NET8", "Lazy-loaded update metadata")]
    public List<UpdateInfo> LazyLoadMetadata()
    {
        // Simulate lazy load: return summary only
        return _updates
            .Select(u => new UpdateInfo
            {
                KbNumber = u.KbNumber,
                Title = u.Title,
                Classification = u.Classification,
                ApprovalStatus = u.ApprovalStatus
                // Exclude: Description, KbArticleUrl, MaxDownloadSize
            })
            .ToList();
    }

    /// <summary>
    /// Benchmark: Log panel batching (100 lines, 100ms intervals).
    /// Should reduce PropertyChanged notifications by ~90%.
    /// </summary>
    [Benchmark]
    [Benchmark("NET8", "Log panel batching (100 lines)")]
    public void LogPanel_Batching()
    {
        // Simulate batched log updates
        var lines = Enumerable.Range(1, 100)
            .Select(i => $"Log line {i}")
            .ToList();

        // Batch into chunks of 100
        foreach (var batch in lines.Chunk(100))
        {
            // Single PropertyChanged for entire batch
            var aggregated = string.Join(Environment.NewLine, batch);
        }
    }

    /// <summary>
    /// Benchmark: CollectionView filtering (O(n) vs O(n^2)).
    /// Should complete within 10ms for 2000 items.
    /// </summary>
    [Benchmark]
    [Benchmark("NET8", "CollectionView filtering")]
    public List<ComputerInfo> CollectionViewFiltering()
    {
        // Simulate O(n) filtering with CollectionView
        return _computers
            .Where(c => c.Status == "Online")
            .ToList();
    }

    #region Helper Methods

    private static List<ComputerInfo> CreateMockComputers(int count)
    {
        var computers = new List<ComputerInfo>(count);
        for (int i = 0; i < count; i++)
        {
            computers.Add(new ComputerInfo
            {
                Hostname = $"COMPUTER-{i:D4}",
                IpAddress = $"192.168.1.{i % 255 + 1}",
                Status = i % 3 == 0 ? "Online" : (i % 3 == 1 ? "Offline" : "Error"),
                LastSync = DateTime.Now.AddHours(-i % 48),
                PendingUpdates = i % 10,
                OsVersion = "Windows Server 2022"
            });
        }
        return computers;
    }

    private static List<UpdateInfo> CreateMockUpdates(int count)
    {
        var updates = new List<UpdateInfo>(count);
        var classifications = new[] { "Critical", "Security", "Definition", "Updates" };
        var statuses = new[] { "Approved", "Not Approved", "Declined" };

        for (int i = 0; i < count; i++)
        {
            updates.Add(new UpdateInfo
            {
                KbNumber = $"KB{i + 500000}",
                Title = $"Security Update {i + 1}",
                Classification = classifications[i % classifications.Length],
                ApprovalStatus = statuses[i % statuses.Length],
                ApprovalDate = DateTime.Now.AddDays(-i % 30),
                ReleasedDate = DateTime.Now.AddDays(-(i % 30 + 1))
            });
        }
        return updates;
    }

    private void InitializeSettings()
    {
        // Simulate settings initialization
        Thread.Sleep(50);
    }

    private void InitializeThemes()
    {
        // Simulate theme pre-loading (Phase 25 optimization)
        Thread.Sleep(30);
    }

    private void InitializeServices()
    {
        // Simulate service initialization
        Thread.Sleep(20);
    }

    #endregion
}
```

### 2. Run Benchmarks and Capture Baseline

Execute benchmarks to capture v4.5 baseline:

```bash
cd src/WsusManager.Benchmarks
dotnet run -c Release --configuration Release
```

### 3. Document Baseline Results

**File:** `/mnt/c/projects/GA-WsusManager/src/WsusManager.Benchmarks/baselines/v4.5-performance.md`

```markdown
# v4.5 Performance Baselines

**Date:** 2026-02-21
**Version:** 4.5.0
**Framework:** .NET 8.0

## Startup Performance

| Metric | v4.4 Baseline | v4.5 Measured | Improvement |
|--------|---------------|---------------|-------------|
| Cold Startup | 1200ms | TBD | Target: 30% |
| Warm Startup | 400ms | TBD | Target: 20% |

## Dashboard Performance

| Metric | v4.4 Baseline | v4.5 Measured | Improvement |
|--------|---------------|---------------|-------------|
| Refresh (100 computers) | 50ms | TBD | Target: 40% |
| Refresh (1000 computers) | 200ms | TBD | Target: 50% |
| Refresh (2000 computers) | 450ms | TBD | Target: 60% |
| Filtering (2000 items) | 30ms | TBD | Target: <10ms |

## Theme Performance

| Metric | v4.4 Baseline | v4.5 Measured | Improvement |
|--------|---------------|---------------|-------------|
| Theme Switch | 300-500ms | TBD | Target: <100ms |

## Data Loading Performance

| Metric | v4.4 Baseline | v4.5 Measured | Improvement |
|--------|---------------|---------------|-------------|
| Full Metadata Load (1000) | 150ms | TBD | Target: 50% |
| Lazy Load (summary only) | N/A | TBD | Target: <75ms |

## Log Panel Performance

| Metric | v4.4 Baseline | v4.5 Measured | Improvement |
|--------|---------------|---------------|-------------|
| PropertyChanged events (100 lines) | 100 | TBD | Target: 1 (90% reduction) |
| UI thread overhead | High | TBD | Target: Negligible |

## Hardware

- CPU: [Captured from BenchmarkDotNet output]
- RAM: [Captured from BenchmarkDotNet output]
- OS: Windows 11 / Windows Server 2022
```

## Implementation Notes

### Benchmark Execution

1. **Clean build first:**
   ```bash
   dotnet clean src/WsusManager.sln
   dotnet build src/WsusManager.sln --configuration Release
   ```

2. **Run in Release mode:** Debug builds include instrumentation that skews results

3. **Close other applications:** Minimize background processes for consistent measurements

4. **Run 3 iterations:** Take the median value to account for noise

### Interpreting Results

- **Mean:** Average execution time (primary metric)
- **StdDev:** Standard deviation (lower = more consistent)
- **Min/Max:** Outlier detection (helps identify GC pauses)
- **Allocated:** Memory allocated per operation (should be zero for many operations)

### Baseline Comparison

Compare v4.5 results against Phase 22 baseline:
- Open `baselines/startup-baseline.csv` (v4.4 baseline)
- Open `BenchmarkDotNet.Artifacts/results-BenchmarkPhase25Optimizations-report.csv` (v4.5)
- Calculate percentage improvement: `(baseline - measured) / baseline * 100`

### Success Criteria

- [ ] Startup time < 840ms (30% improvement over 1200ms baseline)
- [ ] Theme switch < 100ms
- [ ] Dashboard refresh (2000 computers) < 100ms
- [ ] Lazy load < 75ms for 1000 updates
- [ ] Log panel batching reduces PropertyChanged by 90%

## Testing Notes

### Automated Verification

Add automated comparison test in CI:
```csharp
[Fact]
public void Startup_ShouldBe30PercentFasterThanBaseline()
{
    var baseline = 1200; // v4.4 baseline in ms
    var target = baseline * 0.70; // 30% improvement
    var measured = GetMeasuredStartupTime(); // From benchmark results

    Assert.True(measured < target,
        $"Startup {measured}ms should be < {target}ms (30% improvement over {baseline}ms)");
}
```

### Regression Detection

If v4.5 results are worse than v4.4:
1. Verify Phase 25 optimizations are actually compiled (check Release build)
2. Verify no other changes increased startup time
3. Check for GC pressure or blocking I/O
4. Re-run benchmarks 3 times to confirm regression

## Related Files

- `22-01-PLAN.md` — Original BenchmarkDotNet infrastructure
- `22-CONTEXT.md` — Benchmarking methodology
- `.planning/phases/25-performance-optimization/25-*.PLAN.md` — Optimization implementations

---

_Requirement: PERF-08 (Startup), PERF-09 (Virtualization), PERF-10 (Lazy load), PERF-11 (Log batching), PERF-12 (Theme switch)_
_Phase: 31-testing-documentation_
