name: Build C# WSUS Manager

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/build-csharp.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (e.g., 4.0.1). Leave blank to use Directory.Build.props.'
        required: false
        default: ''
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false

concurrency:
  group: build-csharp-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: |
          dotnet restore src/WsusManager.Core/WsusManager.Core.csproj
          dotnet restore src/WsusManager.App/WsusManager.App.csproj
          dotnet restore src/WsusManager.Tests/WsusManager.Tests.csproj

      - name: Build
        run: |
          dotnet build src/WsusManager.App/WsusManager.App.csproj --configuration Release --no-restore

      - name: Static Analysis Gate (Phase 19)
        run: |
          # Build with warnings-as-errors for critical rules
          dotnet build src/WsusManager.sln --configuration Release --no-incremental --warnaserror | tee build.log
          # Note: Phase 1a uses warnings for CA2007 - will elevate to error in Phase 1b after fixes

      - name: Run tests
        run: |
          dotnet test src/WsusManager.Tests/WsusManager.Tests.csproj `
            --configuration Release `
            --no-build `
            --verbosity normal `
            --logger "trx;LogFileName=test-results.trx" `
            --filter "FullyQualifiedName!~ExeValidation&FullyQualifiedName!~DistributionPackage" `
            --settings src/coverlet.runsettings `
            --collect:"XPlat Code Coverage"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: src/WsusManager.Tests/TestResults/*.trx

      - name: Generate coverage report
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          reportgenerator `
            -reports:./src/WsusManager.Tests/TestResults/**/coverage.cobertura.xml `
            -targetdir:./CoverageReport `
            -reporttypes:HtmlInline

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-coverage-report
          path: ./CoverageReport/

      - name: Publish single-file EXE
        run: |
          dotnet publish src/WsusManager.App/WsusManager.App.csproj `
            --configuration Release `
            --output ./publish `
            --self-contained true `
            --runtime win-x64 `
            -p:PublishSingleFile=true `
            -p:IncludeAllContentForSelfExtract=true

      - name: Validate published EXE
        run: |
          $env:WSUS_EXE_PATH = "${{ github.workspace }}/publish/WsusManager.App.exe"
          dotnet test src/WsusManager.Tests/WsusManager.Tests.csproj `
            --configuration Release `
            --no-build `
            --verbosity normal `
            --filter "FullyQualifiedName~ExeValidation"

      - name: Get version
        id: get-version
        shell: pwsh
        run: |
          $inputVersion = "${{ github.event.inputs.version }}"
          if ($inputVersion) {
            $version = $inputVersion
          } else {
            # Read from Directory.Build.props or App csproj
            $propsFile = "src/Directory.Build.props"
            if (Test-Path $propsFile) {
              [xml]$props = Get-Content $propsFile
              $version = $props.Project.PropertyGroup.Version
            } else {
              [xml]$csproj = Get-Content "src/WsusManager.App/WsusManager.App.csproj"
              $version = ($csproj.Project.PropertyGroup | Where-Object { $_.Version }).Version
            }
          }
          Write-Host "Version: $version"
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Create distribution package
        shell: pwsh
        run: |
          $version = "${{ steps.get-version.outputs.version }}"
          $distDir = "dist-csharp"
          New-Item -ItemType Directory -Path $distDir -Force | Out-Null

          # Copy EXE (rename to WsusManager.exe)
          Copy-Item "publish/WsusManager.App.exe" "$distDir/WsusManager.exe"

          # Copy DomainController folder if it exists
          if (Test-Path "DomainController") {
            Copy-Item -Recurse "DomainController" "$distDir/DomainController"
          }

          # Copy README
          if (Test-Path "README.md") {
            Copy-Item "README.md" "$distDir/README.md"
          }

          # Create zip
          $zipName = "WsusManager-v$version-CSharp.zip"
          Compress-Archive -Path "$distDir/*" -DestinationPath $zipName -Force
          Write-Host "Created: $zipName"

      - name: Validate distribution package
        run: |
          $env:WSUS_DIST_PATH = "${{ github.workspace }}/dist-csharp"
          dotnet test src/WsusManager.Tests/WsusManager.Tests.csproj `
            --configuration Release `
            --no-build `
            --verbosity normal `
            --filter "FullyQualifiedName~DistributionPackage"

      - name: Smoke test EXE
        shell: pwsh
        run: |
          # Start the EXE with a timeout - it will fail gracefully without WSUS
          # but should not crash with unhandled exception
          $exePath = "publish/WsusManager.App.exe"
          if (Test-Path $exePath) {
            Write-Host "Starting smoke test..."
            $proc = Start-Process -FilePath $exePath -PassThru -ErrorAction SilentlyContinue
            if ($proc) {
              Start-Sleep -Seconds 5
              if (-not $proc.HasExited) {
                $proc.Kill()
                Write-Host "Smoke test passed: EXE started without crash (killed after 5s)"
              } else {
                $exitCode = $proc.ExitCode
                Write-Host "Smoke test: EXE exited with code $exitCode"
                # Any exit is acceptable for smoke test (no WSUS on runner)
              }
            } else {
              Write-Host "Smoke test: Could not start process (may require GUI - acceptable on CI)"
            }
          }

      - name: Upload distribution artifact
        uses: actions/upload-artifact@v4
        with:
          name: WsusManager-v${{ steps.get-version.outputs.version }}-CSharp
          path: WsusManager-v${{ steps.get-version.outputs.version }}-CSharp.zip

  benchmark:
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore benchmarks
        run: dotnet restore src/WsusManager.Benchmarks/WsusManager.Benchmarks.csproj

      - name: Build benchmarks
        run: dotnet build src/WsusManager.Benchmarks/WsusManager.Benchmarks.csproj --configuration Release

      - name: Run all benchmarks
        run: dotnet run --project src/WsusManager.Benchmarks/WsusManager.Benchmarks.csproj --configuration Release

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            src/WsusManager.Benchmarks/BenchmarkDotNet.Artifacts/**/*.html
            src/WsusManager.Benchmarks/BenchmarkDotNet.Artifacts/**/*.csv

      - name: Detect regressions
        shell: pwsh
        run: |
          $currentResults = Get-ChildItem "src/WsusManager.Benchmarks/BenchmarkDotNet.Artifacts/*-report.csv" | Select-Object -First 1 -ExpandProperty FullName
          $baselineStartup = "src/WsusManager.Benchmarks/baselines/startup-baseline.csv"
          $baselineDatabase = "src/WsusManager.Benchmarks/baselines/database-baseline.csv"
          $baselineWinrm = "src/WsusManager.Benchmarks/baselines/winrm-baseline.csv"

          # Check if baselines exist
          if (-not (Test-Path $baselineStartup)) {
            Write-Host "WARNING: Startup baseline not found - skipping regression detection"
            exit 0
          }

          # Run regression detection
          & src/WsusManager.Benchmarks/scripts/detect-regression.ps1 `
            -CurrentResultsPath $currentResults `
            -BaselinePath $baselineStartup `
            -ThresholdPercent 10

          # Repeat for database and WinRM baselines
          if (Test-Path $baselineDatabase) {
            & src/WsusManager.Benchmarks/scripts/detect-regression.ps1 `
              -CurrentResultsPath $currentResults `
              -BaselinePath $baselineDatabase `
              -ThresholdPercent 10
          }

          if (Test-Path $baselineWinrm) {
            & src/WsusManager.Benchmarks/scripts/detect-regression.ps1 `
              -CurrentResultsPath $currentResults `
              -BaselinePath $baselineWinrm `
              -ThresholdPercent 10
          }

  release:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event.inputs.create_release == 'true' || startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: WsusManager-v${{ needs.build-and-test.outputs.version }}-CSharp

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build-and-test.outputs.version }}
          name: WSUS Manager v${{ needs.build-and-test.outputs.version }} (C#)
          body: |
            ## WSUS Manager v${{ needs.build-and-test.outputs.version }}

            C# port of GA-WsusManager with single-file self-contained EXE.

            ### Download

            | File | Description |
            |------|-------------|
            | `WsusManager-v${{ needs.build-and-test.outputs.version }}-CSharp.zip` | Complete distribution package |

            ### Requirements
            - Windows Server 2019 or later (64-bit)
            - Administrator privileges
            - WSUS role installed on the server

            ### Installation
            1. Extract the zip to any folder
            2. Run `WsusManager.exe` as Administrator
            3. No .NET runtime installation required (self-contained)
          files: WsusManager-v${{ needs.build-and-test.outputs.version }}-CSharp.zip
          draft: false
          prerelease: false
